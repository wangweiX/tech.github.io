var tape=require("tape"),sendRequest=require("../../lib/send-request.js");if(!("responseURL"in XMLHttpRequest.prototype)){var nativeOpen=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(e,t){return this.responseURL=t,nativeOpen.apply(this,arguments)}}tape("test xhr request",function(e){var t="https://httpbin.org/get";e.test("- request is made, gets a result, and is cache-busted",function(e){var s=sendRequest(t,{cacheBust:!0},function(n){e.equal(s.responseURL.indexOf("?"),t.length,"XHR URL is cache-busted when configured to be");try{n=JSON.parse(n)}catch(t){e.fail("xhr doesn't get a JSON response")}e.same(typeof n,"object","xhr request get a result"),e.end()})}),e.test("- request is not cache-busted when configured not to be",function(e){var s=sendRequest(t,{},function(){e.equal(s.responseURL,t,"XHR URL is left untouched"),e.end()})}),e.end()}),tape("request headers are sent properly",function(e){sendRequest("https://httpbin.org/headers",{selectors:["div.pjax","div.container"]},function(t){var s=JSON.parse(t).headers;e.equals(s["X-Requested-With"],"XMLHttpRequest","X-Requested-With header is set correctly"),e.equals(s["X-Pjax"],"true","X-PJAX header is set correctly"),e.equals(s["X-Pjax-Selectors"],'["div.pjax","div.container"]',"X-PJAX-Selectors header is set correctly"),e.end()})}),tape("HTTP status codes other than 200 are handled properly",function(e){sendRequest("https://httpbin.org/status/400",{},function(t,s){e.equals(t,null,"responseText is null"),e.equals(s.status,400,"HTTP status code is correct"),e.end()})}),tape.skip("XHR error is handled properly",function(e){sendRequest("https://encrypted.google.com/foobar",{},function(t){e.equals(t,null,"responseText is null"),e.end()})}),tape("POST body data is sent properly",function(e){var t=[{name:"test",value:"1"}];sendRequest("https://httpbin.org/post",{requestOptions:{requestMethod:"POST",requestParams:t}},function(s){var n=JSON.parse(s);e.same(n.form[t[0].name],t[0].value,"requestParams were sent properly"),e.equals(n.headers["Content-Type"],"application/x-www-form-urlencoded","Content-Type header was set properly"),e.end()})}),tape("GET query data is sent properly",function(e){var t=[{name:"test",value:"1"}];sendRequest("https://httpbin.org/get",{requestOptions:{requestParams:t}},function(s){var n=JSON.parse(s);e.same(n.args[t[0].name],t[0].value,"requestParams were sent properly"),e.end()})}),tape("XHR timeout is handled properly",function(e){sendRequest("https://httpbin.org/delay/5",{timeout:1e3},function(t){e.equals(t,null,"responseText is null"),e.end()})});