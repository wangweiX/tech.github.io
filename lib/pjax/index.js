var forEachEls=require("./lib/foreach-els"),parseOptions=require("./lib/parse-options"),switches=require("./lib/switches"),newUid=require("./lib/uniqueid"),on=require("./lib/events/on"),trigger=require("./lib/events/trigger"),clone=require("./lib/util/clone"),contains=require("./lib/util/contains"),extend=require("./lib/util/extend"),noop=require("./lib/util/noop"),Pjax=function(t){this.state={numPendingSwitches:0,href:null,options:null},this.options=parseOptions(t),this.log("Pjax options",this.options),this.options.scrollRestoration&&"scrollRestoration"in history&&(history.scrollRestoration="manual"),this.maxUid=this.lastUid=newUid(),this.parseDOM(document),on(window,"popstate",function(t){if(t.state){var e=clone(this.options);e.url=t.state.url,e.title=t.state.title,e.history=!1,e.scrollPos=t.state.scrollPos,t.state.uid<this.lastUid?e.backward=!0:e.forward=!0,this.lastUid=t.state.uid,this.loadUrl(t.state.url,e)}}.bind(this))};if(Pjax.switches=switches,Pjax.prototype={log:require("./lib/proto/log"),getElements:function(t){return t.querySelectorAll(this.options.elements)},parseDOM:function(t){var e=require("./lib/proto/parse-element");forEachEls(this.getElements(t),e,this)},refresh:function(t){this.parseDOM(t||document)},reload:function(){window.location.reload()},attachLink:require("./lib/proto/attach-link"),attachForm:require("./lib/proto/attach-form"),forEachSelectors:function(t,e,o){return require("./lib/foreach-selectors").bind(this)(this.options.selectors,t,e,o)},switchSelectors:function(t,e,o,i){return require("./lib/switches-selectors").bind(this)(this.options.switches,this.options.switchesOptions,t,e,o,i)},latestChance:function(t){window.location=t},onSwitch:function(){trigger(window,"resize scroll"),this.state.numPendingSwitches--,0===this.state.numPendingSwitches&&this.afterAllSwitches()},loadContent:function(t,e){if("string"==typeof t){var o=document.implementation.createHTMLDocument("pjax"),i=t.match(/<html[^>]+>/gi);if(i&&i.length&&(i=i[0].match(/\s?[a-z:]+(?:=['"][^'">]+['"])*/gi)).length&&(i.shift(),i.forEach(function(t){var e=t.trim().split("=");1===e.length?o.documentElement.setAttribute(e[0],!0):o.documentElement.setAttribute(e[0],e[1].slice(1,-1))})),o.documentElement.innerHTML=t,this.log("load content",o.documentElement.attributes,o.documentElement.innerHTML.length),document.activeElement&&contains(document,this.options.selectors,document.activeElement))try{document.activeElement.blur()}catch(t){}this.switchSelectors(this.options.selectors,o,document,e)}else trigger(document,"pjax:complete pjax:error",e)},abortRequest:require("./lib/abort-request"),doRequest:require("./lib/send-request"),handleResponse:require("./lib/proto/handle-response"),loadUrl:function(t,e){e="object"==typeof e?extend({},this.options,e):clone(this.options),this.log("load href",t,e),this.abortRequest(this.request),trigger(document,"pjax:send",e),this.request=this.doRequest(t,e,this.handleResponse.bind(this))},afterAllSwitches:function(){var t=Array.prototype.slice.call(document.querySelectorAll("[autofocus]")).pop();t&&document.activeElement!==t&&t.focus(),this.options.selectors.forEach(function(t){forEachEls(document.querySelectorAll(t),function(t){})});var e=this.state;if(e.options.history&&(window.history.state||(this.lastUid=this.maxUid=newUid(),window.history.replaceState({url:window.location.href,title:document.title,uid:this.maxUid,scrollPos:[0,0]},document.title)),this.lastUid=this.maxUid=newUid(),window.history.pushState({url:e.href,title:e.options.title,uid:this.maxUid,scrollPos:[0,0]},e.options.title,e.href)),this.forEachSelectors(function(t){this.parseDOM(t)},this),trigger(document,"pjax:complete pjax:success",e.options),"function"==typeof e.options.analytics&&e.options.analytics(),e.options.history){var o=document.createElement("a");if(o.href=this.state.href,o.hash){var i=o.hash.slice(1);i=decodeURIComponent(i);var s=0,n=document.getElementById(i)||document.getElementsByName(i)[0];if(n&&n.offsetParent)do{s+=n.offsetTop,n=n.offsetParent}while(n);window.scrollTo(0,s)}else!1!==e.options.scrollTo&&(e.options.scrollTo.length>1?window.scrollTo(e.options.scrollTo[0],e.options.scrollTo[1]):window.scrollTo(0,e.options.scrollTo))}else e.options.scrollRestoration&&e.options.scrollPos&&window.scrollTo(e.options.scrollPos[0],e.options.scrollPos[1]);this.state={numPendingSwitches:0,href:null,options:null}}},Pjax.isSupported=require("./lib/is-supported"),Pjax.isSupported())module.exports=Pjax;else{var stupidPjax=noop;for(var key in Pjax.prototype)Pjax.prototype.hasOwnProperty(key)&&"function"==typeof Pjax.prototype[key]&&(stupidPjax[key]=noop);module.exports=stupidPjax}