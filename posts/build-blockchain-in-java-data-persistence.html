<!DOCTYPE html><html class="theme-next muse use-motion" lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><link rel="stylesheet" media="all" href="https://static.i7years.com/blog/lib/Han/dist/han.min.css?v=3.3"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="https://static.i7years.com/blog/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="https://static.i7years.com/blog/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="https://static.i7years.com/blog/css/main.css?v=5.1.3" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/favicon-180x180.png?v=5.1.3"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png?v=5.1.3"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png?v=5.1.3"><link rel="mask-icon" href="/logo.svg?v=5.1.3" color="#222"><meta name="keywords" content="blockchain,bitcoin,RocksDB,"><meta name="description" content="文章的主要思想和内容均来自：https://jeiwan.cc/posts/building-blockchain-in-go-part-3/引言上一篇 文章我们实现了区块链的工作量证明机制（Pow），尽可能地实现了挖矿。但是距离真正的区块链应用还有很多重要的特性没有实现。今天我们来实现区块链数据的存储机制，将每次生成的区块链数据保存下来。有一点需要注意，区块链本质上是一款分布式的数据库，我们这里"><meta name="keywords" content="blockchain,bitcoin,RocksDB"><meta property="og:type" content="article"><meta property="og:title" content="基于Java语言构建区块链（三）—— 持久化 &amp; 命令行"><meta property="og:url" content="https://wangwei.one/posts/build-blockchain-in-java-data-persistence.html"><meta property="og:site_name" content="终生成长"><meta property="og:description" content="文章的主要思想和内容均来自：https://jeiwan.cc/posts/building-blockchain-in-go-part-3/引言上一篇 文章我们实现了区块链的工作量证明机制（Pow），尽可能地实现了挖矿。但是距离真正的区块链应用还有很多重要的特性没有实现。今天我们来实现区块链数据的存储机制，将每次生成的区块链数据保存下来。有一点需要注意，区块链本质上是一款分布式的数据库，我们这里"><meta property="og:locale" content="en"><meta property="og:image" content="https://img.i7years.com/blog/Millerblockchainadj-3200x2400.webp"><meta property="og:image" content="https://img.i7years.com/blog/blockchain_flow.jpg"><meta property="og:image" content="https://img.i7years.com/blog/blockchain_exploer.png"><meta property="og:updated_time" content="2019-03-29T07:35:29.233Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="基于Java语言构建区块链（三）—— 持久化 &amp; 命令行"><meta name="twitter:description" content="文章的主要思想和内容均来自：https://jeiwan.cc/posts/building-blockchain-in-go-part-3/引言上一篇 文章我们实现了区块链的工作量证明机制（Pow），尽可能地实现了挖矿。但是距离真正的区块链应用还有很多重要的特性没有实现。今天我们来实现区块链数据的存储机制，将每次生成的区块链数据保存下来。有一点需要注意，区块链本质上是一款分布式的数据库，我们这里"><meta name="twitter:image" content="https://img.i7years.com/blog/Millerblockchainadj-3200x2400.webp"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Muse",version:"5.1.3",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"Author"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://wangwei.one/posts/build-blockchain-in-java-data-persistence.html"><title>基于Java语言构建区块链（三）—— 持久化 & 命令行 | 终生成长</title><script>!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject=g,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="https://www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script",0,"ga"),ga("create","UA-112239883-1","auto"),ga("send","pageview")</script><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?7a23039be1256cfe778d1eeb19110f89";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><link rel="stylesheet" href="/lib/canvas-nest/css/particles-style.min.css"></head><body itemscope itemtype="http://schema.org/WebPage" lang="en"><div id="particles-js"></div><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">终生成长</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">每天夜里睡觉时都比那天早晨聪明一点点</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-首页"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-区块链"><a href="/categories/blockchain/" rel="section"><i class="menu-item-icon fa fa-fw fa-btc"></i><br>区块链</a></li><li class="menu-item menu-item-编程"><a href="/categories/coding/" rel="section"><i class="menu-item-icon fa fa-fw fa-terminal"></i><br>编程</a></li><li class="menu-item menu-item-工具"><a href="/categories/tools/" rel="section"><i class="menu-item-icon fa fa-fw fa-gear"></i><br>工具</a></li><li class="menu-item menu-item-阅读"><a href="/books/" rel="section"><i class="menu-item-icon fa fa-fw fa-book"></i><br>阅读</a></li><li class="menu-item menu-item-电影"><a href="/movies/" rel="section"><i class="menu-item-icon fa fa-fw fa-film"></i><br>电影</a></li><li class="menu-item menu-item-分类"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-标签"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-归档"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-关于"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>Search</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://wangwei.one/posts/build-blockchain-in-java-data-persistence.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Michael"><meta itemprop="description" content=""><meta itemprop="image" content="https://img.i7years.com/avatar/naruto.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="终生成长"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">基于Java语言构建区块链（三）—— 持久化 & 命令行</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-02-07T22:43:00+08:00">2018-02-07 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/blockchain/" itemprop="url" rel="index"><span itemprop="name">blockchain</span> </a></span></span><span class="post-comments-count"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-comment-o"></i> </span><a href="/posts/build-blockchain-in-java-data-persistence.html#comments" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="posts/build-blockchain-in-java-data-persistence.html" itemprop="commentCount"></span></a></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">Words count in article&#58;</span> <span title="Words count in article">3,039 </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">Reading time &asymp;</span> <span title="Reading time">14</span></div></div></header><div class="post-body han-init-context" itemprop="articleBody"><script src="/assets/js/APlayer.min.js"></script><p><img src="https://img.i7years.com/blog/Millerblockchainadj-3200x2400.webp" alt="blockchain"></p><blockquote><p>文章的主要思想和内容均来自：<a href="https://jeiwan.cc/posts/building-blockchain-in-go-part-3/" target="_blank" rel="noopener">https://jeiwan.cc/posts/building-blockchain-in-go-part-3/</a></p></blockquote><h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p><a href="https://wangwei.one/posts/7890ab7e.html">上一篇</a> 文章我们实现了区块链的工作量证明机制（Pow），尽可能地实现了挖矿。但是距离真正的区块链应用还有很多重要的特性没有实现。今天我们来实现区块链数据的存储机制，将每次生成的区块链数据保存下来。有一点需要注意，区块链本质上是一款分布式的数据库，我们这里不实现”分布式”，只聚焦于数据存储部分。</p><a id="more"></a><h2 id="数据库选择"><a href="#数据库选择" class="headerlink" title="数据库选择"></a>数据库选择</h2><p>到目前为止，我们的实现机制中还没有区块存储这一环节，导致我们的区块每次生成之后都保存在了内存中。这样不便于我们重新使用区块链，每次都要从头开始生成区块，也不能够跟他人共享我们的区块链，因此，我们需要将其存储在磁盘上。</p><p>我们该选择哪一款数据库呢？事实上，在《<a href="https://github.com/wangweiX/blockchain-explore/tree/master/white-paper/0000-bitcoin" target="_blank" rel="noopener">比特币白皮书</a>》中并没有明确指定使用哪一种的数据库，因此这个由开发人员自己决定。<a href="https://zh.wikipedia.org/wiki/%E4%B8%AD%E6%9C%AC%E8%81%AA" target="_blank" rel="noopener">中本聪</a> 开发的 <a href="https://github.com/bitcoin/bitcoin" target="_blank" rel="noopener">Bitcoin Core</a> 中使用的是<a href="https://github.com/google/leveldb" target="_blank" rel="noopener">LevelDB</a>。原文 <a href="https://jeiwan.cc/posts/building-blockchain-in-go-part-3/" target="_blank" rel="noopener">Building Blockchain in Go. Part 3: Persistence and CLI</a> 中使用的是 <a href="https://github.com/boltdb/bolt" target="_blank" rel="noopener">BoltDB</a> ，对Go语言支持比较好。</p><p>但是我们这里使用的是Java来实现，BoltDB不支持Java，这里我们选用 <a href="https://github.com/facebook/rocksdb" target="_blank" rel="noopener">Rocksdb</a> 。</p><blockquote><p>当然也可以选择 LevelDB，非常不错的LevelDB介绍文章：<a href="https://mp.weixin.qq.com/s/rN6HX2VzsRi3_EKXYKuJAA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/rN6HX2VzsRi3_EKXYKuJAA</a></p><p>RocksDB是由Facebook数据库工程团队开发和维护的一款key-value存储引擎，比LevelDB性能更加强大，有关Rocksdb的详细介绍，请移步至官方文档：<a href="https://github.com/facebook/rocksdb" target="_blank" rel="noopener">https://github.com/facebook/rocksdb</a> ，这里不多做介绍。</p></blockquote><h2 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h2><p>在我们开始实现数据持久化之前，我们先要确定我们该如何去存储我们的数据。为此，我们先来看看比特币是怎么做的。</p><p>简单来讲，比特币使用了两个”buckets(桶)”来存储数据：</p><ul><li><strong>blocks</strong>. 描述链上所有区块的元数据.</li><li><strong>chainstate</strong>. 存储区块链的状态，指的是当前所有的<code>UTXO</code>（未花费交易输出）以及一些元数据.</li></ul><blockquote><p>“在比特币的世界里既没有账户，也没有余额，只有分散到区块链里的UTXO。”</p><p>详见：<a href="https://github.com/bitcoinbook/bitcoinbook/blob/develop/ch06.asciidoc#transaction-outputs-and-inputs" target="_blank" rel="noopener">《精通比特币》第二版 第06章节 —— 交易的输入与输出</a></p></blockquote><p>此外，每个区块数据都是以单独的文件形式存储在磁盘上。这样做是出于性能的考虑：当读取某一个单独的区块数据时，不需要加载所有的区块数据到内存中来。</p><p>在 <code>blocks</code> 这个桶中，存储的键值对：</p><ul><li><p>‘b’ + 32-byte block hash -&gt; block index record</p><blockquote><p>区块的索引记录</p></blockquote></li><li><p>‘f’ + 4-byte file number -&gt; file information record</p><blockquote><p>文件信息记录</p></blockquote></li><li><p>‘l’ -&gt; 4-byte file number: the last block file number used</p><blockquote><p>最新的一个区块所使用的文件编码</p></blockquote></li><li><p>‘R’ -&gt; 1-byte boolean: whether we’re in the process of reindexing</p><blockquote><p>是否处于重建索引的进程当中</p></blockquote></li><li><p>‘F’ + 1-byte flag name length + flag name string -&gt; 1 byte boolean: various flags that can be on or off</p><blockquote><p>各种可以打开或关闭的flag标志</p></blockquote></li><li><p>‘t’ + 32-byte transaction hash -&gt; transaction index record</p><blockquote><p>交易索引记录</p></blockquote></li></ul><p>在 <code>chainstate</code> 这个桶中，存储的键值对：</p><ul><li><p>‘c’ + 32-byte transaction hash -&gt; unspent transaction output record for that transaction</p><blockquote><p>某笔交易的UTXO记录</p></blockquote></li></ul><ul><li><p>‘B’ -&gt; 32-byte block hash: the block hash up to which the database represents the unspent transaction outputs</p><blockquote><p>数据库所表示的UTXO的区块Hash（抱歉，这一点我还没弄明白……）</p></blockquote></li></ul><p>由于我们还没有实现交易相关的特性，因此，我们这里只使用 <code>block</code> 桶。另外，前面提到过的，这里我们不会实现各个区块数据各自存储在独立的文件上，而是统一存放在一个文件里面。因此，我们不要存储和文件编码相关的数据，这样一来，我们所用到的键值对就简化为：</p><ul><li><p>32-byte block-hash -&gt; Block structure (serialized)</p><blockquote><p>区块数据与区块hash的键值对</p></blockquote></li><li><p>‘l’ -&gt; the hash of the last block in a chain</p><blockquote><p>最新一个区块hash的键值对</p></blockquote></li></ul><p>(<a href="https://en.bitcoin.it/wiki/Bitcoin_Core_0.11_(ch_2" target="_blank" rel="noopener">查看更加详细的解释</a>:_Data_Storage))</p><h2 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h2><p>RocksDB的Key与Value只能以byte[]的形式进行存储，这里我们需要用到序列化与反序列化库 <a href="https://github.com/EsotericSoftware/kryo" target="_blank" rel="noopener">Kryo</a>，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> one.wangwei.blockchain.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.esotericsoftware.kryo.Kryo;</span><br><span class="line"><span class="keyword">import</span> com.esotericsoftware.kryo.io.Input;</span><br><span class="line"><span class="keyword">import</span> com.esotericsoftware.kryo.io.Output;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 序列化工具类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wangwei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/02/07</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SerializeUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 反序列化</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bytes 对象对应的字节数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span> </span>&#123;</span><br><span class="line">        Input input = <span class="keyword">new</span> Input(bytes);</span><br><span class="line">        Object obj = <span class="keyword">new</span> Kryo().readClassAndObject(input);</span><br><span class="line">        input.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 序列化</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> object 需要序列化的对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] serialize(Object object) &#123;</span><br><span class="line">        Output output = <span class="keyword">new</span> Output(<span class="number">4096</span>, -<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">new</span> Kryo().writeClassAndObject(output, object);</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = output.toBytes();</span><br><span class="line">        output.close();</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h2><p>上面已经说过，我们这里使用<code>RocksDB</code>，我们先写一个相关的工具类<code>RocksDBUtils</code>，主要的功能如下：</p><ul><li>putLastBlockHash：保存最新一个区块的Hash值</li><li>getLastBlockHash：查询最新一个区块的Hash值</li><li>putBlock：保存区块</li><li>getBlock：查询区块</li></ul><blockquote><p>注意：BoltDB 支持 Bucket 的特性，而RocksDB 不支持，所以需要我们自己使用Map来做一个映射。</p></blockquote><h3 id="RocksDBUtils"><a href="#RocksDBUtils" class="headerlink" title="RocksDBUtils"></a>RocksDBUtils</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> one.wangwei.blockchain.store;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.common.collect.Maps;</span><br><span class="line"><span class="keyword">import</span> one.wangwei.blockchain.block.Block;</span><br><span class="line"><span class="keyword">import</span> one.wangwei.blockchain.util.SerializeUtils;</span><br><span class="line"><span class="keyword">import</span> org.rocksdb.RocksDB;</span><br><span class="line"><span class="keyword">import</span> org.rocksdb.RocksDBException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 存储工具类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wangwei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/02/27</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RocksDBUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 区块链数据文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DB_FILE = <span class="string">"blockchain.db"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 区块桶前缀</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String BLOCKS_BUCKET_KEY = <span class="string">"blocks"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 最新一个区块</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LAST_BLOCK_KEY = <span class="string">"l"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> RocksDBUtils instance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RocksDBUtils <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (RocksDBUtils.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> RocksDBUtils();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RocksDB db;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * block buckets</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, <span class="keyword">byte</span>[]&gt; blocksBucket;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">RocksDBUtils</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        openDB();</span><br><span class="line">        initBlockBucket();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 打开数据库</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">openDB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            db = RocksDB.open(DB_FILE);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RocksDBException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Fail to open db ! "</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化 blocks 数据桶</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initBlockBucket</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] blockBucketKey = SerializeUtils.serialize(BLOCKS_BUCKET_KEY);</span><br><span class="line">            <span class="keyword">byte</span>[] blockBucketBytes = db.get(blockBucketKey);</span><br><span class="line">            <span class="keyword">if</span> (blockBucketBytes != <span class="keyword">null</span>) &#123;</span><br><span class="line">                blocksBucket = (Map) SerializeUtils.deserialize(blockBucketBytes);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                blocksBucket = Maps.newHashMap();</span><br><span class="line">                db.put(blockBucketKey, SerializeUtils.serialize(blocksBucket));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RocksDBException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Fail to init block bucket ! "</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存最新一个区块的Hash值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tipBlockHash</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putLastBlockHash</span><span class="params">(String tipBlockHash)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            blocksBucket.put(LAST_BLOCK_KEY, SerializeUtils.serialize(tipBlockHash));</span><br><span class="line">            db.put(SerializeUtils.serialize(BLOCKS_BUCKET_KEY), SerializeUtils.serialize(blocksBucket));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RocksDBException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Fail to put last block hash ! "</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询最新一个区块的Hash值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getLastBlockHash</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] lastBlockHashBytes = blocksBucket.get(LAST_BLOCK_KEY);</span><br><span class="line">        <span class="keyword">if</span> (lastBlockHashBytes != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> (String) SerializeUtils.deserialize(lastBlockHashBytes);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存区块</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> block</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putBlock</span><span class="params">(Block block)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            blocksBucket.put(block.getHash(), SerializeUtils.serialize(block));</span><br><span class="line">            db.put(SerializeUtils.serialize(BLOCKS_BUCKET_KEY), SerializeUtils.serialize(blocksBucket));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RocksDBException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Fail to put block ! "</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询区块</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> blockHash</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Block <span class="title">getBlock</span><span class="params">(String blockHash)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Block) SerializeUtils.deserialize(blocksBucket.get(blockHash));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关闭数据库</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closeDB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            db.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Fail to close db ! "</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="创建区块链"><a href="#创建区块链" class="headerlink" title="创建区块链"></a>创建区块链</h3><p>现在我们来优化 <code>Blockchain.newBlockchain</code> 接口的代码逻辑，改为如下逻辑：</p><p><img src="https://img.i7years.com/blog/blockchain_flow.jpg" alt=""></p><p>代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * &lt;p&gt; 创建区块链 &lt;/p&gt;</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Blockchain <span class="title">newBlockchain</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    String lastBlockHash = RocksDBUtils.getInstance().getLastBlockHash();</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(lastBlockHash)) &#123;</span><br><span class="line">        Block genesisBlock = Block.newGenesisBlock();</span><br><span class="line">        lastBlockHash = genesisBlock.getHash();</span><br><span class="line">        RocksDBUtils.getInstance().putBlock(genesisBlock);</span><br><span class="line">        RocksDBUtils.getInstance().putLastBlockHash(lastBlockHash);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">new</span> Blockchain(lastBlockHash);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>修改 <code>Blockchain</code> 的数据结构，只记录最新一个区块链的Hash值</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Blockchain</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> String lastBlockHash;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Blockchain</span><span class="params">(String lastBlockHash)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.lastBlockHash = lastBlockHash;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>每次挖矿完成后，我们也需要将最新的区块信息保存下来，并且更新最新区块链Hash值：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; 添加区块  &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> data</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addBlock</span><span class="params">(String data)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">   String lastBlockHash = RocksDBUtils.getInstance().getLastBlockHash();</span><br><span class="line">   <span class="keyword">if</span> (StringUtils.isBlank(lastBlockHash)) &#123;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"Fail to add block into blockchain ! "</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">this</span>.addBlock(Block.newBlock(lastBlockHash, data));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; 添加区块  &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> block</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addBlock</span><span class="params">(Block block)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    RocksDBUtils.getInstance().putLastBlockHash(block.getHash());</span><br><span class="line">    RocksDBUtils.getInstance().putBlock(block);</span><br><span class="line">    <span class="keyword">this</span>.lastBlockHash = block.getHash();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>到此，存储部分的功能就实现完毕，我们还缺少一个功能：</p><h2 id="检索区块链"><a href="#检索区块链" class="headerlink" title="检索区块链"></a>检索区块链</h2><p>现在，我们所有的区块都保存到了数据库，因此，我们能够重新打开已有的区块链并且向其添加新的区块。但这也导致我们再也无法打印出区块链中所有区块的信息，因为，我们没有将区块存储在数组当中。让我们来修复这个瑕疵！</p><p>我们在Blockchain中创建一个内部类 <code>BlockchainIterator</code> ，作为区块链的迭代器，通过区块之前的hash连接来依次迭代输出区块信息，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Blockchain</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    ....</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 区块链迭代器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlockchainIterator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String currentBlockHash;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">BlockchainIterator</span><span class="params">(String currentBlockHash)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.currentBlockHash = currentBlockHash;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 是否有下一个区块</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hashNext</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isBlank(currentBlockHash)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Block lastBlock = RocksDBUtils.getInstance().getBlock(currentBlockHash);</span><br><span class="line">            <span class="keyword">if</span> (lastBlock == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 创世区块直接放行</span></span><br><span class="line">            <span class="keyword">if</span> (lastBlock.getPrevBlockHash().length() == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> RocksDBUtils.getInstance().getBlock(lastBlock.getPrevBlockHash()) != <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 返回区块</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Block <span class="title">next</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            Block currentBlock = RocksDBUtils.getInstance().getBlock(currentBlockHash);</span><br><span class="line">            <span class="keyword">if</span> (currentBlock != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.currentBlockHash = currentBlock.getPrevBlockHash();</span><br><span class="line">                <span class="keyword">return</span> currentBlock;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;   </span><br><span class="line">    </span><br><span class="line">    ....    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wangwei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/02/05</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlockchainTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Blockchain blockchain = Blockchain.newBlockchain();</span><br><span class="line"></span><br><span class="line">            blockchain.addBlock(<span class="string">"Send 1.0 BTC to wangwei"</span>);</span><br><span class="line">            blockchain.addBlock(<span class="string">"Send 2.5 more BTC to wangwei"</span>);</span><br><span class="line">            blockchain.addBlock(<span class="string">"Send 3.5 more BTC to wangwei"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (Blockchain.BlockchainIterator iterator = blockchain.getBlockchainIterator(); iterator.hashNext(); ) &#123;</span><br><span class="line">                Block block = iterator.next();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (block != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">boolean</span> validate = ProofOfWork.newProofOfWork(block).validate();</span><br><span class="line">                    System.out.println(block.toString() + <span class="string">", validate = "</span> + validate);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*输出*/</span></span><br><span class="line"></span><br><span class="line">Block&#123;hash=<span class="string">'0000012f87a0510dd0ee7048a6bd52db3002bae7d661126dc28287bd6c23189a'</span>, prevBlockHash=<span class="string">'0000024b2c23c4fb06c2e2c1349275d415efe17a51db24cd4883da0067300ddf'</span>, data=<span class="string">'Send 3.5 more BTC to wangwei'</span>, timeStamp=<span class="number">1519724875</span>, nonce=<span class="number">369110</span>&#125;, validate = <span class="keyword">true</span></span><br><span class="line">Block&#123;hash=<span class="string">'0000024b2c23c4fb06c2e2c1349275d415efe17a51db24cd4883da0067300ddf'</span>, prevBlockHash=<span class="string">'00000b14fefb51ba2a7428549d469bcf3efae338315e7289d3e6dc4caf589d79'</span>, data=<span class="string">'Send 2.5 more BTC to wangwei'</span>, timeStamp=<span class="number">1519724872</span>, nonce=<span class="number">896348</span>&#125;, validate = <span class="keyword">true</span></span><br><span class="line">Block&#123;hash=<span class="string">'00000b14fefb51ba2a7428549d469bcf3efae338315e7289d3e6dc4caf589d79'</span>, prevBlockHash=<span class="string">'0000099ced1b02f40c750c5468bb8c4fd800ec9f46fea5d8b033e5d054f0f703'</span>, data=<span class="string">'Send 1.0 BTC to wangwei'</span>, timeStamp=<span class="number">1519724869</span>, nonce=<span class="number">673955</span>&#125;, validate = <span class="keyword">true</span></span><br><span class="line">Block&#123;hash=<span class="string">'0000099ced1b02f40c750c5468bb8c4fd800ec9f46fea5d8b033e5d054f0f703'</span>, prevBlockHash=<span class="string">''</span>, data=<span class="string">'Genesis Block'</span>, timeStamp=<span class="number">1519724866</span>, nonce=<span class="number">840247</span>&#125;, validate = <span class="keyword">true</span></span><br></pre></td></tr></table></figure><h2 id="命令行界面"><a href="#命令行界面" class="headerlink" title="命令行界面"></a>命令行界面</h2><p><code>CLI</code> 部分的内容，这里不做详细介绍，具体可以去查看文末的Github源码链接。大致步骤如下：</p><h5 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h5><p>添加pom.xml配置</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></span><br><span class="line">   </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-cli<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-cli<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">	<span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">addClasspath</span>&gt;</span>true<span class="tag">&lt;/<span class="name">addClasspath</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">classpathPrefix</span>&gt;</span>lib/<span class="tag">&lt;/<span class="name">classpathPrefix</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>one.wangwei.blockchain.cli.Main<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="tag">&lt;/<span class="name">descriptorRef</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">id</span>&gt;</span>make-assembly<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">				<span class="comment">&lt;!-- this is used for inheritance merges --&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">				<span class="comment">&lt;!-- 指定在打包节点执行jar包合并操作 --&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">goal</span>&gt;</span>single<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">   </span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>添加shell脚本 <code>blockchain.sh</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line"></span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Check if the jar has been built.</span><br><span class="line">if [ ! -e target/blockchain-java-jar-with-dependencies.jar ]; then</span><br><span class="line">  echo "Compiling blockchain project to a JAR"</span><br><span class="line">  mvn package -DskipTests</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">java -jar target/blockchain-java-jar-with-dependencies.jar "$@"</span><br></pre></td></tr></table></figure><h5 id="执行命令"><a href="#执行命令" class="headerlink" title="执行命令"></a>执行命令</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入工程根路劲</span></span><br><span class="line">$ cd blockchain-java</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印帮助信息</span></span><br><span class="line">$ ./blockchain.sh -h </span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加区块</span></span><br><span class="line">$ ./blockchain.sh -add <span class="string">"Send 1.5 BTC to wangwei"</span></span><br><span class="line">$ ./blockchain.sh -add <span class="string">"Send 2.5 BTC to wangwei"</span></span><br><span class="line">$ ./blockchain.sh -add <span class="string">"Send 3.5 BTC to wangwei"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印区块链</span></span><br><span class="line">$ ./blockchain.sh -print</span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本篇我们实现了区块链的存储功能，接下来我们将实现地址、交易、钱包这一些列的功能。</p><h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><ul><li>源代码：<a href="https://github.com/wangweiX/blockchain-java/tree/part3-persistence" target="_blank" rel="noopener">https://github.com/wangweiX/blockchain-java/tree/part3-persistence</a></li><li><a href="https://jeiwan.cc/posts/building-blockchain-in-go-part-3/" target="_blank" rel="noopener">https://jeiwan.cc/posts/building-blockchain-in-go-part-3/</a></li><li><a href="https://github.com/bitcoinbook/bitcoinbook" target="_blank" rel="noopener">《精通比特币》第二版</a></li></ul><p><img src="https://img.i7years.com/blog/blockchain_exploer.png" alt=""></p><blockquote><p><a href="https://press.one/file/v?s=62076a14b3d0693cf88d19db7e2d6a5a8e05b3de0c77deee242615c5480f8818104c24b65500a8cac096dee3b2e6862cec266916ee6545dd38f3650a459c7b221&amp;h=7732ed4bedb1bb10a4d24df75b719ac2d56ae76a1b5a8f06ccc2ca6dc2d3ce30&amp;a=23fe9bfd7ceef4b44c2ce44dcac8e4a49caf8026&amp;f=P1&amp;v=2" target="_blank" rel="noopener">https://press.one/file/v?s=62076a14b3d0693cf88d19db7e2d6a5a8e05b3de0c77deee242615c5480f8818104c24b65500a8cac096dee3b2e6862cec266916ee6545dd38f3650a459c7b221&amp;h=7732ed4bedb1bb10a4d24df75b719ac2d56ae76a1b5a8f06ccc2ca6dc2d3ce30&amp;a=23fe9bfd7ceef4b44c2ce44dcac8e4a49caf8026&amp;f=P1&amp;v=2</a></p></blockquote></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>请我喝半杯☕️</div><button id="rewardButton" disable="enable" onclick='var qr=document.getElementById("QR");"none"===qr.style.display?qr.style.display="block":qr.style.display="none"'><span>Donate</span></button><div id="QR" style="display:none"><div id="wechat" style="display:inline-block"><img id="wechat_qr" src="https://img.i7years.com/pay2Wechat.png" alt="Michael WeChat Pay"><p>WeChat Pay</p></div><div id="alipay" style="display:inline-block"><img id="alipay_qr" src="https://img.i7years.com/pay2Alipay.png" alt="Michael Alipay"><p>Alipay</p></div><div id="bitcoin" style="display:inline-block"><img id="bitcoin_qr" src="https://img.i7years.com/wallet/rec_bitcoin.png" alt="Michael Bitcoin"><p>Bitcoin</p></div></div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>Post author:</strong> Michael</li><li class="post-copyright-link"><strong>Post link:</strong> <a href="https://wangwei.one/posts/build-blockchain-in-java-data-persistence.html" title="基于Java语言构建区块链（三）—— 持久化 & 命令行">https://wangwei.one/posts/build-blockchain-in-java-data-persistence.html</a></li><li class="post-copyright-license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> unless stating additionally.</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/blockchain/" rel="tag"># blockchain</a> <a href="/tags/bitcoin/" rel="tag"># bitcoin</a> <a href="/tags/RocksDB/" rel="tag"># RocksDB</a></div><div class="post-widgets"><div id="needsharebutton-postbottom"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/posts/build-blockchain-in-java-proof-of-work.html" rel="next" title="基于Java语言构建区块链（二）—— 工作量证明"><i class="fa fa-chevron-left"></i> 基于Java语言构建区块链（二）—— 工作量证明</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/posts/build-blockchain-in-java-transaction-utxo.html" rel="prev" title="基于Java语言构建区块链（四）—— 交易（UTXO）">基于Java语言构建区块链（四）—— 交易（UTXO） <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div><div class="comments" id="comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">Table of Contents</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">Overview</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="https://img.i7years.com/avatar/naruto.jpg" alt="Michael"><p class="site-author-name" itemprop="name">Michael</p><p class="site-description motion-element" itemprop="description">分享自己所思所学所行</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives"><span class="site-state-item-count">75</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">4</span> <span class="site-state-item-name">categories</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">39</span> <span class="site-state-item-name">tags</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/wangweiX" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="https://leetcode.com/wangweix" target="_blank" title="LeetCode"><i class="fa fa-fw fa-laptop-code"></i>LeetCode</a> </span><span class="links-of-author-item"><a href="https://medium.com/@wangwei_hz" target="_blank" title="Medium"><i class="fa fa-fw fa-medium"></i>Medium</a> </span><span class="links-of-author-item"><a href="https://twitter.com/wangwei_hz" target="_blank" title="Twitter"><i class="fa fa-fw fa-twitter"></i>Twitter</a> </span><span class="links-of-author-item"><a href="mailto:dzd5ZWFyc0BnbWFpbC5jb20NCg==" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://halfrost.com/" title="霜" target="_blank">霜</a></li><li class="links-of-blogroll-item"><a href="https://coolshell.cn/" title="酷壳" target="_blank">酷壳</a></li><li class="links-of-blogroll-item"><a href="https://jhuo.ca/" title="霍炬" target="_blank">霍炬</a></li><li class="links-of-blogroll-item"><a href="http://zhangwenli.com" title="羡辙" target="_blank">羡辙</a></li><li class="links-of-blogroll-item"><a href="http://www.ruanyifeng.com/" title="阮一峰" target="_blank">阮一峰</a></li><li class="links-of-blogroll-item"><a href="https://daimajia.com/" title="代码家" target="_blank">代码家</a></li><li class="links-of-blogroll-item"><a href="https://tech.meituan.com/" title="美团点评" target="_blank">美团点评</a></li></ul></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#引言"><span class="nav-number">1.</span> <span class="nav-text">引言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据库选择"><span class="nav-number">2.</span> <span class="nav-text">数据库选择</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据结构"><span class="nav-number">3.</span> <span class="nav-text">数据结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#序列化"><span class="nav-number">4.</span> <span class="nav-text">序列化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#持久化"><span class="nav-number">5.</span> <span class="nav-text">持久化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#RocksDBUtils"><span class="nav-number">5.1.</span> <span class="nav-text">RocksDBUtils</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建区块链"><span class="nav-number">5.2.</span> <span class="nav-text">创建区块链</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#检索区块链"><span class="nav-number">6.</span> <span class="nav-text">检索区块链</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#测试"><span class="nav-number">6.1.</span> <span class="nav-text">测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#命令行界面"><span class="nav-number">7.</span> <span class="nav-text">命令行界面</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#配置"><span class="nav-number">7.0.0.1.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#执行命令"><span class="nav-number">7.0.0.2.</span> <span class="nav-text">执行命令</span></a></li></ol></li></ol><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">8.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#资料"><span class="nav-number">9.</span> <span class="nav-text">资料</span></a></li></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2015 &mdash; <span itemprop="copyrightYear">2019</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">Michael</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i> </span><span class="post-meta-item-text">Site words total count&#58;</span> <span title="Site words total count">158.4k</span></div><div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div><span class="post-meta-divider">|</span><div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script>var _mtac={};!function(){var t=document.createElement("script");t.src="https://pingjs.qq.com/h5/stats.js?v2.0.4",t.setAttribute("name","MTAH5"),t.setAttribute("sid","500547962");var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script><div style="display:none"><script src="//s95.cnzz.com/z_stat.php?id=1270083794&web_id=1270083794" language="JavaScript"></script></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div><div id="needsharebutton-float"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="https://static.i7years.com/blog/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="https://static.i7years.com/blog/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="https://static.i7years.com/blog/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="https://static.i7years.com/blog/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="https://static.i7years.com/blog/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="https://static.i7years.com/blog/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="https://static.i7years.com/blog/lib/canvas-nest/js/particles.min.js"></script><script type="text/javascript" src="https://static.i7years.com/blog/js/src/utils.js?v=5.1.3"></script><script type="text/javascript" src="https://static.i7years.com/blog/js/src/motion.js?v=5.1.3"></script><script type="text/javascript" src="https://static.i7years.com/blog/js/src/scrollspy.js?v=5.1.3"></script><script type="text/javascript" src="https://static.i7years.com/blog/js/src/post-details.js?v=5.1.3"></script><script type="text/javascript" src="https://static.i7years.com/blog/js/src/bootstrap.js?v=5.1.3"></script><script id="dsq-count-scr" src="https://techi7years.disqus.com/count.js" async></script><script type="text/javascript">var disqus_config=function(){this.page.url="https://wangwei.one/posts/build-blockchain-in-java-data-persistence.html",this.page.identifier="posts/build-blockchain-in-java-data-persistence.html",this.page.title="基于Java语言构建区块链（三）—— 持久化 & 命令行"},d=document,s=d.createElement("script");s.src="https://techi7years.disqus.com/embed.js",s.setAttribute("data-timestamp",""+ +new Date),(d.head||d.body).appendChild(s)</script><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script type="text/javascript">var isfetched=!1;var isXml=!0;var search_path="search.xml";if(search_path.length===0){search_path="search.xml"}else if(/json$/i.test(search_path)){isXml=!1}
    var path="/"+search_path;var onPopupClose=function(e){$('.popup').hide();$('#local-search-input').val('');$('.search-result-list').remove();$('#no-result').remove();$(".local-search-pop-overlay").remove();$('body').css('overflow','')}
    function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css('overflow','hidden');$('.search-popup-overlay').click(onPopupClose);$('.popup').toggle();var $localSearchInput=$('#local-search-input');$localSearchInput.attr("autocapitalize","none");$localSearchInput.attr("autocorrect","off");$localSearchInput.focus()}
    var searchFunc=function(path,search_id,content_id){'use strict';$("body").append('<div class="search-popup-overlay local-search-pop-overlay">'+'<div id="search-loading-icon">'+'<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>'+'</div>'+'</div>').css('overflow','hidden');$("#search-loading-icon").css('margin','20% auto 0 auto').css('text-align','center');$.ajax({url:path,dataType:isXml?"xml":"json",async:!0,success:function(res){isfetched=!0;$('.popup').detach().appendTo('.header-inner');var datas=isXml?$("entry",res).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():res;var input=document.getElementById(search_id);var resultContent=document.getElementById(content_id);var inputEventFunction=function(){var searchText=input.value.trim().toLowerCase();var keywords=searchText.split(/[\s\-]+/);if(keywords.length>1){keywords.push(searchText)}
    var resultItems=[];if(searchText.length>0){datas.forEach(function(data){var isMatch=!1;var hitCount=0;var searchTextCount=0;var title=data.title.trim();var titleInLowerCase=title.toLowerCase();var content=data.content.trim().replace(/<[^>]+>/g,"");var contentInLowerCase=content.toLowerCase();var articleUrl=decodeURIComponent(data.url);var indexOfTitle=[];var indexOfContent=[];if(title!=''){keywords.forEach(function(keyword){function getIndexByWord(word,text,caseSensitive){var wordLen=word.length;if(wordLen===0){return[]}
    var startPosition=0,position=[],index=[];if(!caseSensitive){text=text.toLowerCase();word=word.toLowerCase()}
    while((position=text.indexOf(word,startPosition))>-1){index.push({position:position,word:word});startPosition=position+wordLen}
    return index}
    indexOfTitle=indexOfTitle.concat(getIndexByWord(keyword,titleInLowerCase,!1));indexOfContent=indexOfContent.concat(getIndexByWord(keyword,contentInLowerCase,!1))});if(indexOfTitle.length>0||indexOfContent.length>0){isMatch=!0;hitCount=indexOfTitle.length+indexOfContent.length}}
    if(isMatch){[indexOfTitle,indexOfContent].forEach(function(index){index.sort(function(itemLeft,itemRight){if(itemRight.position!==itemLeft.position){return itemRight.position-itemLeft.position}else{return itemLeft.word.length-itemRight.word.length}})});function mergeIntoSlice(text,start,end,index){var item=index[index.length-1];var position=item.position;var word=item.word;var hits=[];var searchTextCountInSlice=0;while(position+word.length<=end&&index.length!=0){if(word===searchText){searchTextCountInSlice++}
    hits.push({position:position,length:word.length});var wordEnd=position+word.length;index.pop();while(index.length!=0){item=index[index.length-1];position=item.position;word=item.word;if(wordEnd>position){index.pop()}else{break}}}
    searchTextCount+=searchTextCountInSlice;return{hits:hits,start:start,end:end,searchTextCount:searchTextCountInSlice}}
    var slicesOfTitle=[];if(indexOfTitle.length!=0){slicesOfTitle.push(mergeIntoSlice(title,0,title.length,indexOfTitle))}
    var slicesOfContent=[];while(indexOfContent.length!=0){var item=indexOfContent[indexOfContent.length-1];var position=item.position;var word=item.word;var start=position-20;var end=position+80;if(start<0){start=0}
    if(end<position+word.length){end=position+word.length}
    if(end>content.length){end=content.length}
    slicesOfContent.push(mergeIntoSlice(content,start,end,indexOfContent))}
    slicesOfContent.sort(function(sliceLeft,sliceRight){if(sliceLeft.searchTextCount!==sliceRight.searchTextCount){return sliceRight.searchTextCount-sliceLeft.searchTextCount}else if(sliceLeft.hits.length!==sliceRight.hits.length){return sliceRight.hits.length-sliceLeft.hits.length}else{return sliceLeft.start-sliceRight.start}});var upperBound=parseInt('1');if(upperBound>=0){slicesOfContent=slicesOfContent.slice(0,upperBound)}
    function highlightKeyword(text,slice){var result='';var prevEnd=slice.start;slice.hits.forEach(function(hit){result+=text.substring(prevEnd,hit.position);var end=hit.position+hit.length;result+='<b class="search-keyword">'+text.substring(hit.position,end)+'</b>';prevEnd=end});result+=text.substring(prevEnd,slice.end);return result}
    var resultItem='';if(slicesOfTitle.length!=0){resultItem+="<li><a href='"+articleUrl+"' class='search-result-title'>"+highlightKeyword(title,slicesOfTitle[0])+"</a>"}else{resultItem+="<li><a href='"+articleUrl+"' class='search-result-title'>"+title+"</a>"}
    slicesOfContent.forEach(function(slice){resultItem+="<a href='"+articleUrl+"'>"+"<p class=\"search-result\">"+highlightKeyword(content,slice)+"...</p>"+"</a>"});resultItem+="</li>";resultItems.push({item:resultItem,searchTextCount:searchTextCount,hitCount:hitCount,id:resultItems.length})}})};if(keywords.length===1&&keywords[0]===""){resultContent.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>'}else if(resultItems.length===0){resultContent.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'}else{resultItems.sort(function(resultLeft,resultRight){if(resultLeft.searchTextCount!==resultRight.searchTextCount){return resultRight.searchTextCount-resultLeft.searchTextCount}else if(resultLeft.hitCount!==resultRight.hitCount){return resultRight.hitCount-resultLeft.hitCount}else{return resultRight.id-resultLeft.id}});var searchResultList='<ul class=\"search-result-list\">';resultItems.forEach(function(result){searchResultList+=result.item})
    searchResultList+="</ul>";resultContent.innerHTML=searchResultList}}
    if('auto'==='auto'){input.addEventListener('input',inputEventFunction)}else{$('.search-icon').click(inputEventFunction);input.addEventListener('keypress',function(event){if(event.keyCode===13){inputEventFunction()}})}
    $(".local-search-pop-overlay").remove();$('body').css('overflow','');proceedsearch()}})}
    $('.popup-trigger').click(function(e){e.stopPropagation();if(isfetched===!1){searchFunc(path,'local-search-input','local-search-result')}else{proceedsearch()}});$('.popup-btn-close').click(onPopupClose);$('.popup').click(function(e){e.stopPropagation()});$(document).on('keyup',function(event){var shouldDismissSearchPopup=event.which===27&&$('.search-popup').is(':visible');if(shouldDismissSearchPopup){onPopupClose()}})</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><link rel="stylesheet" href="https://static.i7years.com/blog/lib/needsharebutton/needsharebutton.min.css?v=1544067396031"><script type="text/javascript" src="https://static.i7years.com/blog/lib/needsharebutton/needsharebutton.min.js?v=1544067396031"></script><script>pbOptions={iconStyle:"default",boxForm:"horizontal",position:"topRight",networks:"Wechat,Weibo,QQZone,Twitter,Facebook,Linkedin,Evernote,Douban,Reddit,Mailto"},new needShareButton("#needsharebutton-postbottom",pbOptions),flOptions={iconStyle:"default",boxForm:"horizontal",position:"middleRight",networks:"Wechat,Weibo,QQZone,Twitter,Facebook,Linkedin,Evernote,Douban,Reddit,Mailto"},new needShareButton("#needsharebutton-float",flOptions)</script></body></html>