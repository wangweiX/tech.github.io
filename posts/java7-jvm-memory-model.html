<!DOCTYPE html><html class="theme-next muse use-motion" lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><link rel="stylesheet" media="all" href="https://static.i7years.com/blog/lib/Han/dist/han.min.css?v=3.3"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="https://static.i7years.com/blog/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="https://static.i7years.com/blog/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="https://static.i7years.com/blog/css/main.css?v=5.1.3" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/favicon-180x180.png?v=5.1.3"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png?v=5.1.3"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png?v=5.1.3"><link rel="mask-icon" href="/logo.svg?v=5.1.3" color="#222"><meta name="keywords" content="JVM,"><meta name="description" content="本文我们来学习一下 Java7 HotSpot(TM) VM 内存模型。"><meta name="keywords" content="JVM"><meta property="og:type" content="article"><meta property="og:title" content="Java7 HotSpot(TM) VM内存模型"><meta property="og:url" content="https://wangwei.one/posts/java7-jvm-memory-model.html"><meta property="og:site_name" content="终生成长"><meta property="og:description" content="本文我们来学习一下 Java7 HotSpot(TM) VM 内存模型。"><meta property="og:locale" content="en"><meta property="og:image" content="https://img.i7years.com/blog/pexels-photo-1532704.jpeg"><meta property="og:image" content="https://img.i7years.com/blog/JVM%20Architecture.png"><meta property="og:image" content="https://img.i7years.com/blog/JVM_Internal_Architecture.png"><meta property="og:image" content="https://img.i7years.com/blog/Runtime%20Date%20Area%20Allocation.png"><meta property="og:image" content="https://img.i7years.com/blog/Java_Heap.png"><meta property="og:updated_time" content="2019-01-11T01:39:18.476Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Java7 HotSpot(TM) VM内存模型"><meta name="twitter:description" content="本文我们来学习一下 Java7 HotSpot(TM) VM 内存模型。"><meta name="twitter:image" content="https://img.i7years.com/blog/pexels-photo-1532704.jpeg"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Muse",version:"5.1.3",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"Author"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://wangwei.one/posts/java7-jvm-memory-model.html"><title>Java7 HotSpot(TM) VM内存模型 | 终生成长</title><script>!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject=g,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="https://www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script",0,"ga"),ga("create","UA-112239883-1","auto"),ga("send","pageview")</script><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?7a23039be1256cfe778d1eeb19110f89";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><link rel="stylesheet" href="/lib/canvas-nest/css/particles-style.min.css"></head><body itemscope itemtype="http://schema.org/WebPage" lang="en"><div id="particles-js"></div><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">终生成长</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">每天夜里睡觉时都比那天早晨聪明一点点</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-首页"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-区块链"><a href="/categories/blockchain/" rel="section"><i class="menu-item-icon fa fa-fw fa-btc"></i><br>区块链</a></li><li class="menu-item menu-item-编程"><a href="/categories/coding/" rel="section"><i class="menu-item-icon fa fa-fw fa-terminal"></i><br>编程</a></li><li class="menu-item menu-item-工具"><a href="/categories/tools/" rel="section"><i class="menu-item-icon fa fa-fw fa-gear"></i><br>工具</a></li><li class="menu-item menu-item-阅读"><a href="/books/" rel="section"><i class="menu-item-icon fa fa-fw fa-book"></i><br>阅读</a></li><li class="menu-item menu-item-电影"><a href="/movies/" rel="section"><i class="menu-item-icon fa fa-fw fa-film"></i><br>电影</a></li><li class="menu-item menu-item-分类"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-标签"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-归档"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-关于"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>Search</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://wangwei.one/posts/java7-jvm-memory-model.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Michael"><meta itemprop="description" content=""><meta itemprop="image" content="https://img.i7years.com/avatar/naruto.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="终生成长"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Java7 HotSpot(TM) VM内存模型</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-08T19:34:32+08:00">2016-06-08 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/coding/" itemprop="url" rel="index"><span itemprop="name">coding</span> </a></span></span><span class="post-comments-count"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-comment-o"></i> </span><a href="/posts/java7-jvm-memory-model.html#comments" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="posts/java7-jvm-memory-model.html" itemprop="commentCount"></span></a></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">Words count in article&#58;</span> <span title="Words count in article">4,071 </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">Reading time &asymp;</span> <span title="Reading time">17</span></div></div></header><div class="post-body han-init-context" itemprop="articleBody"><script src="/assets/js/APlayer.min.js"></script><p><img src="https://img.i7years.com/blog/pexels-photo-1532704.jpeg" alt="pexels-photo-1532704"></p><p>本文我们来学习一下 Java7 HotSpot(TM) VM 内存模型。</p><a id="more"></a><h2 id="JVM-Architecture"><a href="#JVM-Architecture" class="headerlink" title="JVM Architecture"></a>JVM Architecture</h2><p><img src="https://img.i7years.com/blog/JVM%20Architecture.png" alt="JVM Architecture"></p><p>我们先来了解一下JVM的整体架构体系，JVM主要分三大子系统：Class Loader SubSystem、Runtime Data Area、Execution Engine 。</p><h4 id="Class-Loader-SubSystem"><a href="#Class-Loader-SubSystem" class="headerlink" title="Class Loader SubSystem"></a>Class Loader SubSystem</h4><p>Java的动态类加载功能由类加载器子系统处理。 它在<strong>运行时</strong>第一次引用类时加载，链接和初始化类，而不是在编译时引用。 它执行三个主要功能，如加载，链接和初始化。</p><h4 id="Execution-Engine"><a href="#Execution-Engine" class="headerlink" title="Execution Engine"></a>Execution Engine</h4><p>被分配给运行时数据区域中的字节码将被执行引擎来执行。 执行引擎读取字节代码并挨个挨个执行。</p><p>本篇将重点介绍 Rumtime Date Area，至于Class Loader SubSystem和Execution Engine将放在后期的文章中去讲解。</p><h2 id="Runtime-Data-Area"><a href="#Runtime-Data-Area" class="headerlink" title="Runtime Data Area"></a>Runtime Data Area</h2><p>Java虚拟机定义了在程序执行期间使用的各种运行时数据区域。 其中一些数据区域是随着Java虚拟机启动而创建，随着Java虚拟机退出而销毁。其他数据区域则是依附于每个单独的线程，它们随着线程创建而创建，随着线程 的退出而销毁。</p><p>运行时数据区，是JVM内存管理的主要区域。Java虚拟机在程序执行的过程中，会把它所管理的内存划分为若干个不同的数据区域。主要分为：</p><ul><li>Program Counter Register：程序计数器</li><li>Java Virtual Machine Stacks：Java虚拟机栈</li><li>Native Method Stack：本地方法栈</li><li>Java Heap：Java堆</li><li>Method Area：方法区</li></ul><p><img src="https://img.i7years.com/blog/JVM_Internal_Architecture.png" alt="Runtime Data Area"></p><h3 id="控制参数"><a href="#控制参数" class="headerlink" title="控制参数"></a>控制参数</h3><p>每个区域的内存大小可以通过以下参数进行分配</p><p><img src="https://img.i7years.com/blog/Runtime%20Date%20Area%20Allocation.png" alt="Runtime data area allocation"></p><p>控制参数：</p><ul><li><code>-Xms</code> 设置堆的最小空间大小。</li><li><code>-Xmx</code> 设置堆的最大空间大小。</li><li><code>-XX:NewSize</code> 设置新生代最小空间大小。</li><li><code>-XX:MaxNewSize</code> 设置新生代最大空间大小。</li><li><code>-XX:PermSize</code> 设置永久代最小空间大小。</li><li><code>-XX:MaxPermSize</code> 设置永久代最大空间大小。</li><li><code>-Xss</code> 设置每个线程的堆栈大小。</li></ul><h3 id="内存分配查询"><a href="#内存分配查询" class="headerlink" title="内存分配查询"></a>内存分配查询</h3><p>另外，我们可以使用如下命令查询各个操作系统默认分配的内存大小：</p><p><strong>Ubuntu &amp; RedHat</strong>：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ java -XX:+PrintFlagsFinal -version | grep -iE <span class="string">'HeapSize|PermSize|ThreadStackSize'</span></span><br></pre></td></tr></table></figure><p><strong>Windows</strong>：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; java -XX:+PrintFlagsFinal -version | findstr /i <span class="string">"HeapSize PermSize ThreadStackSize"</span></span><br></pre></td></tr></table></figure><p><strong>MacOS</strong>：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ java -XX:+PrintFlagsFinal -version | grep -iE <span class="string">'heapsize|permsize|threadstacksize'</span></span><br></pre></td></tr></table></figure><p>例如，我的Mac返回结果如下：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">    uintx AdaptivePermSizeWeight                    = <span class="number">20</span>              &#123;product&#125;</span><br><span class="line">     intx CompilerThreadStackSize                   = <span class="number">0</span>               &#123;pd product&#125;</span><br><span class="line">    uintx ErgoHeapSizeLimit                         = <span class="number">0</span>               &#123;product&#125;</span><br><span class="line">    uintx HeapSizePerGCThread                       = <span class="number">87241520</span>        &#123;product&#125;</span><br><span class="line">    uintx InitialHeapSize                          := <span class="number">134217728</span>       &#123;product&#125;</span><br><span class="line">    uintx LargePageHeapSizeThreshold                = <span class="number">134217728</span>       &#123;product&#125;</span><br><span class="line">    uintx MaxHeapSize                              := <span class="number">2147483648</span>      &#123;product&#125;</span><br><span class="line">    uintx MaxPermSize                               = <span class="number">85983232</span>        &#123;pd product&#125;</span><br><span class="line">    uintx PermSize                                  = <span class="number">21757952</span>        &#123;pd product&#125;</span><br><span class="line">     intx ThreadStackSize                           = <span class="number">1024</span>            &#123;pd product&#125;</span><br><span class="line">     intx VMThreadStackSize                         = <span class="number">1024</span>            &#123;pd product&#125;</span><br><span class="line">java version <span class="string">"1.7.0_72"</span></span><br><span class="line">Java(TM) SE Runtime Environment (build <span class="number">1.7</span>.<span class="number">0</span>_72-b14)</span><br><span class="line">Java HotSpot(TM) <span class="number">64</span>-Bit Server VM (build <span class="number">24.72</span>-b04, mixed mode)</span><br></pre></td></tr></table></figure><h2 id="Program-Counter-Register"><a href="#Program-Counter-Register" class="headerlink" title="Program Counter Register"></a>Program Counter Register</h2><ul><li>当前线程所执行的字节码的行号解释器。字节码解释器工作时就是通过改变这个计数器的值来选取下一条需要执行的字节码指令，分支、循环、跳转、异常处理、线程恢复等基础功能都需要依赖这个计数器来完成。</li><li>此为线程的私有内存区域。任何一个确定的时刻，一个处理器或者内核，都只会执行一条线程中的指令，为了确保线程切换后还能回到正确的执行位置，每一个线程都有一个独立的程序计数器，各个线程之间计数器互不影响，独立存储。</li><li>此内存区域是唯一一个在Java虚拟机规范中没有规定任何OutOfMemoryError情况的区域。</li></ul><h2 id="Java-Virtual-Machine-Stack"><a href="#Java-Virtual-Machine-Stack" class="headerlink" title="Java Virtual Machine Stack"></a>Java Virtual Machine Stack</h2><h4 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h4><ul><li>线程私有，生命周期与线程的一致。</li><li>虚拟机栈描述的是Java方法执行的内存模型：每个方法在执行的同时都会创建一个<strong>栈帧（Stack Frame）</strong>用于存储<strong>局部变量表</strong>、<strong>操作数栈</strong>、<strong>动态链接</strong>、<strong>方法出口</strong>等信息。每一个方法从调用直至执行完成的过程，就对应着一个栈帧在虚拟机栈中入栈到出栈的过程。</li><li><strong>局部变量表</strong>存放了编译期可知的各种基本数据类型（boolean、byte、char、short、int、float、long、double）、对象引用（reference类型，它不等同于对象本身，可能是一个指向对象起始地址的引用指针，也可能是指向一个代表对象的句柄或其他与此对象相关的位置）和returnAddress类型（指向了一条字节码指令的地址）。</li><li>局部变量表所需的内存空间在<strong>编译期间完成分配</strong>，当进入一个方法时，这个方法需要在帧中分配多大的局部变量空间是完全确定的，在方法运行期间不会改变局部变量表的大小。</li></ul><h4 id="大小设置"><a href="#大小设置" class="headerlink" title="大小设置"></a>大小设置</h4><p>Java虚拟机栈的默认大小与运行的操作系统有关：</p><table><thead><tr><th>Platform</th><th>Default</th></tr></thead><tbody><tr><td>Windows IA32</td><td>64 KB</td></tr><tr><td>Linux IA32</td><td>128 KB</td></tr><tr><td>Windows x86_64</td><td>128 KB</td></tr><tr><td>Linux x86_64</td><td>256 KB</td></tr><tr><td>Windows IA64</td><td>320 KB</td></tr><tr><td>Linux IA64</td><td>1024 KB (1 MB)</td></tr><tr><td>Solaris Sparc</td><td>512 KB</td></tr></tbody></table><p>我们可以通过 <code>-Xss&lt;size&gt;</code> 来设置Java虚拟机栈大小，例如：-Xss128k，则大小为128k。</p><h4 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h4><h5 id="StackOverflowError"><a href="#StackOverflowError" class="headerlink" title="StackOverflowError"></a>StackOverflowError</h5><p>如果线程请求的栈深度大于虚拟机所允许的深度，将抛出StackOverflowError异常。</p><p>如下例子，通过限制虚拟机栈的大小，并产生大量的局部变量，以此来增加此方法帧中的本地变量表长度。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.thinkingjava;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * VM args: -Xss:200k</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaVMStackSOF</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> stackLength = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stackLeak</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        stackLength++;</span><br><span class="line">        stackLeak();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        JavaVMStackSOF oom = <span class="keyword">new</span> JavaVMStackSOF();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            oom.stackLeak();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"stack length:"</span> + oom.stackLength);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 内容输出：</span></span><br><span class="line">Exception in thread <span class="string">"main"</span> java.lang.StackOverflowError</span><br><span class="line">stack length:<span class="number">1239</span></span><br><span class="line">	at com.thinkingjava.JavaVMStackSOF.stackLeak(JavaVMStackSOF.java:<span class="number">11</span>)</span><br><span class="line">	at com.thinkingjava.JavaVMStackSOF.stackLeak(JavaVMStackSOF.java:<span class="number">12</span>)</span><br><span class="line"></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>在单线程的情况下，无论是栈容量太大，还是虚拟机内存太小，当内存无法分配时，都会抛出StackOverflowError异常。</p><h5 id="OutOfMemoryError"><a href="#OutOfMemoryError" class="headerlink" title="OutOfMemoryError"></a>OutOfMemoryError</h5><p>如果虚拟机栈可以动态扩展（当前大部分的Java虚拟机都可动态扩展，只不过Java虚拟机规范中也允许固定长度的虚拟机栈），如果扩展时无法申请到足够的内存，就会抛出OutOfMemoryError异常。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">栈内存大小 = 进程的内存大小 - 堆内存大小(-Xmx) - 方法区内存大小(-XX:MaxPermSize)</span><br></pre></td></tr></table></figure><p>由于操作系统给每一个进程的内存是有限制，除去Java堆内存大小（Xmx）和方法区的内存大小（MaxPermSize），剩余的内容就归Java虚拟机栈和本地方法栈分配了，每个线程可分配的栈容量越大，那么所能够产生的线程数则越少。建立线程越多，则越容易把内存消耗掉。</p><p>如果是建立过多线程导致的内存溢出，在不能减少线程数或者更换64位虚拟机的情况下，就只能通过减少最大堆和减少栈容量来换取更多的线程。</p><p>如下例子：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.thinkingjava;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaVMStackOOM</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            System.out.println(++count);</span><br><span class="line">            <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">10000000</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="number">2032</span></span><br><span class="line">    </span><br><span class="line">Exception in thread <span class="string">"main"</span> java.lang.OutOfMemoryError: unable to create <span class="keyword">new</span> <span class="keyword">native</span> thread</span><br><span class="line">	at java.lang.Thread.start0(Native Method)</span><br><span class="line">	at java.lang.Thread.start(Thread.java:<span class="number">714</span>)</span><br><span class="line">	at com.thinkingjava.JavaVMStackOOM.main(JavaVMStackOOM.java:<span class="number">12</span>)</span><br></pre></td></tr></table></figure><h2 id="Native-Method-Stack"><a href="#Native-Method-Stack" class="headerlink" title="Native Method Stack"></a>Native Method Stack</h2><ul><li>本地方法栈与Java虚拟机栈类似，区别在于 Java虚拟机栈为Java方法服务，而本地方法栈为Native方法服务。</li><li>与虚拟机栈一样，本地方法栈区域也会抛出StackOverflowError和OutOfMemoryError异常。</li></ul><h2 id="Java-Heap"><a href="#Java-Heap" class="headerlink" title="Java Heap"></a>Java Heap</h2><p>Java堆（Java Heap）主要用于所有<strong>对象实例与数组</strong>的分配，是Java虚拟机所管理的内存当中最大的一块。</p><blockquote><p>随着JIT编译器的发展与逃逸分析技术逐渐成熟，栈上分配、标量替换优化技术将会导致一些微妙的变化发生，所有的对象都分配在堆上也渐渐变得不是那么“绝对”了。</p></blockquote><p>Java堆是垃圾收集器管理的主要区域，因此很多时候也被称做“GC堆”（Garbage Collected Heap）。</p><p>Java堆空间可以分为如下几个部分：</p><ul><li><strong>Young Generation</strong>（新生代）：是所有新对象分配和老化的地方<ul><li><strong>Eden Space</strong>（伊甸区）：最初为大多数对象分配内存的地方</li><li><strong>Survivor Space</strong>（幸存者区）：Eden Space进行Minor GC后幸存下来的对象存放的地方</li></ul></li><li><strong>Tenured/Old Generation</strong>（老年代）：Survivor Space进行Major GC后幸存下来的对象存放的地方</li></ul><p><img src="https://img.i7years.com/blog/Java_Heap.png" alt="Java_Heap"></p><h3 id="异常-1"><a href="#异常-1" class="headerlink" title="异常"></a>异常</h3><p>如果在堆中没有内存完成实例分配时，并且堆再也无法扩展时，将会抛出 OOM 异常。</p><blockquote><p>将堆的最小值-Xms参数与最大值-Xmx参数设置为一样即可避免堆自动扩展</p></blockquote><p>如下例子，不断地创造对象，最终导致Java堆内存溢出。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.thinkingjava;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * VM Args：-Xms20m -Xmx20m -XX:+HeapDumpOnOutOfMemoryError</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HeapOOM</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">HeapObject</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        List&lt;HeapObject&gt; heapObjectList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            heapObjectList.add(<span class="keyword">new</span> HeapObject());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 日志输出：</span></span><br><span class="line">java.lang.OutOfMemoryError: Java heap space</span><br><span class="line">Dumping heap to java_pid22301.hprof ...</span><br><span class="line">Heap dump file created [<span class="number">27600189</span> bytes in <span class="number">0.203</span> secs]</span><br><span class="line">Exception in thread <span class="string">"main"</span> java.lang.OutOfMemoryError: Java heap space</span><br><span class="line">	at java.util.Arrays.copyOf(Arrays.java:<span class="number">2245</span>)</span><br><span class="line">	at java.util.Arrays.copyOf(Arrays.java:<span class="number">2219</span>)</span><br><span class="line">	at java.util.ArrayList.grow(ArrayList.java:<span class="number">242</span>)</span><br><span class="line">	at java.util.ArrayList.ensureExplicitCapacity(ArrayList.java:<span class="number">216</span>)</span><br><span class="line">	at java.util.ArrayList.ensureCapacityInternal(ArrayList.java:<span class="number">208</span>)</span><br><span class="line">	at java.util.ArrayList.add(ArrayList.java:<span class="number">440</span>)</span><br><span class="line">	at com.thinkingjava.HeapOOM.main(HeapOOM.java:<span class="number">18</span>)</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">1</span></span><br></pre></td></tr></table></figure><h2 id="Method-Area-Non-Heap"><a href="#Method-Area-Non-Heap" class="headerlink" title="Method Area(Non-Heap)"></a>Method Area(Non-Heap)</h2><p>由于该区域使用的是永久代GC收集方法来实现，所以也称为”永久代”（Permanent Generation），用于存储已被虚拟机加载的<strong>类信息</strong>、<strong>常量</strong>、<strong>静态变量</strong>、<strong>即时编译器编译后的代码</strong>等数据。</p><p>垃圾回收在这个区域较少出现，但这个区域的数据并非永久存在，这个区域的内存回收主要目标是针对常量池的回收和对类型的卸载。</p><h3 id="异常-2"><a href="#异常-2" class="headerlink" title="异常"></a>异常</h3><p>当方法区无法满足内存分配的需求时，将会抛出OutOfMemoryError异常。下面例子，运用cblib动态代理技术，产生大量的类型，导致OOM异常：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> one.wangwei.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> net.sf.cglib.proxy.Enhancer;</span><br><span class="line"><span class="keyword">import</span> net.sf.cglib.proxy.MethodInterceptor;</span><br><span class="line"><span class="keyword">import</span> net.sf.cglib.proxy.MethodProxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaMethodOOM</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OOMObject</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            Enhancer enhancer = <span class="keyword">new</span> Enhancer();</span><br><span class="line">            enhancer.setSuperclass(OOMObject.class);</span><br><span class="line">            enhancer.setUseCache(<span class="keyword">false</span>);</span><br><span class="line">            enhancer.setCallback(<span class="keyword">new</span> MethodInterceptor() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object o, Method method, Object[] objects, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> methodProxy.invoke(o, objects);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            enhancer.create();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 异常输出：</span></span><br><span class="line">Exception in thread <span class="string">"main"</span> </span><br><span class="line">Exception: java.lang.OutOfMemoryError thrown from the UncaughtExceptionHandler in thread <span class="string">"main"</span></span><br></pre></td></tr></table></figure><h2 id="运行时常量池"><a href="#运行时常量池" class="headerlink" title="运行时常量池"></a>运行时常量池</h2><p>运行时常量池（Runtime Constant Pool）是方法区的一部分。Class文件除了有类的版本、字段、方法、接口等描述信息外，还有一项信息是常量池（Constant Pool Table），用于存放编译期生成的各种<strong>字面量</strong>和<strong>符号引用</strong>，这部分内容将在类加载进方法区后进入常量池存放。</p><p>运行时常量池相对于Class文件常量池的另一个重要特征，是具备动态性。Java语言并不要求常量一定只有编译期才能产生，也就是并非预置入Class文件中常量池的内容才能进入方法区运行时常量池，运行期间也可能将新的常量放入池中，这种特性被开发人员利用得比较多的便是String类的intern（）方法。</p><h5 id="字符串常量池"><a href="#字符串常量池" class="headerlink" title="字符串常量池"></a>字符串常量池</h5><p>字符串常量池 在JDK 1.7的HotSpot中已经从运行时常量池转移到Heap中。<a href="http://www.oracle.com/technetwork/java/javase/jdk7-relnotes-418459.html#jdk7changes" target="_blank" rel="noopener">参见</a></p><blockquote><p><strong>Area</strong>: HotSpot</p><p><strong>Synopsis</strong>: In JDK 7, interned strings are no longer allocated in the permanent generation of the Java heap, but <strong>are instead allocated in the main part of the Java heap</strong> (known as the young and old generations), along with the other objects created by the application. This change will result in more data residing in the main Java heap, and less data in the permanent generation, and thus may require heap sizes to be adjusted. Most applications will see only relatively small differences in heap usage due to this change, but larger applications that load many classes or make heavy use of the String.intern() method will see more significant differences. RFE: 6962931</p></blockquote><h3 id="异常-3"><a href="#异常-3" class="headerlink" title="异常"></a>异常</h3><p>既然运行时常量池是方法区的一部分，自然受到方法区内存的限制，当常量池无法再申请到内存时会抛出OutOfMemoryError异常。</p><p>String.intern()是一个Native方法，它的作用是：如果字符串常量池中已经包含一个等于此String对象的字符串，则返回代表池中这个字符串的String对象；否则，将此String对象包含的字符串添加到常量池中，并且返回此String对象的引用。在JDK 1.6及之前的版本中，由于常量池分配在永久代内，我们可以通过-XX:PermSize和-XX:MaxPermSize限制方法区大小，从而间接限制其中常量池的容量。</p><p>例如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> one.wangwei.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * JVM VM: -XX:PermSize=10M -XX:MaxPermSize=10M</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConstantPoolOOM</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; stringList = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            i++;</span><br><span class="line">            stringList.add(String.valueOf(i).intern());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line">Exception in thread <span class="string">"main"</span> java.lang.OutOfMemoryError: PermGen space</span><br><span class="line">	at java.lang.String.intern(Native Method)</span><br><span class="line">	at one.wangwei.java.App.main(App.java:<span class="number">15</span>)</span><br></pre></td></tr></table></figure><h2 id="Direct-Memory"><a href="#Direct-Memory" class="headerlink" title="Direct Memory"></a>Direct Memory</h2><p>直接内存（Direct Memory）并不是虚拟机运行时数据区的一部分，也不是Java虚拟机规范中定义的内存区域。</p><p>在JDK 1.4中新加入了NIO（New Input/Output）类，引入了一种基于通道（Channel）与缓冲区（Buffer）的I/O方式，它可以使用Native函数库直接分配堆外内存，然后通过一个存储在Java堆中的DirectByteBuffer对象作为这块内存的引用进行操作。这样能在一些场景中显著提高性能，因为避免了在Java堆和Native堆中来回复制数据。</p><h3 id="异常-4"><a href="#异常-4" class="headerlink" title="异常"></a>异常</h3><p>本机直接内存的分配不会受到Java堆大小的限制，但是，既然是内存，肯定还是会受到本机总内存（包括RAM以及SWAP区或者分页文件）大小以及处理器寻址空间的限制。服务器管理员在配置虚拟机参数时，会根据实际内存设置-Xmx等参数信息，但经常忽略直接内存，使得各个内存区域总和大于物理内存限制（包括物理的和操作系统级的限制），从而导致动态扩展时出现OutOfMemoryError异常。</p><p>DirectMemory容量可通过 <code>-XX:MaxDirectMemorySize</code> 指定，下面的代码越过了DirectByteBuffer类，直接通过反射获取Unsafe实例进行内存分配（Unsafe类的getUnsafe()方法限制了只有引导类加载器才会返回实例，也就是设计者希望只有rt.jar中的类才能使用Unsafe的功能）。因为，虽然使用DirectByteBuffer分配内存也会抛出内存溢出异常，但它抛出异常时并没有真正向操作系统申请分配内存，而是通过计算得知内存无法分配，于是手动抛出异常，真正申请分配内存的方法是unsafe.allocateMemory()。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> one.wangwei.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sun.misc.Unsafe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * VM Args：-Xmx20M -XX:MaxDirectMemorySize=10M</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DirectMemory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ALLOCATE_MEMORY = <span class="number">10</span> * <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Field unsafeField = Unsafe.class.getDeclaredFields()[<span class="number">0</span>];</span><br><span class="line">            unsafeField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Unsafe unsafe = (Unsafe) unsafeField.get(<span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                unsafe.allocateMemory(ALLOCATE_MEMORY);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出：</span></span><br><span class="line"></span><br><span class="line">java(<span class="number">45961</span>,<span class="number">0x70000a70c000</span>) malloc: *** mach_vm_map(size=<span class="number">10485760</span>) failed (error code=<span class="number">3</span>)</span><br><span class="line">*** error: can<span class="string">'t allocate region</span></span><br><span class="line"><span class="string">*** set a breakpoint in malloc_error_break to debug</span></span><br><span class="line"><span class="string">Exception in thread "main" java.lang.OutOfMemoryError</span></span><br><span class="line"><span class="string">	at sun.misc.Unsafe.allocateMemory(Native Method)</span></span><br><span class="line"><span class="string">	at one.wangwei.java.DirectMemory.main(DirectMemory.java:20)</span></span><br></pre></td></tr></table></figure><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a href="https://book.douban.com/subject/24722612/" target="_blank" rel="noopener">《JVM高级特性与最佳实践[第2版]》第2章节「Java内存区域与内存溢出异常」</a></li><li><a href="https://docs.oracle.com/javase/specs/jvms/se7/html/index.html" target="_blank" rel="noopener">The Java® Virtual Machine Specification Java SE 7 Edition</a></li><li><a href="http://www.javainterviewpoint.com/java-virtual-machine-architecture-in-java/" target="_blank" rel="noopener">http://www.javainterviewpoint.com/java-virtual-machine-architecture-in-java/</a></li><li><a href="http://blog.jamesdbloom.com/JVMInternals.html" target="_blank" rel="noopener">http://blog.jamesdbloom.com/JVMInternals.html</a></li><li><a href="https://www.oracle.com/technetwork/java/javase/tech/vmoptions-jsp-140102.html" target="_blank" rel="noopener">https://www.oracle.com/technetwork/java/javase/tech/vmoptions-jsp-140102.html</a></li></ul><blockquote><p><a href="https://press.one/file/v?s=6f3d70c29a9ccc4fd57898e95ca6b76ff82541dffa7198d4e05a6cf172f09627e9cd2261f63d7a9ccd73e1e829e03ed53363f67b313ae4b340728ad060650dd91&amp;h=4b82cb88322a4072133c5388a10f69a6a10b5b85faf4dcd993b62d4549a94463&amp;a=23fe9bfd7ceef4b44c2ce44dcac8e4a49caf8026&amp;f=P1&amp;v=2" target="_blank" rel="noopener">https://press.one/file/v?s=6f3d70c29a9ccc4fd57898e95ca6b76ff82541dffa7198d4e05a6cf172f09627e9cd2261f63d7a9ccd73e1e829e03ed53363f67b313ae4b340728ad060650dd91&amp;h=4b82cb88322a4072133c5388a10f69a6a10b5b85faf4dcd993b62d4549a94463&amp;a=23fe9bfd7ceef4b44c2ce44dcac8e4a49caf8026&amp;f=P1&amp;v=2</a></p></blockquote></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>请我喝半杯☕️</div><button id="rewardButton" disable="enable" onclick='var qr=document.getElementById("QR");"none"===qr.style.display?qr.style.display="block":qr.style.display="none"'><span>Donate</span></button><div id="QR" style="display:none"><div id="wechat" style="display:inline-block"><img id="wechat_qr" src="https://img.i7years.com/pay2Wechat.png" alt="Michael WeChat Pay"><p>WeChat Pay</p></div><div id="alipay" style="display:inline-block"><img id="alipay_qr" src="https://img.i7years.com/pay2Alipay.png" alt="Michael Alipay"><p>Alipay</p></div><div id="bitcoin" style="display:inline-block"><img id="bitcoin_qr" src="https://img.i7years.com/wallet/rec_bitcoin.png" alt="Michael Bitcoin"><p>Bitcoin</p></div></div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>Post author:</strong> Michael</li><li class="post-copyright-link"><strong>Post link:</strong> <a href="https://wangwei.one/posts/java7-jvm-memory-model.html" title="Java7 HotSpot(TM) VM内存模型">https://wangwei.one/posts/java7-jvm-memory-model.html</a></li><li class="post-copyright-license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> unless stating additionally.</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/JVM/" rel="tag"># JVM</a></div><div class="post-widgets"><div id="needsharebutton-postbottom"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/posts/good-chrome-extensions-list.html" rel="next" title="好用的Chrome Extensions"><i class="fa fa-chevron-left"></i> 好用的Chrome Extensions</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/posts/java8-jvm-metaSpace.html" rel="prev" title="Java8 MetaSpace介绍">Java8 MetaSpace介绍 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div><div class="comments" id="comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">Table of Contents</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">Overview</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="https://img.i7years.com/avatar/naruto.jpg" alt="Michael"><p class="site-author-name" itemprop="name">Michael</p><p class="site-description motion-element" itemprop="description">分享自己所思所学所行</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives"><span class="site-state-item-count">75</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">4</span> <span class="site-state-item-name">categories</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">39</span> <span class="site-state-item-name">tags</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/wangweiX" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="https://leetcode.com/wangweix" target="_blank" title="LeetCode"><i class="fa fa-fw fa-laptop-code"></i>LeetCode</a> </span><span class="links-of-author-item"><a href="https://medium.com/@wangwei_hz" target="_blank" title="Medium"><i class="fa fa-fw fa-medium"></i>Medium</a> </span><span class="links-of-author-item"><a href="https://twitter.com/wangwei_hz" target="_blank" title="Twitter"><i class="fa fa-fw fa-twitter"></i>Twitter</a> </span><span class="links-of-author-item"><a href="http://weibo.com/wangweijava" target="_blank" title="Weibo"><i class="fa fa-fw fa-weibo"></i>Weibo</a> </span><span class="links-of-author-item"><a href="mailto:dzd5ZWFyc0BnbWFpbC5jb20NCg==" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://halfrost.com/" title="霜" target="_blank">霜</a></li><li class="links-of-blogroll-item"><a href="https://coolshell.cn/" title="酷壳" target="_blank">酷壳</a></li><li class="links-of-blogroll-item"><a href="https://jhuo.ca/" title="霍炬" target="_blank">霍炬</a></li><li class="links-of-blogroll-item"><a href="http://zhangwenli.com" title="羡辙" target="_blank">羡辙</a></li><li class="links-of-blogroll-item"><a href="http://www.ruanyifeng.com/" title="阮一峰" target="_blank">阮一峰</a></li><li class="links-of-blogroll-item"><a href="http://jspang.com/" title="技术胖" target="_blank">技术胖</a></li><li class="links-of-blogroll-item"><a href="https://daimajia.com/" title="代码家" target="_blank">代码家</a></li><li class="links-of-blogroll-item"><a href="https://tech.meituan.com/" title="美团点评" target="_blank">美团点评</a></li></ul></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#JVM-Architecture"><span class="nav-number">1.</span> <span class="nav-text">JVM Architecture</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Class-Loader-SubSystem"><span class="nav-number">1.0.1.</span> <span class="nav-text">Class Loader SubSystem</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Execution-Engine"><span class="nav-number">1.0.2.</span> <span class="nav-text">Execution Engine</span></a></li></ol></li></ol><li class="nav-item nav-level-2"><a class="nav-link" href="#Runtime-Data-Area"><span class="nav-number">2.</span> <span class="nav-text">Runtime Data Area</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#控制参数"><span class="nav-number">2.1.</span> <span class="nav-text">控制参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#内存分配查询"><span class="nav-number">2.2.</span> <span class="nav-text">内存分配查询</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Program-Counter-Register"><span class="nav-number">3.</span> <span class="nav-text">Program Counter Register</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Java-Virtual-Machine-Stack"><span class="nav-number">4.</span> <span class="nav-text">Java Virtual Machine Stack</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#概念"><span class="nav-number">4.0.1.</span> <span class="nav-text">概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#大小设置"><span class="nav-number">4.0.2.</span> <span class="nav-text">大小设置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#异常"><span class="nav-number">4.0.3.</span> <span class="nav-text">异常</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#StackOverflowError"><span class="nav-number">4.0.3.1.</span> <span class="nav-text">StackOverflowError</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#OutOfMemoryError"><span class="nav-number">4.0.3.2.</span> <span class="nav-text">OutOfMemoryError</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Native-Method-Stack"><span class="nav-number">5.</span> <span class="nav-text">Native Method Stack</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Java-Heap"><span class="nav-number">6.</span> <span class="nav-text">Java Heap</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#异常-1"><span class="nav-number">6.1.</span> <span class="nav-text">异常</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Method-Area-Non-Heap"><span class="nav-number">7.</span> <span class="nav-text">Method Area(Non-Heap)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#异常-2"><span class="nav-number">7.1.</span> <span class="nav-text">异常</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#运行时常量池"><span class="nav-number">8.</span> <span class="nav-text">运行时常量池</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#字符串常量池"><span class="nav-number">8.0.0.1.</span> <span class="nav-text">字符串常量池</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#异常-3"><span class="nav-number">8.1.</span> <span class="nav-text">异常</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Direct-Memory"><span class="nav-number">9.</span> <span class="nav-text">Direct Memory</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#异常-4"><span class="nav-number">9.1.</span> <span class="nav-text">异常</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考资料"><span class="nav-number">10.</span> <span class="nav-text">参考资料</span></a></li></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2015 &mdash; <span itemprop="copyrightYear">2019</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">Michael</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i> </span><span class="post-meta-item-text">Site words total count&#58;</span> <span title="Site words total count">157.7k</span></div><div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div><span class="post-meta-divider">|</span><div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script>var _mtac={};!function(){var t=document.createElement("script");t.src="https://pingjs.qq.com/h5/stats.js?v2.0.4",t.setAttribute("name","MTAH5"),t.setAttribute("sid","500547962");var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script><div style="display:none"><script src="//s95.cnzz.com/z_stat.php?id=1270083794&web_id=1270083794" language="JavaScript"></script></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div><div id="needsharebutton-float"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="https://static.i7years.com/blog/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="https://static.i7years.com/blog/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="https://static.i7years.com/blog/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="https://static.i7years.com/blog/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="https://static.i7years.com/blog/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="https://static.i7years.com/blog/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="https://static.i7years.com/blog/lib/canvas-nest/js/particles.min.js"></script><script type="text/javascript" src="https://static.i7years.com/blog/js/src/utils.js?v=5.1.3"></script><script type="text/javascript" src="https://static.i7years.com/blog/js/src/motion.js?v=5.1.3"></script><script type="text/javascript" src="https://static.i7years.com/blog/js/src/scrollspy.js?v=5.1.3"></script><script type="text/javascript" src="https://static.i7years.com/blog/js/src/post-details.js?v=5.1.3"></script><script type="text/javascript" src="https://static.i7years.com/blog/js/src/bootstrap.js?v=5.1.3"></script><script id="dsq-count-scr" src="https://techi7years.disqus.com/count.js" async></script><script type="text/javascript">var disqus_config=function(){this.page.url="https://wangwei.one/posts/java7-jvm-memory-model.html",this.page.identifier="posts/java7-jvm-memory-model.html",this.page.title="Java7 HotSpot(TM) VM内存模型"},d=document,s=d.createElement("script");s.src="https://techi7years.disqus.com/embed.js",s.setAttribute("data-timestamp",""+ +new Date),(d.head||d.body).appendChild(s)</script><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script type="text/javascript">var isfetched=!1;var isXml=!0;var search_path="search.xml";if(search_path.length===0){search_path="search.xml"}else if(/json$/i.test(search_path)){isXml=!1}
    var path="/"+search_path;var onPopupClose=function(e){$('.popup').hide();$('#local-search-input').val('');$('.search-result-list').remove();$('#no-result').remove();$(".local-search-pop-overlay").remove();$('body').css('overflow','')}
    function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css('overflow','hidden');$('.search-popup-overlay').click(onPopupClose);$('.popup').toggle();var $localSearchInput=$('#local-search-input');$localSearchInput.attr("autocapitalize","none");$localSearchInput.attr("autocorrect","off");$localSearchInput.focus()}
    var searchFunc=function(path,search_id,content_id){'use strict';$("body").append('<div class="search-popup-overlay local-search-pop-overlay">'+'<div id="search-loading-icon">'+'<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>'+'</div>'+'</div>').css('overflow','hidden');$("#search-loading-icon").css('margin','20% auto 0 auto').css('text-align','center');$.ajax({url:path,dataType:isXml?"xml":"json",async:!0,success:function(res){isfetched=!0;$('.popup').detach().appendTo('.header-inner');var datas=isXml?$("entry",res).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():res;var input=document.getElementById(search_id);var resultContent=document.getElementById(content_id);var inputEventFunction=function(){var searchText=input.value.trim().toLowerCase();var keywords=searchText.split(/[\s\-]+/);if(keywords.length>1){keywords.push(searchText)}
    var resultItems=[];if(searchText.length>0){datas.forEach(function(data){var isMatch=!1;var hitCount=0;var searchTextCount=0;var title=data.title.trim();var titleInLowerCase=title.toLowerCase();var content=data.content.trim().replace(/<[^>]+>/g,"");var contentInLowerCase=content.toLowerCase();var articleUrl=decodeURIComponent(data.url);var indexOfTitle=[];var indexOfContent=[];if(title!=''){keywords.forEach(function(keyword){function getIndexByWord(word,text,caseSensitive){var wordLen=word.length;if(wordLen===0){return[]}
    var startPosition=0,position=[],index=[];if(!caseSensitive){text=text.toLowerCase();word=word.toLowerCase()}
    while((position=text.indexOf(word,startPosition))>-1){index.push({position:position,word:word});startPosition=position+wordLen}
    return index}
    indexOfTitle=indexOfTitle.concat(getIndexByWord(keyword,titleInLowerCase,!1));indexOfContent=indexOfContent.concat(getIndexByWord(keyword,contentInLowerCase,!1))});if(indexOfTitle.length>0||indexOfContent.length>0){isMatch=!0;hitCount=indexOfTitle.length+indexOfContent.length}}
    if(isMatch){[indexOfTitle,indexOfContent].forEach(function(index){index.sort(function(itemLeft,itemRight){if(itemRight.position!==itemLeft.position){return itemRight.position-itemLeft.position}else{return itemLeft.word.length-itemRight.word.length}})});function mergeIntoSlice(text,start,end,index){var item=index[index.length-1];var position=item.position;var word=item.word;var hits=[];var searchTextCountInSlice=0;while(position+word.length<=end&&index.length!=0){if(word===searchText){searchTextCountInSlice++}
    hits.push({position:position,length:word.length});var wordEnd=position+word.length;index.pop();while(index.length!=0){item=index[index.length-1];position=item.position;word=item.word;if(wordEnd>position){index.pop()}else{break}}}
    searchTextCount+=searchTextCountInSlice;return{hits:hits,start:start,end:end,searchTextCount:searchTextCountInSlice}}
    var slicesOfTitle=[];if(indexOfTitle.length!=0){slicesOfTitle.push(mergeIntoSlice(title,0,title.length,indexOfTitle))}
    var slicesOfContent=[];while(indexOfContent.length!=0){var item=indexOfContent[indexOfContent.length-1];var position=item.position;var word=item.word;var start=position-20;var end=position+80;if(start<0){start=0}
    if(end<position+word.length){end=position+word.length}
    if(end>content.length){end=content.length}
    slicesOfContent.push(mergeIntoSlice(content,start,end,indexOfContent))}
    slicesOfContent.sort(function(sliceLeft,sliceRight){if(sliceLeft.searchTextCount!==sliceRight.searchTextCount){return sliceRight.searchTextCount-sliceLeft.searchTextCount}else if(sliceLeft.hits.length!==sliceRight.hits.length){return sliceRight.hits.length-sliceLeft.hits.length}else{return sliceLeft.start-sliceRight.start}});var upperBound=parseInt('1');if(upperBound>=0){slicesOfContent=slicesOfContent.slice(0,upperBound)}
    function highlightKeyword(text,slice){var result='';var prevEnd=slice.start;slice.hits.forEach(function(hit){result+=text.substring(prevEnd,hit.position);var end=hit.position+hit.length;result+='<b class="search-keyword">'+text.substring(hit.position,end)+'</b>';prevEnd=end});result+=text.substring(prevEnd,slice.end);return result}
    var resultItem='';if(slicesOfTitle.length!=0){resultItem+="<li><a href='"+articleUrl+"' class='search-result-title'>"+highlightKeyword(title,slicesOfTitle[0])+"</a>"}else{resultItem+="<li><a href='"+articleUrl+"' class='search-result-title'>"+title+"</a>"}
    slicesOfContent.forEach(function(slice){resultItem+="<a href='"+articleUrl+"'>"+"<p class=\"search-result\">"+highlightKeyword(content,slice)+"...</p>"+"</a>"});resultItem+="</li>";resultItems.push({item:resultItem,searchTextCount:searchTextCount,hitCount:hitCount,id:resultItems.length})}})};if(keywords.length===1&&keywords[0]===""){resultContent.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>'}else if(resultItems.length===0){resultContent.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'}else{resultItems.sort(function(resultLeft,resultRight){if(resultLeft.searchTextCount!==resultRight.searchTextCount){return resultRight.searchTextCount-resultLeft.searchTextCount}else if(resultLeft.hitCount!==resultRight.hitCount){return resultRight.hitCount-resultLeft.hitCount}else{return resultRight.id-resultLeft.id}});var searchResultList='<ul class=\"search-result-list\">';resultItems.forEach(function(result){searchResultList+=result.item})
    searchResultList+="</ul>";resultContent.innerHTML=searchResultList}}
    if('auto'==='auto'){input.addEventListener('input',inputEventFunction)}else{$('.search-icon').click(inputEventFunction);input.addEventListener('keypress',function(event){if(event.keyCode===13){inputEventFunction()}})}
    $(".local-search-pop-overlay").remove();$('body').css('overflow','');proceedsearch()}})}
    $('.popup-trigger').click(function(e){e.stopPropagation();if(isfetched===!1){searchFunc(path,'local-search-input','local-search-result')}else{proceedsearch()}});$('.popup-btn-close').click(onPopupClose);$('.popup').click(function(e){e.stopPropagation()});$(document).on('keyup',function(event){var shouldDismissSearchPopup=event.which===27&&$('.search-popup').is(':visible');if(shouldDismissSearchPopup){onPopupClose()}})</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><link rel="stylesheet" href="https://static.i7years.com/blog/lib/needsharebutton/needsharebutton.min.css?v=1544067396031"><script type="text/javascript" src="https://static.i7years.com/blog/lib/needsharebutton/needsharebutton.min.js?v=1544067396031"></script><script>pbOptions={iconStyle:"default",boxForm:"horizontal",position:"topRight",networks:"Wechat,Weibo,QQZone,Twitter,Facebook,Linkedin,Evernote,Douban,Reddit,Mailto"},new needShareButton("#needsharebutton-postbottom",pbOptions),flOptions={iconStyle:"default",boxForm:"horizontal",position:"middleRight",networks:"Wechat,Weibo,QQZone,Twitter,Facebook,Linkedin,Evernote,Douban,Reddit,Mailto"},new needShareButton("#needsharebutton-float",flOptions)</script></body></html>