<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 4.2.0"><link rel="apple-touch-icon" sizes="180x180" href="/favicon-180x180.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="mask-icon" href="/logo.svg" color="#222"><link rel="stylesheet" href="https://static.i7years.com/blog/css/main.css?v=1544067396035"><link rel="stylesheet" href="https://static.i7years.com/blog/lib/font-awesome/css/font-awesome.min.css?v=1544067396035"><link rel="stylesheet" href="https://static.i7years.com/blog/lib/pace/pace-theme-minimal.min.css?v=1544067396035"><script src="https://static.i7years.com/blog/lib/pace/pace.min.js?v=1544067396035"></script><link rel="stylesheet" href="https://static.i7years.com/blog/lib/canvas-nest/css/particles-style.min.css?v=1544067396035"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:new URL("https://wangwei.one").hostname,root:"/",scheme:"Muse",version:"7.7.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!0},copycode:{enable:!0,show_result:!0,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!0,lazyload:!0,pangu:!0,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},path:"search.xml",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="前面 我们学习了Java7的内存模型，重点了解了它的Runtime Data Area，今天我们要来学习一下Java8 HotSpot(TM) VM内存模型，看看它与Java7 VM存在哪些差异。"><meta property="og:type" content="article"><meta property="og:title" content="Java8 MetaSpace介绍"><meta property="og:url" content="https://wangwei.one/posts/java8-jvm-metaSpace.html"><meta property="og:site_name" content="维新工坊"><meta property="og:description" content="前面 我们学习了Java7的内存模型，重点了解了它的Runtime Data Area，今天我们要来学习一下Java8 HotSpot(TM) VM内存模型，看看它与Java7 VM存在哪些差异。"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://img.i7years.com/blog/amirkabir_dam-wallpaper-1920x1200.jpg?imageslim"><meta property="og:image" content="https://img.i7years.com/blog/JVisualVM_1.png"><meta property="og:image" content="https://img.i7years.com/blog/gc_1.png"><meta property="og:image" content="https://img.i7years.com/blog/JVisualVM_2.png"><meta property="og:image" content="https://img.i7years.com/blog/gc_2.png"><meta property="og:image" content="https://img.i7years.com/blog/JVisualVM_3.png"><meta property="og:image" content="https://img.i7years.com/blog/gc_3.png"><meta property="article:published_time" content="2016-06-11T04:23:19.000Z"><meta property="article:modified_time" content="2020-01-02T13:16:04.163Z"><meta property="article:author" content="Wang Wei"><meta property="article:tag" content="JVM"><meta property="article:tag" content="Java8"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://img.i7years.com/blog/amirkabir_dam-wallpaper-1920x1200.jpg?imageslim"><link rel="canonical" href="https://wangwei.one/posts/java8-jvm-metaSpace.html"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>Java8 MetaSpace介绍 | 维新工坊</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-112239883-1"></script><script pjax>if(CONFIG.hostname===location.hostname){function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-112239883-1")}</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="维新工坊" type="application/atom+xml">
</head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div id="particles-js"></div><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">维新工坊</span> <span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">每天夜里睡觉时都比那天早晨聪明一点点</h1></div><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-首页"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a></li><li class="menu-item menu-item-区块链"><a href="/categories/blockchain/" rel="section"><i class="fa fa-fw fa-btc"></i>区块链</a></li><li class="menu-item menu-item-编程"><a href="/categories/coding/" rel="section"><i class="fa fa-fw fa-terminal"></i>编程</a></li><li class="menu-item menu-item-工具"><a href="/categories/tools/" rel="section"><i class="fa fa-fw fa-gear"></i>工具</a></li><li class="menu-item menu-item-阅读"><a href="/books/" rel="section"><i class="fa fa-fw fa-book"></i>阅读</a></li><li class="menu-item menu-item-电影"><a href="/movies/" rel="section"><i class="fa fa-fw fa-film"></i>电影</a></li><li class="menu-item menu-item-分类"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a></li><li class="menu-item menu-item-标签"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a></li><li class="menu-item menu-item-归档"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a></li><li class="menu-item menu-item-关于"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Searching..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en"><link itemprop="mainEntityOfPage" href="https://wangwei.one/posts/java8-jvm-metaSpace.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://img.i7years.com/avatar/naruto.jpg?imageslim"><meta itemprop="name" content="Wang Wei"><meta itemprop="description" content="分享自己所思所学所行"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="维新工坊"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">Java8 MetaSpace介绍</h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2016-06-11 12:23:19" itemprop="dateCreated datePublished" datetime="2016-06-11T12:23:19+08:00">2016-06-11</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/coding/" itemprop="url" rel="index"><span itemprop="name">coding</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><p align="center"><a target="_blank" href="https://wangwei.one/posts/java8-jvm-metaSpace.html"><img data-src="https://img.i7years.com/blog/amirkabir_dam-wallpaper-1920x1200.jpg?imageslim"></a></p><p><a href="https://wangwei.one/posts/71c1df10.html">前面</a> 我们学习了Java7的内存模型，重点了解了它的Runtime Data Area，今天我们要来学习一下Java8 HotSpot(TM) VM内存模型，看看它与Java7 VM存在哪些差异。</p><a id="more"></a><p>与Java7相比较，Java8 VM的一个重大更新：<strong>完全移除永久代（PermGen），取而代之的为元空间（Metaspace）</strong>。</p><p>![Java8 VM MetaSpace](<a href="https://img.i7years.com/blog/Java8" target="_blank" rel="noopener">https://img.i7years.com/blog/Java8</a> VM MetaSpace.png)</p><h2 id="为什么要移除PermGen"><a href="#为什么要移除PermGen" class="headerlink" title="为什么要移除PermGen"></a>为什么要移除PermGen</h2><blockquote><p>来源：<a href="http://openjdk.java.net/jeps/122" target="_blank" rel="noopener">http://openjdk.java.net/jeps/122</a></p></blockquote><p>Jon Masamitsu 对此的解释如下：</p><blockquote><p>A goal for removing perm gen was so that users do not have to think about correctly sizing it.</p><p>Set MetaspaceSize to a value larger than the default, if you know that your applications needs more space for class data. Setting it to a larger size will avoid some number of GC’s at startup. It is not necessary and I do not particularly recommend it unless you want to avoid as many GC’s as possible.</p><p>Set MaxMetaspaceSize if you want to limit the space for class data. You might want to do this if you suspect you are leaking classloaders and want the application to stop before it uses up too much native memory. Another case might be where you have multiple applications running on a server and you want to limit how much space each uses for class data.</p></blockquote><p>PermGen空间的大小在JVM启动时就已经分配好了，但是随着动态类加载的情况越来越多，如果设置的太小，则容易出现OOM的异常，设置的太大，则容易造成空间浪费。</p><p>而Metaspace空间的容量则会根据应用程序在运行时的需求动态调整大小，省得为PermGen的大小分配操碎了心。</p><h2 id="有哪些变化"><a href="#有哪些变化" class="headerlink" title="有哪些变化"></a>有哪些变化</h2><blockquote><p>来源：<a href="http://mail.openjdk.java.net/pipermail/hotspot-dev/2012-September/006679.html" target="_blank" rel="noopener">http://mail.openjdk.java.net/pipermail/hotspot-dev/2012-September/006679.html</a></p></blockquote><h5 id="PermGen-情况"><a href="#PermGen-情况" class="headerlink" title="PermGen 情况"></a>PermGen 情况</h5><ul><li>PermGen 被完全移除，对应的控制参数 <code>PermSize</code> 和 <code>MaxPermSize</code> 也变得无效。</li></ul><h5 id="Metaspace内存分配模型"><a href="#Metaspace内存分配模型" class="headerlink" title="Metaspace内存分配模型"></a>Metaspace内存分配模型</h5><ul><li><p>类的元数据信息（metadata）不再是存储在连续的堆空间上，而是移动到叫做“Metaspace”的本地内存（Native memory）中。PermGen中剩下的一些杂项数据已移至Java Heap中。</p></li><li><p>用于描述类元数据的类(klasses)已被删除（klassKlass及其派生类）。</p></li></ul><h5 id="Metaspace空间容量"><a href="#Metaspace空间容量" class="headerlink" title="Metaspace空间容量"></a>Metaspace空间容量</h5><ul><li>默认情况下，类元数据分配受到可用的本机内存总容量的限制（容量依然取决于你使用32位JVM还是64位操作系统的虚拟内存的可用性）。</li><li>可以使用一个新的参数 (<code>MaxMetaspaceSize</code>)来限制用于类元数据的本地内存。如果没有特别指定，元空间将会根据应用程序在运行时的需求动态调整大小。</li></ul><h5 id="Metaspace垃圾回收"><a href="#Metaspace垃圾回收" class="headerlink" title="Metaspace垃圾回收"></a>Metaspace垃圾回收</h5><ul><li>当class metadata的使用的内存达到<code>MetaspaceSize</code>(32位clientVM默认12Mbytes，32位ServerVM默认是16Mbytes)时就会对死亡的类加载器和类进行垃圾收集。 设置<code>MetaspaceSize</code>为一个较高的值可以推迟垃圾收集的发生。</li><li>为了限制垃圾回收的频率和延迟，适当的监控和调优元空间是非常有必要的。元空间过多的垃圾收集可能表示类加载器内存泄漏或对你的应用程序来说空间太小了。</li></ul><h5 id="Java-Heap影响"><a href="#Java-Heap影响" class="headerlink" title="Java Heap影响"></a>Java Heap影响</h5><ul><li>一些杂乱的数据从PermGen移到了Java Heap，这意味着升级到JDK8之后，Java Heap的大小会有明显的增加。</li></ul><h2 id="Metaspace的组成"><a href="#Metaspace的组成" class="headerlink" title="Metaspace的组成"></a>Metaspace的组成</h2><blockquote><p>来源：<a href="http://lovestblog.cn/blog/2016/10/29/metaspace/" target="_blank" rel="noopener">http://lovestblog.cn/blog/2016/10/29/metaspace/</a></p></blockquote><h3 id="组成"><a href="#组成" class="headerlink" title="组成"></a>组成</h3><ul><li>Klass Metaspace</li><li>NoKlass Metaspace</li></ul><h3 id="组成说明"><a href="#组成说明" class="headerlink" title="组成说明"></a>组成说明</h3><ul><li>Klass Metaspace就是用来存klass的，klass是我们熟知的class文件在jvm里的运行时数据结构，不过有点要提的是我们看到的类似A.class其实是存在heap里的，是java.lang.Class的一个对象实例。这块内存是紧接着Heap的，和我们之前的perm一样，这块内存大小可通过 <code>-XX:CompressedClassSpaceSize</code> 参数来控制，这个参数默认是1G，但是这块内存也可以没有，假如没有开启压缩指针就不会有这块内存，这种情况下klass都会存在NoKlass Metaspace里，另外如果我们把-Xmx设置大于32G的话，其实也是没有这块内存的，因为会这么大内存会关闭压缩指针开关。还有就是这块内存最多只会存在一块。</li><li>NoKlass Metaspace专门来存klass相关的其他的内容，比如method，constantPool等，这块内存是由多块内存组合起来的，所以可以认为是不连续的内存块组成的。这块内存是必须的，虽然叫做NoKlass Metaspace，但是也其实可以存klass的内容，上面已经提到了对应场景。</li><li>Klass Metaspace和NoKlass Mestaspace都是所有classloader共享的，所以类加载器要分配内存，但是每个类加载器都有一个SpaceManager，来管理属于这个类加载的内存小块。如果Klass Metaspace用完了，那就会OOM了，不过一般情况下不会，NoKlass Mestaspace是由一块块内存慢慢组合起来的，在没有达到限制条件的情况下，会不断加长这条链，让它可以持续工作。</li></ul><h2 id="Metaspace的几个参数"><a href="#Metaspace的几个参数" class="headerlink" title="Metaspace的几个参数"></a>Metaspace的几个参数</h2><p>如果我们要改变metaspace的一些行为，我们一般会对其相关的一些参数做调整，因为metaspace的参数本身不是很多，所以我这里将涉及到的所有参数都做一个介绍，也许好些参数大家都是有误解的</p><ul><li>UseLargePagesInMetaspace</li><li>InitialBootClassLoaderMetaspaceSize</li><li>MetaspaceSize</li><li>MaxMetaspaceSize</li><li>CompressedClassSpaceSize</li><li>MinMetaspaceExpansion</li><li>MaxMetaspaceExpansion</li><li>MinMetaspaceFreeRatio</li><li>MaxMetaspaceFreeRatio</li></ul><p><strong>UseLargePagesInMetaspace</strong></p><p>默认false，这个参数是说是否在metaspace里使用LargePage，一般情况下我们使用4KB的page size，这个参数依赖于UseLargePages这个参数开启，不过这个参数我们一般不开。</p><p><strong>InitialBootClassLoaderMetaspaceSize</strong></p><p>64位下默认4M，32位下默认2200K，metasapce前面已经提到主要分了两大块，Klass Metaspace以及NoKlass Metaspace，而 NoKlass Metaspace 是由一块块内存组合起来的，这个参数决定了NoKlass Metaspace的第一个内存Block的大小，即<code>2 * InitialBootClassLoaderMetaspaceSize</code>，同时为bootstrapClassLoader的第一块内存chunk分配了<code>InitialBootClassLoaderMetaspaceSize</code>的大小</p><p><strong>MetaspaceSize</strong></p><p>默认20.8M左右(x86下开启c2模式)，主要是控制metaspaceGC发生的初始阈值，也是最小阈值，但是触发metaspaceGC的阈值是不断变化的，与之对比的主要是指Klass Metaspace与NoKlass Metaspace两块committed的内存和。</p><p><strong>MaxMetaspaceSize</strong></p><p>默认基本是无穷大，但是我还是建议大家设置这个参数，因为很可能会因为没有限制而导致metaspace被无止境使用(一般是内存泄漏)而被OS Kill。这个参数会限制metaspace(包括了Klass Metaspace以及NoKlass Metaspace)被committed的内存大小，会保证committed的内存不会超过这个值，一旦超过就会触发GC，这里要注意和MaxPermSize的区别，MaxMetaspaceSize并不会在jvm启动的时候分配一块这么大的内存出来，而MaxPermSize是会分配一块这么大的内存的。</p><p><strong>CompressedClassSpaceSize</strong></p><p>默认1G，这个参数主要是设置Klass Metaspace的大小，不过这个参数设置了也不一定起作用，前提是能开启压缩指针，假如-Xmx超过了32G，压缩指针是开启不来的。如果有Klass Metaspace，那这块内存是和Heap连着的。</p><p><strong>MinMetaspaceExpansion</strong></p><p>MinMetaspaceExpansion和MaxMetaspaceExpansion这两个参数或许和大家认识的并不一样，也许很多人会认为这两个参数不就是内存不够的时候，然后扩容的最小大小吗？其实不然</p><p>这两个参数和扩容其实并没有直接的关系，也就是并不是为了增大committed的内存，而是为了增大触发metaspace GC的阈值</p><p>这两个参数主要是在比较特殊的场景下救急使用，比如gcLocker或者<code>should_concurrent_collect</code>的一些场景，因为这些场景下接下来会做一次GC，相信在接下来的GC中可能会释放一些metaspace的内存，于是先临时扩大下metaspace触发GC的阈值，而有些内存分配失败其实正好是因为这个阈值触顶导致的，于是可以通过增大阈值暂时绕过去</p><p>默认332.8K，增大触发metaspace GC阈值的最小要求。假如我们要救急分配的内存很小，没有达到MinMetaspaceExpansion，但是我们会将这次触发metaspace GC的阈值提升MinMetaspaceExpansion，之所以要大于这次要分配的内存大小主要是为了防止别的线程也有类似的请求而频繁触发相关的操作，不过如果要分配的内存超过了MaxMetaspaceExpansion，那MinMetaspaceExpansion将会是要分配的内存大小基础上的一个增量</p><p><strong>MaxMetaspaceExpansion</strong></p><p>默认5.2M，增大触发metaspace GC阈值的最大要求。假如说我们要分配的内存超过了MinMetaspaceExpansion但是低于MaxMetaspaceExpansion，那增量是MaxMetaspaceExpansion，如果超过了MaxMetaspaceExpansion，那增量是MinMetaspaceExpansion加上要分配的内存大小</p><p>注：每次分配只会给对应的线程一次扩展触发metaspace GC阈值的机会，如果扩展了，但是还不能分配，那就只能等着做GC了</p><p><strong>MinMetaspaceFreeRatio</strong></p><p>MinMetaspaceFreeRatio和下面的MaxMetaspaceFreeRatio，主要是影响触发metaspaceGC的阈值</p><p>默认40，表示每次GC完之后，假设我们允许接下来metaspace可以继续被commit的内存占到了被commit之后总共committed的内存量的MinMetaspaceFreeRatio%，如果这个总共被committed的量比当前触发metaspaceGC的阈值要大，那么将尝试做扩容，也就是增大触发metaspaceGC的阈值，不过这个增量至少是MinMetaspaceExpansion才会做，不然不会增加这个阈值</p><p>这个参数主要是为了避免触发metaspaceGC的阈值和gc之后committed的内存的量比较接近，于是将这个阈值进行扩大</p><p>一般情况下在gc完之后，如果被committed的量还是比较大的时候，换个说法就是离触发metaspaceGC的阈值比较接近的时候，这个调整会比较明显</p><p>注：这里不用gc之后used的量来算，主要是担心可能出现committed的量超过了触发metaspaceGC的阈值，这种情况一旦发生会很危险，会不断做gc，这应该是jdk8在某个版本之后才修复的bug</p><p><strong>MaxMetaspaceFreeRatio</strong></p><p>默认70，这个参数和上面的参数基本是相反的，是为了避免触发metaspaceGC的阈值过大，而想对这个值进行缩小。这个参数在gc之后committed的内存比较小的时候并且离触发metaspaceGC的阈值比较远的时候，调整会比较明显</p><h2 id="MetaSpace-与-PermGen-运行时比较"><a href="#MetaSpace-与-PermGen-运行时比较" class="headerlink" title="MetaSpace 与 PermGen 运行时比较"></a>MetaSpace 与 PermGen 运行时比较</h2><p>前面提到过，MetaSpace与PermGen最主要的区别就在于，内存空间的是否能够自动扩容上，下面我们来分别演示一下MetaSpace与PermGen的GC的表现形式之间的区别。示例代码 <a href="https://attach.i7years.com/code/Java8_Metaspace.zip" target="_blank" rel="noopener">下载</a></p><h4 id="JDK-1-7-64-bit-–-PermGen-depletion"><a href="#JDK-1-7-64-bit-–-PermGen-depletion" class="headerlink" title="JDK 1.7 @64-bit – PermGen depletion"></a>JDK 1.7 @64-bit – PermGen depletion</h4><blockquote><p>演示异常：ERROR: java.lang.OutOfMemoryError: PermGen space</p></blockquote><p>VM 参数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-verbose:gc -Xms1024M -Xmx1024M -XX:MaxPermSize=<span class="number">128</span>m -XX:PermSize=<span class="number">128</span>m -XX:+PrintGCDetails -Xloggc:gc.log</span><br></pre></td></tr></table></figure><p>JVisualVM监控显示：</p><p><img data-src="https://img.i7years.com/blog/JVisualVM_1.png" alt="Java8_MetaSpace_1"></p><p>GC日志：</p><p><img data-src="https://img.i7years.com/blog/gc_1.png" alt="gc_1"></p><h4 id="JDK-1-8-64-bit-–-Metaspace-dynamic-re-size"><a href="#JDK-1-8-64-bit-–-Metaspace-dynamic-re-size" class="headerlink" title="JDK 1.8 @64-bit – Metaspace dynamic re-size"></a>JDK 1.8 @64-bit – Metaspace dynamic re-size</h4><blockquote><p>演示 metaspace 空间不断动态调整的过程</p></blockquote><p>VM 参数</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-verbose:gc -Xms1024M -Xmx1024M -XX:+PrintGCDetails -Xloggc:gc.log</span><br></pre></td></tr></table></figure><p>JVisualVM监控显示：</p><p><img data-src="https://img.i7years.com/blog/JVisualVM_2.png" alt="JVisualVM_2"></p><p>GC日志：</p><p><img data-src="https://img.i7years.com/blog/gc_2.png" alt="gc_2"></p><h4 id="JDK-1-8-64-bit-–-Metaspace-depletion"><a href="#JDK-1-8-64-bit-–-Metaspace-depletion" class="headerlink" title="JDK 1.8 @64-bit – Metaspace depletion"></a>JDK 1.8 @64-bit – Metaspace depletion</h4><blockquote><p>演示异常：ERROR: java.lang.OutOfMemoryError: Metadata space</p></blockquote><p>VM 参数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-verbose:gc -Xms1024M -Xmx1024M -XX:MaxMetaspaceSize=<span class="number">128</span>m -XX:+PrintGCDetails -Xloggc:gc.log</span><br></pre></td></tr></table></figure><p>JVisualVM监控显示：</p><p><img data-src="https://img.i7years.com/blog/JVisualVM_3.png" alt="JVisualVM_3"></p><p>GC日志：</p><p><img data-src="https://img.i7years.com/blog/gc_3.png" alt="gc_3"></p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><p><a href="http://openjdk.java.net/jeps/122" target="_blank" rel="noopener">http://openjdk.java.net/jeps/122</a></p></li><li><p><a href="https://www.infoq.com/news/2013/03/java-8-permgen-metaspace" target="_blank" rel="noopener">https://www.infoq.com/news/2013/03/java-8-permgen-metaspace</a></p></li><li><p><a href="http://javaeesupportpatterns.blogspot.com/2013/02/java-8-from-permgen-to-metaspace.html" target="_blank" rel="noopener">http://javaeesupportpatterns.blogspot.com/2013/02/java-8-from-permgen-to-metaspace.html</a></p></li><li><p><a href="https://dzone.com/articles/java-8-permgen-metaspace" target="_blank" rel="noopener">https://dzone.com/articles/java-8-permgen-metaspace</a></p></li><li><p><a href="http://www.infoq.com/cn/articles/Java-PERMGEN-Removed" target="_blank" rel="noopener">http://www.infoq.com/cn/articles/Java-PERMGEN-Removed</a></p></li><li><p><a href="http://java-latte.blogspot.com/2014/03/metaspace-in-java-8.html" target="_blank" rel="noopener">http://java-latte.blogspot.com/2014/03/metaspace-in-java-8.html</a></p></li><li><p><a href="http://m.www.cnblogs.com/duanxz/p/3520829.html" target="_blank" rel="noopener">http://m.www.cnblogs.com/duanxz/p/3520829.html</a></p></li><li><p><a href="https://stackoverflow.com/questions/27131165/what-is-the-difference-between-permgen-and-metaspace" target="_blank" rel="noopener">https://stackoverflow.com/questions/27131165/what-is-the-difference-between-permgen-and-metaspace</a></p></li><li><p><a href="http://lovestblog.cn/blog/2016/10/29/metaspace/" target="_blank" rel="noopener">http://lovestblog.cn/blog/2016/10/29/metaspace/</a></p></li><li><p><a href="https://juejin.im/entry/5b74fcbf6fb9a0097f0c2a95" target="_blank" rel="noopener">https://juejin.im/entry/5b74fcbf6fb9a0097f0c2a95</a></p></li><li><p><a href="https://dzone.com/articles/understanding-the-java-memory-model-and-the-garbag" target="_blank" rel="noopener">https://dzone.com/articles/understanding-the-java-memory-model-and-the-garbag</a></p></li><li><p><a href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html" target="_blank" rel="noopener">https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html</a></p></li><li><p><a href="http://www.importnew.com/14933.html" target="_blank" rel="noopener">http://www.importnew.com/14933.html</a></p></li></ul></div><div class="reward-container"><div>请我喝半杯☕️</div><button disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">Donate</button><div id="qr" style="display:none"><div style="display:inline-block"><img src="https://img.i7years.com/pay2Wechat.png" alt="Wang Wei WeChat Pay"><p>WeChat Pay</p></div><div style="display:inline-block"><img src="https://img.i7years.com/pay2Alipay.png" alt="Wang Wei Alipay"><p>Alipay</p></div><div style="display:inline-block"><img src="https://img.i7years.com/wallet/rec_bitcoin.png" alt="Wang Wei Bitcoin"><p>Bitcoin</p></div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>Post author: </strong>Wang Wei</li><li class="post-copyright-link"><strong>Post link: </strong><a href="https://wangwei.one/posts/java8-jvm-metaSpace.html" title="Java8 MetaSpace介绍">https://wangwei.one/posts/java8-jvm-metaSpace.html</a></li><li class="post-copyright-license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/JVM/" rel="tag"># JVM</a> <a href="/tags/Java8/" rel="tag"># Java8</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/java7-jvm-memory-model.html" rel="prev" title="Java7 HotSpot(TM) VM内存模型"><i class="fa fa-chevron-left"></i> Java7 HotSpot(TM) VM内存模型</a></div><div class="post-nav-item"><a href="/posts/jvm-gc-base-concept.html" rel="next" title="GC基本概念">GC基本概念 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><div class="comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript></div></div><script>window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">Table of Contents</li><li class="sidebar-nav-overview">Overview</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#为什么要移除PermGen"><span class="nav-number">1.</span> <span class="nav-text">为什么要移除PermGen</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#有哪些变化"><span class="nav-number">2.</span> <span class="nav-text">有哪些变化</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#PermGen-情况"><span class="nav-number">2.0.0.1.</span> <span class="nav-text">PermGen 情况</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Metaspace内存分配模型"><span class="nav-number">2.0.0.2.</span> <span class="nav-text">Metaspace内存分配模型</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Metaspace空间容量"><span class="nav-number">2.0.0.3.</span> <span class="nav-text">Metaspace空间容量</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Metaspace垃圾回收"><span class="nav-number">2.0.0.4.</span> <span class="nav-text">Metaspace垃圾回收</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Java-Heap影响"><span class="nav-number">2.0.0.5.</span> <span class="nav-text">Java Heap影响</span></a></li></ol></li></ol><li class="nav-item nav-level-2"><a class="nav-link" href="#Metaspace的组成"><span class="nav-number">3.</span> <span class="nav-text">Metaspace的组成</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#组成"><span class="nav-number">3.1.</span> <span class="nav-text">组成</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#组成说明"><span class="nav-number">3.2.</span> <span class="nav-text">组成说明</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Metaspace的几个参数"><span class="nav-number">4.</span> <span class="nav-text">Metaspace的几个参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MetaSpace-与-PermGen-运行时比较"><span class="nav-number">5.</span> <span class="nav-text">MetaSpace 与 PermGen 运行时比较</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#JDK-1-7-64-bit-–-PermGen-depletion"><span class="nav-number">5.0.1.</span> <span class="nav-text">JDK 1.7 @64-bit – PermGen depletion</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#JDK-1-8-64-bit-–-Metaspace-dynamic-re-size"><span class="nav-number">5.0.2.</span> <span class="nav-text">JDK 1.8 @64-bit – Metaspace dynamic re-size</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#JDK-1-8-64-bit-–-Metaspace-depletion"><span class="nav-number">5.0.3.</span> <span class="nav-text">JDK 1.8 @64-bit – Metaspace depletion</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考资料"><span class="nav-number">6.</span> <span class="nav-text">参考资料</span></a></li></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="Wang Wei" src="https://img.i7years.com/avatar/naruto.jpg?imageslim"><p class="site-author-name" itemprop="name">Wang Wei</p><div class="site-description" itemprop="description">分享自己所思所学所行</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives"><span class="site-state-item-count">73</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">4</span> <span class="site-state-item-name">categories</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">37</span> <span class="site-state-item-name">tags</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/wangweiX" title="GitHub → https://github.com/wangweiX" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="https://leetcode.com/wangweix" title="LeetCode → https://leetcode.com/wangweix" rel="noopener" target="_blank"><i class="fa fa-fw fa-laptop-code"></i>LeetCode</a> </span><span class="links-of-author-item"><a href="mailto:dzd5ZWFyc0BnbWFpbC5jb20NCg==" title="E-Mail → mailto:dzd5ZWFyc0BnbWFpbC5jb20NCg==" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div><div class="links-of-blogroll motion-element"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://halfrost.com/" title="https://halfrost.com/" rel="noopener" target="_blank">霜</a></li><li class="links-of-blogroll-item"><a href="https://coolshell.cn/" title="https://coolshell.cn/" rel="noopener" target="_blank">酷壳</a></li><li class="links-of-blogroll-item"><a href="https://jhuo.ca/" title="https://jhuo.ca/" rel="noopener" target="_blank">霍炬</a></li><li class="links-of-blogroll-item"><a href="http://zhangwenli.com" title="http://zhangwenli.com" rel="noopener" target="_blank">羡辙</a></li><li class="links-of-blogroll-item"><a href="http://www.ruanyifeng.com/" title="http://www.ruanyifeng.com/" rel="noopener" target="_blank">阮一峰</a></li><li class="links-of-blogroll-item"><a href="https://daimajia.com/" title="https://daimajia.com/" rel="noopener" target="_blank">代码家</a></li><li class="links-of-blogroll-item"><a href="https://tech.meituan.com/" title="https://tech.meituan.com/" rel="noopener" target="_blank">美团点评</a></li></ul></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; 2015 – <span itemprop="copyrightYear">2020</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">Wang Wei</span></div><div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.2.0</div><span class="post-meta-divider">|</span><div class="theme-info">Theme – <a href="https://muse.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.7.0</div><div class="busuanzi-count"><script pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><div style="display:none"><script pjax src="//s95.cnzz.com/z_stat.php?id=1270083794&web_id=1270083794"></script></div></div></footer></div><script src="https://static.i7years.com/blog/lib/canvas-nest/js/particles.min.js?v=1544067396035"></script><script src="https://static.i7years.com/blog/lib/anime.min.js?v=1544067396035"></script><script src="https://static.i7years.com/blog/lib/pjax/pjax.min.js?v=1544067396035"></script><script src="//cdn.jsdelivr.net/npm/medium-zoom@1/dist/medium-zoom.min.js?v=1544067396035"></script><script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js?v=1544067396035"></script><script src="//cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js?v=1544067396035"></script><script src="https://static.i7years.com/blog/lib/velocity/velocity.min.js?v=1544067396035"></script><script src="https://static.i7years.com/blog/lib/velocity/velocity.ui.min.js?v=1544067396035"></script><script src="https://static.i7years.com/blog/js/utils.js"></script><script src="https://static.i7years.com/blog/js/motion.js"></script><script src="https://static.i7years.com/blog/js/schemes/muse.js"></script><script src="https://static.i7years.com/blog/js/next-boot.js"></script><script>var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.getAttribute('pjax') !== null) {
      element.setAttribute('pjax', '');
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});</script><script pjax>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="https://static.i7years.com/blog/js/local-search.js"></script><div id="pjax"><script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script><script>window.addEventListener('load', () => {
      quicklink({
        timeout: 3000,
        priority: true,
        ignores: [uri => uri.includes('#'),uri => uri == 'https://wangwei.one/posts/java8-jvm-metaSpace.html',]
      });
      });</script><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/disqusjs@1/dist/disqusjs.css"><script>NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/disqusjs@1/dist/disqus.js', () => {
    window.dsqjs = new DisqusJS({
      api: '' || 'https://disqus.com/api/',
      apikey: 'Fbg1QT6GJQYjK5jgJotfR5tznyJ6z9i6sfzhumYxWwOLo4IiepF29KpLsW296beS',
      shortname: 'wangweiblog',
      url: "https://wangwei.one/posts/java8-jvm-metaSpace.html",
      identifier: "posts/java8-jvm-metaSpace.html",
      title: "Java8 MetaSpace介绍",
    });
  }, window.DisqusJS);
});</script></div></body></html>