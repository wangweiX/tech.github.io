<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>基于 Java 语言构建区块链（四）—— 交易（UTXO） | 维新工坊</title><meta name="keywords" content="blockchain,bitcoin,UTXO"><meta name="author" content="Wang Wei"><meta name="copyright" content="Wang Wei"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="文章的主要思想和内容均来自 https:&#x2F;&#x2F;jeiwan.cc&#x2F;posts&#x2F;building-blockchain-in-go-part-4&#x2F;  引言上一篇 文章，我们实现了区块数据的持久化，本篇开始交易环节的实现。交易这一环节是整个比特币系统当中最为关键的一环，并且区块链唯一的目的就是通过安全的、可信的方式来存储交易信息，防止它们创建之后被人恶意篡改。今天我们开始实现交易这一环节，但由">
<meta property="og:type" content="article">
<meta property="og:title" content="基于 Java 语言构建区块链（四）—— 交易（UTXO）">
<meta property="og:url" content="https://wangwei.one/posts/build-blockchain-in-java-transaction-utxo.html">
<meta property="og:site_name" content="维新工坊">
<meta property="og:description" content="文章的主要思想和内容均来自 https:&#x2F;&#x2F;jeiwan.cc&#x2F;posts&#x2F;building-blockchain-in-go-part-4&#x2F;  引言上一篇 文章，我们实现了区块数据的持久化，本篇开始交易环节的实现。交易这一环节是整个比特币系统当中最为关键的一环，并且区块链唯一的目的就是通过安全的、可信的方式来存储交易信息，防止它们创建之后被人恶意篡改。今天我们开始实现交易这一环节，但由">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
<meta property="article:published_time" content="2018-02-28T14:43:00.000Z">
<meta property="article:modified_time" content="2020-01-02T14:01:06.799Z">
<meta property="article:author" content="Wang Wei">
<meta property="article:tag" content="blockchain">
<meta property="article:tag" content="bitcoin">
<meta property="article:tag" content="UTXO">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><link rel="shortcut icon" href="/images/favicon-180x180.png"><link rel="canonical" href="https://wangwei.one/posts/build-blockchain-in-java-transaction-utxo"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//s4.cnzz.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-112239883-1"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-112239883-1');
</script><script async="async" data-pjax="data-pjax" src="https://s4.cnzz.com/z_stat.php?id=1270083794&amp;web_id=1270083794"></script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '基于 Java 语言构建区块链（四）—— 交易（UTXO）',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2020-01-02 22:01:06'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/lib/css/particles-style.min.css"><meta name="generator" content="Hexo 6.0.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">74</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">39</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">4</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 目录</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-th"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 阅读</span></a></div><div class="menus_item"><a class="site-page" href="/movies/"><i class="fa-fw fas fa-film"></i><span> 电影</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-user"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">维新工坊</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 目录</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-th"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 阅读</span></a></div><div class="menus_item"><a class="site-page" href="/movies/"><i class="fa-fw fas fa-film"></i><span> 电影</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-user"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">基于 Java 语言构建区块链（四）—— 交易（UTXO）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">Created</span><time datetime="2018-02-28T14:43:00.000Z" title="Created 2018-02-28 22:43:00">2018-02-28</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/blockchain/">blockchain</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">6.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>22min</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="基于 Java 语言构建区块链（四）—— 交易（UTXO）"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p align="center">
<a target="_blank" href="https://wangwei.one/posts/build-blockchain-in-java-transaction-utxo.html"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.i7years.com/blog/ecommerce-2140604.jpg?imageslim"></a>
</p>

<blockquote>
<p>文章的主要思想和内容均来自 <a target="_blank" rel="noopener" href="https://jeiwan.cc/posts/building-blockchain-in-go-part-4/">https://jeiwan.cc/posts/building-blockchain-in-go-part-4/</a></p>
</blockquote>
<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p><a href="https://wangwei.one/posts/35c768a3.html">上一篇</a> 文章，我们实现了区块数据的持久化，本篇开始交易环节的实现。交易这一环节是整个比特币系统当中最为关键的一环，并且区块链唯一的目的就是通过安全的、可信的方式来存储交易信息，防止它们创建之后被人恶意篡改。今天我们开始实现交易这一环节，但由于这是一个很大的话题，所以我们分为两部分：第一部分我们将实现区块链交易的基本机制，到第二部分，我们再来研究它的细节。</p>
<span id="more"></span>


<h2 id="比特币交易"><a href="#比特币交易" class="headerlink" title="比特币交易"></a>比特币交易</h2><p>如果你开发过 Web 应用程序，为了实现支付系统，你可能会在数据库中创建一些数据库表：<code>账户</code> 和 <code>交易记录</code>。账户用于存储用户的个人信息以及账户余额等信息，交易记录用于存储资金从一个账户转移到另一个账户的记录。但是在比特币中，支付系统是以一种完全不一样的方式实现的，在这里：</p>
<ul>
<li>没有账户</li>
<li>没有余额</li>
<li>没有地址</li>
<li>没有 Coins（币）</li>
<li>没有发送者和接受者</li>
</ul>
<p>由于区块链是一个公开的数据库，我们不希望存储有关钱包所有者的敏感信息。<code>Coins</code> 不会汇总到钱包中。交易不会将资金从一个地址转移到另一个地址。没有可保存帐户余额的字段或属性。只有交易信息。那比特币的交易信息里面到底存储的是什么呢？</p>
<h3 id="交易组成"><a href="#交易组成" class="headerlink" title="交易组成"></a>交易组成</h3><p>一笔比特币的交易由 <code>交易输入</code> 和 <code>交易输出</code> 组成，数据结构如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 交易</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wangwei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/03/04</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Transaction</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 交易的Hash</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span>[] txId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 交易输入</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> TXInput[] inputs;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 交易输出</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> TXOutput[] outputs;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>一笔交易的 <code>交易输入</code> 其实是指向上一笔交易的<code>交易输出</code> （这个后面详细说明）。我们钱包里面的 Coin（币）实际是存储在这些 <code>交易输出</code> 里面。下图表示了区块链交易系统里面各个交易相互引用的关系：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.i7years.com/blog/transactions-diagram.png" alt="transactions-diagram"></p>
<p>注意：</p>
<ol>
<li>有些 <code>交易输出</code> 并不是由 <code>交易输入</code> 产生，而是凭空产生的（后面会详细介绍）。</li>
<li>但，<code>交易输入</code> 必须指向某个 <code>交易输出</code>，它不能凭空产生。</li>
<li>在一笔交易里面，<code>交易输入</code> 可能会来自多笔交易所产生的 <code>交易输出</code>。</li>
</ol>
<p>在整篇文章中，我们将使用诸如 “钱”，“币”，“花费”，“发送”，“账户” 等词语。但比特币中没有这样的概念，在比特币交易中，交易信息是由 <code>锁定脚本</code> 锁定一个数值，并且只能被所有者的 <code>解锁脚本</code> 解锁。（解铃还须系铃人）</p>
<h2 id="交易输出"><a href="#交易输出" class="headerlink" title="交易输出"></a>交易输出</h2><p>让我们先从交易输出开始，他的数据结构如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 交易输出</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wangwei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/03/04</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TXOutput</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> value;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 锁定脚本</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String scriptPubKey;</span><br><span class="line">	</span><br><span class="line">    </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>实际上，它表示的是能够存储 “coins（币）” 的交易输出（注意 <strong>value</strong> 字段）。并且这里所谓的 <strong>value</strong> 实际上是由存储在  <strong>ScriptPubKey</strong> （锁定脚本）中的一个 puzzle（难题） 所锁定。在内部，比特币使用称为脚本的脚本语言，用于定义输出锁定和解锁逻辑。这个语言很原始（这是故意的，以避免可能的黑客和滥用），但我们不会详细讨论它。 你可以在这里找到它的详细解释。<a target="_blank" rel="noopener" href="https://en.bitcoin.it/wiki/Script">here</a></p>
<blockquote>
<p>在比特币中，<em>value</em> 字段存储着 <em>satoshis</em> 的任意倍的数值，而不是 BTC 的数量。<em>satoshis</em> 是比特币的百万分之一（0.00000001 BTC），因此这是比特币中最小的货币单位（如 1 美分）。</p>
<blockquote>
<p><em>satoshis</em>：聪</p>
</blockquote>
<p>锁定脚本是一个放在一个输出值上的 “障碍”，同时它明确了今后花费这笔输出的条件。由于锁定脚本往往含有一个公钥（即比特币地址），在历史上它曾被称作一个脚本公钥代码。在大多数比特币应用源代码中，脚本公钥代码便是我们所说的锁定脚本。 </p>
</blockquote>
<p>由于我们还没有实现钱包地址的逻辑，所以这里先暂且忽略锁定脚本相关的逻辑。<strong>ScriptPubKey</strong> 将会存储任意的字符串（用户定义的钱包地址）</p>
<blockquote>
<p>顺便说一句，拥有这样的脚本语言意味着比特币也可以用作智能合约平台。</p>
</blockquote>
<p>关于 <code>交易输出</code> 的一个重要的事情是它们是<strong>不可分割的</strong>，这意味着你不能将它所存储的数值拆开来使用。当这个交易输出在新的交易中被交易输入所引用时，它将作为一个整体被花费掉。 如果其值大于所需值，那么剩余的部分则会作为零钱返回给付款方。 这与真实世界的情况类似，例如，您支付 5 美元的钞票用于购买 1 美元的东西，那么你将会得到 4 美元的零钱。</p>
<h2 id="交易输入"><a href="#交易输入" class="headerlink" title="交易输入"></a>交易输入</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 交易输入</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wangwei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/03/04</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TXInput</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 交易Id的hash值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span>[] txId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 交易输出索引</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> txOutputIndex;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解锁脚本</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String scriptSig;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>前面提到过，一个交易输入指向的是某一笔交易的交易输出：</p>
<ul>
<li><strong>txId</strong> 存储的是某笔交易的 ID 值</li>
<li><strong> txOutputIndex</strong> 存储的是交易中这个交易输出的索引位置（因为一笔交易可能包含多个交易输出）</li>
<li><strong>scriptSig</strong> 主要是提供用于交易输出中 <strong>ScriptPubKey</strong> 所需的验证数据。<ul>
<li>如果这个数据被验证正确，那么相应的交易输出将被解锁，并且其中的 value 能够生成新的交易输出；</li>
<li>如果不正确，那么相应的交易输出将不能被交易输入所引用；</li>
</ul>
</li>
</ul>
<p>通过锁定脚本与解锁脚本这种机制，保证了某个用户不能花费属于他人的 Coins。</p>
<p>同样，由于我们尚未实现钱包地址功能，<strong>ScriptSig</strong> 将会存储任意的用户所定义的钱包地址。我们将会在下一章节实现公钥和数字签名验证。</p>
<p>说了这么多，我们来总结一下。交易输出是”Coins” 实际存储的地方。每一个交易输出都带有一个锁定脚本，它决定了解锁的逻辑。每一笔新的交易必须至少有一个交易输入与交易输出。一笔交易的交易输入指向前一笔交易的交易输出，并且提供用于锁定脚本解锁需要的数据（<code>ScriptSig</code> 字段），然后利用交易输出中的 <code>value</code> 去创建新的交易输出。</p>
<blockquote>
<p>注意，这段话的原文如下，但是里面有表述错误的地方，交易输出带有的是锁定脚本，而不是解锁脚本。</p>
<p>Let’s sum it up. Outputs are where “coins” are stored. Each output comes with an unlocking script, which determines the logic of unlocking the output. Every new transaction must have at least one input and output. An input references an output from a previous transaction and provides data (the <code>ScriptSig</code> field) that is used in the output’s unlocking script to unlock it and use its value to create new outputs.</p>
</blockquote>
<p>那到底是先有交易输入还是先有交易输出呢？</p>
<h2 id="鸡与蛋的问题"><a href="#鸡与蛋的问题" class="headerlink" title="鸡与蛋的问题"></a>鸡与蛋的问题</h2><p>在比特币中，鸡蛋先于鸡出现。交易输入源自于交易输出的逻辑是典型的” 先有鸡还是先有蛋” 的问题：交易输入产生交易输出，交易输出又会被交易输入所引用。在比特币中，<strong>交易输出先于交易输入出现</strong>。</p>
<p>当矿工开始开采区块时，区块中会被添加一个 <strong>coinbase</strong> 交易（创币交易）。coinbase 交易是一种特殊的交易，它不需要以前已经存在的交易输出。它会凭空创建出交易输出（i.e: Coins）。也即，鸡蛋的出现并不需要母鸡，这笔交易是作为矿工成功挖出新的区块后的一笔奖励。</p>
<p>正如你所知道的那样，在区块链的最前端，即第一个区块，有一个创世区块。他产生了区块链中有史以来的第一个交易输出，并且由于没有前一笔交易，也就没有相应的输出，因此不需要前一笔交易的交易输出。</p>
<p>让我们来创建 coinbase 交易：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建CoinBase交易</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> to   收账的钱包地址</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> data 解锁脚本数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Transaction <span class="title function_">newCoinbaseTX</span><span class="params">(String to, String data)</span> {</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(data)) {</span><br><span class="line">        data = String.format(<span class="string">"Reward to '%s'"</span>, to);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 创建交易输入</span></span><br><span class="line">    <span class="type">TXInput</span> <span class="variable">txInput</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TXInput</span>(<span class="keyword">new</span> <span class="title class_">byte</span>[]{}, -<span class="number">1</span>, data);</span><br><span class="line">    <span class="comment">// 创建交易输出</span></span><br><span class="line">    <span class="type">TXOutput</span> <span class="variable">txOutput</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TXOutput</span>(SUBSIDY, to);</span><br><span class="line">    <span class="comment">// 创建交易</span></span><br><span class="line">    <span class="type">Transaction</span> <span class="variable">tx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Transaction</span>(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">TXInput</span>[]{txInput}, <span class="keyword">new</span> <span class="title class_">TXOutput</span>[]{txOutput});</span><br><span class="line">    <span class="comment">// 设置交易ID</span></span><br><span class="line">    tx.setTxId();</span><br><span class="line">    <span class="keyword">return</span> tx;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>coinbase 交易只有一个交易输入。在我们的代码实现中，<strong>txId</strong> 是空数组，<strong>txOutputIndex</strong> 设置为了 -1。另外，coinbase 交易不会在 <strong>ScriptSig</strong> 字段上存储解锁脚本，相反，存了一个任意的数据。</p>
<blockquote>
<p>在比特币中，第一个 coinbase 交易报刊了如下的信息：”The Times 03/Jan/2009 Chancellor on brink of second bailout for banks”. <a target="_blank" rel="noopener" href="https://blockchain.info/tx/4a5e1e4baab89f3a32518a88c31bc87f618f76673e2cc77ab2127b7afdeda33b?show_adv=true">点击查看</a></p>
</blockquote>
<p><strong>SUBSIDY</strong> 是挖矿奖励数量。在比特币中，这个奖励数量没有存储在任何地方，而是依据现有区块的总数进行计算而得到：区块总数 除以 210000。开采创世区块得到的奖励为 50BTC，每过 210000 个区块，奖励会减半。在我们的实现中，我们暂且将挖矿奖励设置为常数。（至少目前是这样）</p>
<h2 id="在区块链中存储交易信息"><a href="#在区块链中存储交易信息" class="headerlink" title="在区块链中存储交易信息"></a>在区块链中存储交易信息</h2><p>从现在开始，每一个区块必须存储至少一个交易信息，并且尽可能地避免在没有交易数据的情况下进行挖矿。这意味着我们必须移除 <strong>Block</strong> 对象中的 <strong>date</strong> 字段，取而代之的是 <strong>transactions</strong>：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 区块</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wangwei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/02/02</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Block</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 区块hash值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String hash;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 前一个区块的hash值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String previousHash;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 交易信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Transaction[] transactions;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 区块创建时间(单位:秒)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> timeStamp;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>相应地，<strong>newGenesisBlock</strong> 与 <strong>newBlock</strong> 也都需要做改变：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; 创建创世区块 &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> coinbase</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Block <span class="title function_">newGenesisBlock</span><span class="params">(Transaction coinbase)</span> {</span><br><span class="line">    <span class="keyword">return</span> Block.newBlock(<span class="string">""</span>, <span class="keyword">new</span> <span class="title class_">Transaction</span>[]{coinbase});</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; 创建新区块 &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> previousHash</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> transactions</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Block <span class="title function_">newBlock</span><span class="params">(String previousHash, Transaction[] transactions)</span> {</span><br><span class="line">     <span class="type">Block</span> <span class="variable">block</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Block</span>(<span class="string">""</span>, previousHash, transactions, Instant.now().getEpochSecond(), <span class="number">0</span>);</span><br><span class="line">     <span class="type">ProofOfWork</span> <span class="variable">pow</span> <span class="operator">=</span> ProofOfWork.newProofOfWork(block);</span><br><span class="line">     <span class="type">PowResult</span> <span class="variable">powResult</span> <span class="operator">=</span> pow.run();</span><br><span class="line">     block.setHash(powResult.getHash());</span><br><span class="line">     block.setNonce(powResult.getNonce());</span><br><span class="line">     <span class="keyword">return</span> block;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>接下来，修改 <strong>newBlockchain</strong> 方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * &lt;p&gt; 创建区块链 &lt;/p&gt;</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> address 钱包地址</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Blockchain <span class="title function_">newBlockchain</span><span class="params">(String address)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">    <span class="type">String</span> <span class="variable">lastBlockHash</span> <span class="operator">=</span> RocksDBUtils.getInstance().getLastBlockHash();</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(lastBlockHash)) {</span><br><span class="line">        <span class="comment">// 创建 coinBase 交易</span></span><br><span class="line">        <span class="type">Transaction</span> <span class="variable">coinbaseTX</span> <span class="operator">=</span> Transaction.newCoinbaseTX(address, <span class="string">""</span>);</span><br><span class="line">        <span class="type">Block</span> <span class="variable">genesisBlock</span> <span class="operator">=</span> Block.newGenesisBlock(coinbaseTX);</span><br><span class="line">        lastBlockHash = genesisBlock.getHash();</span><br><span class="line">        RocksDBUtils.getInstance().putBlock(genesisBlock);</span><br><span class="line">        RocksDBUtils.getInstance().putLastBlockHash(lastBlockHash);</span><br><span class="line">     }</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Blockchain</span>(lastBlockHash);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>现在，代码有钱包地址的接口，将会收到开采创世区块的奖励。</p>
<h2 id="工作量证明（Pow）"><a href="#工作量证明（Pow）" class="headerlink" title="工作量证明（Pow）"></a>工作量证明（Pow）</h2><p>Pow 算法必须将存储在区块中的交易信息考虑在内，以保存交易信息存储的一致性和可靠性。因此，我们必须修改 <strong>ProofOfWork.prepareData</strong> 接口代码逻辑：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 准备数据</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 注意：在准备区块数据时，一定要从原始数据类型转化为byte[]，不能直接从字符串进行转换</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> nonce</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">prepareData</span><span class="params">(<span class="type">long</span> nonce)</span> {</span><br><span class="line">   <span class="type">byte</span>[] prevBlockHashBytes = {};</span><br><span class="line">   <span class="keyword">if</span> (StringUtils.isNoneBlank(<span class="built_in">this</span>.getBlock().getPrevBlockHash())) {</span><br><span class="line">       prevBlockHashBytes = <span class="keyword">new</span> <span class="title class_">BigInteger</span>(<span class="built_in">this</span>.getBlock().getPrevBlockHash(), <span class="number">16</span>).toByteArray();</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> ByteUtils.merge(</span><br><span class="line">           prevBlockHashBytes,</span><br><span class="line">           <span class="built_in">this</span>.getBlock().hashTransaction(),</span><br><span class="line">           ByteUtils.toBytes(<span class="built_in">this</span>.getBlock().getTimeStamp()),</span><br><span class="line">           ByteUtils.toBytes(TARGET_BITS),</span><br><span class="line">           ByteUtils.toBytes(nonce)</span><br><span class="line">    );</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>其中  <strong>hashTransaction</strong> 代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对区块中的交易信息进行Hash计算</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">byte</span>[] hashTransaction() {</span><br><span class="line">   <span class="type">byte</span>[][] txIdArrays = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="built_in">this</span>.getTransactions().length][];</span><br><span class="line">   <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.getTransactions().length; i++) {</span><br><span class="line">       txIdArrays[i] = <span class="built_in">this</span>.getTransactions()[i].getTxId();</span><br><span class="line">   }</span><br><span class="line">   <span class="keyword">return</span> DigestUtils.sha256(ByteUtils.merge(txIds));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>同样，我们使用哈希值来作为数据的唯一标识。我们希望区块中的所有交易数据都能通过一个哈希值来定义它的唯一标识。为了达到这个目的，我们计算了每一个交易的唯一哈希值，然后将他们串联起来，再对这个串联后的组合进行哈希值计算。</p>
<blockquote>
<p>比特币使用更复杂的技术：它将所有包含在块中的交易表示为 <a target="_blank" rel="noopener" href="https://en.bitcoin.it/wiki/Protocol_documentation#Merkle_Trees">Merkle 树</a> ，并在 Proof-of-Work 系统中使用该树的根散列。 这种方法只需要跟节点的散列值就可以快速检查块是否包含某笔交易，而无需下载所有交易。</p>
</blockquote>
<h2 id="UTXO（未花费交易输出）"><a href="#UTXO（未花费交易输出）" class="headerlink" title="UTXO（未花费交易输出）"></a>UTXO（未花费交易输出）</h2><blockquote>
<p>UTXO：unspend transaction output.（未被花费的交易输出）</p>
<p>在比特币的世界里既没有账户，也没有余额，只有分散到区块链里的 UTXO.</p>
</blockquote>
<p><em>UTXO</em> 是理解比特币交易原理的关键所在，我们先来看一段场景：</p>
<p>场景：假设你过去分别向 A、B、C 这三个比特币用户购买了 BTC，从 A 手中购买了 3.5 个 BTC，从 B 手中购买了 4.5 个 BTC，从 C 手中购买了 2 个 BTC，现在你的比特币钱包里面恰好剩余 10 个 BTC。</p>
<p>问题：这个 10 个 BTC 是真正的 10 个 BTC 吗？其实不是，这句话可能听起来有点怪。（什么！我钱包里面的 BTC 不是真正的 BTC，你不要吓我……）</p>
<p>解释：前面提到过在比特币的交易系统当中，并不存在账户、余额这些概念，所以，你的钱包里面的 10 个 BTC，并不是说钱包余额为 10 个 BTC。而是说，这 10 个 BTC 其实是由你的比特币地址（钱包地址 | 公钥）锁定了的散落在各个区块和各个交易里面的 UTXO 的总和。</p>
<p>UTXO 是比特币交易的基本单位，每笔交易都会产生 UTXO，一个 UTXO 可以是一 “聪” 的任意倍。给某人发送比特币实际上是创造新的 UTXO，绑定到那个人的钱包地址，并且能被他用于新的支付。</p>
<p>一般的比特币交易由 <code>交易输入</code> 和 <code>交易输出</code> 两部分组成。A 向你支付 3.5 个 BTC 这笔交易，实际上产生了一个新的 UTXO，这个新的 UTXO 等于 3.5 个 BTC（3.5 亿聪），并且锁定到了你的比特币钱包地址上。</p>
<p>假如你要给你女（男）朋友转 1.5 BTC，那么你的钱包会从可用的 UTXO 中选取一个或多个可用的个体来拼凑出一个大于或等于一笔交易所需的比特币量。比如在这个假设场景里面，你的钱包会选取你和 C 的交易中的 UTXO 作为 交易输入，input = 2BTC，这里会生成两个新的交易输出，一个输出（UTXO = 1.5 BTC）会被绑定到你女（男）朋友的钱包地址上，另一个输出（UTXO = 0.5 BTC）会作为找零，重新绑定到你的钱包地址上。</p>
<blockquote>
<p>有关比特币交易这部分更详细的内容，请查看：<a target="_blank" rel="noopener" href="https://github.com/bitcoinbook/bitcoinbook/blob/develop/ch06.asciidoc#transactions">《精通比特币（第二版）》第 6 章 —— 交易</a></p>
</blockquote>
<p>我们需要找到所有未花费的交易输出（UTXO）。<em>Unspent (未花费)</em> 意味着这些交易输出从未被交易输入所指向。这前面的图片中，UTXO 如下：</p>
<ol>
<li>tx0, output 1;</li>
<li>tx1, output 0;</li>
<li>tx3, output 0;</li>
<li>tx4, output 0.</li>
</ol>
<p>当然，当我们检查余额时，我不需要区块链中所有的 UTXO，我只需要能被我们解锁的 UTXO（当前，我们还没有实现密钥对，而是替代为用户自定义的钱包地址）。首先，我们在交易输入与交易输出上定义锁定 - 解锁的方法：</p>
<p>交易输入：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TXInput</span> {</span><br><span class="line">  	</span><br><span class="line">    ...</span><br><span class="line">     </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断解锁数据是否能够解锁交易输出</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> unlockingData</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">canUnlockOutputWith</span><span class="params">(String unlockingData)</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.getScriptSig().endsWith(unlockingData);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>交易输出：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TXOutput</span> {</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">        </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断解锁数据是否能够解锁交易输出</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> unlockingData</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">canBeUnlockedWith</span><span class="params">(String unlockingData)</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.getScriptPubKey().endsWith(unlockingData);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这里我们暂时用 <strong>unlockingData</strong> 来与脚本字段进行比较。我们会在后面的文章中来对这部分内容进行优化，我们将会基于私钥来实现用户的钱包地址。</p>
<p>下一步，查询所有与钱包地址绑定的包含 UTXO 的交易信息，有点复杂（本篇先这样实现，后面我们做一个与钱包地址映射的 UTXO 池来进行优化）：</p>
<ul>
<li>从与钱包地址对应的交易输入中查询出所有已被花费了的交易输出</li>
<li>再来排除，寻找包含未被花费的交易输出的交易 </li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Blockchain</span> {</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查找钱包地址对应的所有未花费的交易</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> address 钱包地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Transaction[] findUnspentTransactions(String address) <span class="keyword">throws</span> Exception {</span><br><span class="line">        Map&lt;String, <span class="type">int</span>[]&gt; allSpentTXOs = <span class="built_in">this</span>.getAllSpentTXOs(address);</span><br><span class="line">        Transaction[] unspentTxs = {};</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 再次遍历所有区块中的交易输出</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">BlockchainIterator</span> <span class="variable">blockchainIterator</span> <span class="operator">=</span> <span class="built_in">this</span>.getBlockchainIterator(); blockchainIterator.hashNext(); ) {</span><br><span class="line">            <span class="type">Block</span> <span class="variable">block</span> <span class="operator">=</span> blockchainIterator.next();</span><br><span class="line">            <span class="keyword">for</span> (Transaction transaction : block.getTransactions()) {</span><br><span class="line"></span><br><span class="line">                <span class="type">String</span> <span class="variable">txId</span> <span class="operator">=</span> Hex.encodeHexString(transaction.getTxId());</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span>[] spentOutIndexArray = allSpentTXOs.get(txId);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">outIndex</span> <span class="operator">=</span> <span class="number">0</span>; outIndex &lt; transaction.getOutputs().length; outIndex++) {</span><br><span class="line">                    <span class="keyword">if</span> (spentOutIndexArray != <span class="literal">null</span> &amp;&amp; ArrayUtils.contains(spentOutIndexArray, outIndex)) {</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    }</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 保存不存在 allSpentTXOs 中的交易</span></span><br><span class="line">                    <span class="keyword">if</span> (transaction.getOutputs()[outIndex].canBeUnlockedWith(address)) {</span><br><span class="line">                        unspentTxs = ArrayUtils.add(unspentTxs, transaction);</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> unspentTxs;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从交易输入中查询区块链中所有已被花费了的交易输出</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> address 钱包地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 交易ID以及对应的交易输出下标地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, <span class="type">int</span>[]&gt; getAllSpentTXOs(String address) <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="comment">// 定义TxId ——&gt; spentOutIndex[]，存储交易ID与已被花费的交易输出数组索引值</span></span><br><span class="line">        Map&lt;String, <span class="type">int</span>[]&gt; spentTXOs = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">BlockchainIterator</span> <span class="variable">blockchainIterator</span> <span class="operator">=</span> <span class="built_in">this</span>.getBlockchainIterator(); blockchainIterator.hashNext(); ) {</span><br><span class="line">            <span class="type">Block</span> <span class="variable">block</span> <span class="operator">=</span> blockchainIterator.next();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (Transaction transaction : block.getTransactions()) {</span><br><span class="line">                <span class="comment">// 如果是 coinbase 交易，直接跳过，因为它不存在引用前一个区块的交易输出</span></span><br><span class="line">                <span class="keyword">if</span> (transaction.isCoinbase()) {</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">for</span> (TXInput txInput : transaction.getInputs()) {</span><br><span class="line">                    <span class="keyword">if</span> (txInput.canUnlockOutputWith(address)) {</span><br><span class="line">                        <span class="type">String</span> <span class="variable">inTxId</span> <span class="operator">=</span> Hex.encodeHexString(txInput.getTxId());</span><br><span class="line">                        <span class="type">int</span>[] spentOutIndexArray = spentTXOs.get(inTxId);</span><br><span class="line">                        <span class="keyword">if</span> (spentOutIndexArray == <span class="literal">null</span>) {</span><br><span class="line">                            spentTXOs.put(inTxId, <span class="keyword">new</span> <span class="title class_">int</span>[]{txInput.getTxOutputIndex()});</span><br><span class="line">                        } <span class="keyword">else</span> {</span><br><span class="line">                            spentOutIndexArray = ArrayUtils.add(spentOutIndexArray, txInput.getTxOutputIndex());</span><br><span class="line">                            spentTXOs.put(inTxId, spentOutIndexArray);</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> spentTXOs;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p>得到了所有包含 UTXO 的交易数据，接下来，我们就可以得到所有 UTXO 集合了：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Blockchain</span> {</span><br><span class="line"></span><br><span class="line">   ...</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查找钱包地址对应的所有UTXO</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> address 钱包地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> TXOutput[] findUTXO(String address) <span class="keyword">throws</span> Exception {</span><br><span class="line">        Transaction[] unspentTxs = <span class="built_in">this</span>.findUnspentTransactions(address);</span><br><span class="line">        TXOutput[] utxos = {};</span><br><span class="line">        <span class="keyword">if</span> (unspentTxs == <span class="literal">null</span> || unspentTxs.length == <span class="number">0</span>) {</span><br><span class="line">            <span class="keyword">return</span> utxos;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">for</span> (Transaction tx : unspentTxs) {</span><br><span class="line">            <span class="keyword">for</span> (TXOutput txOutput : tx.getOutputs()) {</span><br><span class="line">                <span class="keyword">if</span> (txOutput.canBeUnlockedWith(address)) {</span><br><span class="line">                    utxos = ArrayUtils.add(utxos, txOutput);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> utxos;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p>现在，我们可以实现获取钱包地址余额的接口了：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CLI</span> {</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">        </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询钱包余额</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> address 钱包地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">getBalance</span><span class="params">(String address)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">Blockchain</span> <span class="variable">blockchain</span> <span class="operator">=</span> Blockchain.createBlockchain(address);</span><br><span class="line">        TXOutput[] txOutputs = blockchain.findUTXO(address);</span><br><span class="line">        <span class="type">int</span> <span class="variable">balance</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (txOutputs != <span class="literal">null</span> &amp;&amp; txOutputs.length &gt; <span class="number">0</span>) {</span><br><span class="line">            <span class="keyword">for</span> (TXOutput txOutput : txOutputs) {</span><br><span class="line">                balance += txOutput.getValue();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        System.out.printf(<span class="string">"Balance of '%s': %d\n"</span>, address, balance);</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    ...</span><br><span class="line">        </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>查询 <em>wangwei</em> 这个钱包地址的余额：</p>
<figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> ./blockchain.sh getbalance <span class="literal">-address</span> wangwei</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">Balance of <span class="string">'wangwei'</span>: <span class="number">10</span></span><br></pre></td></tr></tbody></table></figure>



<h2 id="转账"><a href="#转账" class="headerlink" title="转账"></a>转账</h2><p>现在，我们想要给某人发送一些币。因此，我们需要创建一笔新的交易，然后放入区块中，再进行挖矿。到目前为止，我们只是实现了 <em>coinbase</em> 交易，现在我们需要实现常见的创建交易接口：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Transaction</span> {</span><br><span class="line"> </span><br><span class="line">   ...</span><br><span class="line">   </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从 from 向  to 支付一定的 amount 的金额</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> from       支付钱包地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> to         收款钱包地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> amount     交易金额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> blockchain 区块链</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Transaction <span class="title function_">newUTXOTransaction</span><span class="params">(String from, String to, <span class="type">int</span> amount, Blockchain blockchain)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">SpendableOutputResult</span> <span class="variable">result</span> <span class="operator">=</span> blockchain.findSpendableOutputs(from, amount);</span><br><span class="line">        <span class="type">int</span> <span class="variable">accumulated</span> <span class="operator">=</span> result.getAccumulated();</span><br><span class="line">        Map&lt;String, <span class="type">int</span>[]&gt; unspentOuts = result.getUnspentOuts();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (accumulated &lt; amount) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">"ERROR: Not enough funds"</span>);</span><br><span class="line">        }</span><br><span class="line">        Iterator&lt;Map.Entry&lt;String, <span class="type">int</span>[]&gt;&gt; iterator = unspentOuts.entrySet().iterator();</span><br><span class="line"></span><br><span class="line">        TXInput[] txInputs = {};</span><br><span class="line">        <span class="keyword">while</span> (iterator.hasNext()) {</span><br><span class="line">            Map.Entry&lt;String, <span class="type">int</span>[]&gt; entry = iterator.next();</span><br><span class="line">            <span class="type">String</span> <span class="variable">txIdStr</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">            <span class="type">int</span>[] outIdxs = entry.getValue();</span><br><span class="line">            <span class="type">byte</span>[] txId = Hex.decodeHex(txIdStr);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> outIndex : outIdxs) {</span><br><span class="line">                txInputs = ArrayUtils.add(txInputs, <span class="keyword">new</span> <span class="title class_">TXInput</span>(txId, outIndex, from));</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        TXOutput[] txOutput = {};</span><br><span class="line">        txOutput = ArrayUtils.add(txOutput, <span class="keyword">new</span> <span class="title class_">TXOutput</span>(amount, to));</span><br><span class="line">        <span class="keyword">if</span> (accumulated &gt; amount) {</span><br><span class="line">            txOutput = ArrayUtils.add(txOutput, <span class="keyword">new</span> <span class="title class_">TXOutput</span>((accumulated - amount), from));</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="type">Transaction</span> <span class="variable">newTx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Transaction</span>(<span class="literal">null</span>, txInputs, txOutput);</span><br><span class="line">        newTx.setTxId();</span><br><span class="line">        <span class="keyword">return</span> newTx;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">}    </span><br></pre></td></tr></tbody></table></figure>

<p>在创建新的交易输出之前，我们需要事先找到所有的 UTXO，并确保有足够的金额。这就是 <strong>findSpendableOutputs</strong> 要干的事情。之后，为每个找到的输出创建一个引用它的输入。接下来，我们创建两个交易输出：</p>
<ol>
<li>一个 <em>output</em> 用于锁定到接收者的钱包地址上。这个是真正被转走的 coins；</li>
<li>另一个 <em>output</em> 锁定到发送者的钱包地址上。这个就是 找零。只有当用于支付的 UTXO 总和大于要支付的金额时，才会创建这部分的 交易输出。记住：交易输出是<strong>不可分割的</strong></li>
</ol>
<p><strong>findSpendableOutputs</strong> 需要调用我们之前创建的 <strong>findUnspentTransactions</strong> 接口：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Blockchain</span> {</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 寻找能够花费的交易</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> address 钱包地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> amount  花费金额</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> SpendableOutputResult <span class="title function_">findSpendableOutputs</span><span class="params">(String address, <span class="type">int</span> amount)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        Transaction[] unspentTXs = <span class="built_in">this</span>.findUnspentTransactions(address);</span><br><span class="line">        <span class="type">int</span> <span class="variable">accumulated</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        Map&lt;String, <span class="type">int</span>[]&gt; unspentOuts = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Transaction tx : unspentTXs) {</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">txId</span> <span class="operator">=</span> Hex.encodeHexString(tx.getTxId());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">outId</span> <span class="operator">=</span> <span class="number">0</span>; outId &lt; tx.getOutputs().length; outId++) {</span><br><span class="line"></span><br><span class="line">                <span class="type">TXOutput</span> <span class="variable">txOutput</span> <span class="operator">=</span> tx.getOutputs()[outId];</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (txOutput.canBeUnlockedWith(address) &amp;&amp; accumulated &lt; amount) {</span><br><span class="line">                    accumulated += txOutput.getValue();</span><br><span class="line"></span><br><span class="line">                    <span class="type">int</span>[] outIds = unspentOuts.get(txId);</span><br><span class="line">                    <span class="keyword">if</span> (outIds == <span class="literal">null</span>) {</span><br><span class="line">                        outIds = <span class="keyword">new</span> <span class="title class_">int</span>[]{outId};</span><br><span class="line">                    } <span class="keyword">else</span> {</span><br><span class="line">                        outIds = ArrayUtils.add(outIds, outId);</span><br><span class="line">                    }</span><br><span class="line">                    unspentOuts.put(txId, outIds);</span><br><span class="line">                    <span class="keyword">if</span> (accumulated &gt;= amount) {</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SpendableOutputResult</span>(accumulated, unspentOuts);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这个方法会遍历所有的 UTXO 并统计他们的总额。当计算的总额恰好大于或者等于需要转账的金额时，方法会停止遍历，然后返回用于支付的总额以及按交易 ID 分组的交易输出索引值数组。我们不想要花更多的钱。</p>
<p>现在，我们可以修改 <strong>Block.mineBlock</strong> 接口：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Block</span> {</span><br><span class="line">   </span><br><span class="line">   ...</span><br><span class="line">   </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 打包交易，进行挖矿</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> transactions</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">mineBlock</span><span class="params">(Transaction[] transactions)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">String</span> <span class="variable">lastBlockHash</span> <span class="operator">=</span> RocksDBUtils.getInstance().getLastBlockHash();</span><br><span class="line">        <span class="keyword">if</span> (lastBlockHash == <span class="literal">null</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">"ERROR: Fail to get last block hash ! "</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="type">Block</span> <span class="variable">block</span> <span class="operator">=</span> Block.newBlock(lastBlockHash, transactions);</span><br><span class="line">        <span class="built_in">this</span>.addBlock(block);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">}    </span><br></pre></td></tr></tbody></table></figure>

<p>最后，我们来实现转账的接口：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CLI</span> {</span><br><span class="line">   </span><br><span class="line">   ...</span><br><span class="line">  </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 转账</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> from</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> to</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> amount</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">send</span><span class="params">(String from, String to, <span class="type">int</span> amount)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">Blockchain</span> <span class="variable">blockchain</span> <span class="operator">=</span> Blockchain.createBlockchain(from);</span><br><span class="line">        <span class="type">Transaction</span> <span class="variable">transaction</span> <span class="operator">=</span> Transaction.newUTXOTransaction(from, to, amount, blockchain);</span><br><span class="line">        blockchain.mineBlock(<span class="keyword">new</span> <span class="title class_">Transaction</span>[]{transaction});</span><br><span class="line">        RocksDBUtils.getInstance().closeDB();</span><br><span class="line">        System.out.println(<span class="string">"Success!"</span>);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">}    </span><br></pre></td></tr></tbody></table></figure>

<p>转账，意味着创建一笔新的交易并且通过挖矿的方式将其存入区块中。但是，比特币不会像我们这样做，它会把新的交易记录先存到内存池中，当一个矿工准备去开采一个区块时，它会把打包内存池中的所有交易信息，并且创建一个候选区块。只有当这个包含所有交易信息的候选区块被成功开采并且被添加到区块链上时，这些交易信息才算被确认。</p>
<p>让我们来测试一下：</p>
<figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先确认 wangwei 的余额</span></span><br><span class="line"><span class="variable">$</span> ./blockchain.sh getbalance <span class="literal">-address</span> wangwei</span><br><span class="line">Balance of <span class="string">'wangwei'</span>: <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 转账</span></span><br><span class="line"><span class="variable">$</span> ./blockchain.sh send <span class="literal">-from</span> wangwei <span class="literal">-to</span> Pedro <span class="literal">-amount</span> <span class="number">6</span></span><br><span class="line">Elapsed Time: <span class="number">0.828</span> seconds </span><br><span class="line">correct hash Hex: <span class="number">00000</span>c5f50cf72db1f375a5d454f98bc49d07335db921cbef5fa9e58ad34d462 </span><br><span class="line"></span><br><span class="line">Success!</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询 wangwei 的余额</span></span><br><span class="line"><span class="variable">$</span> ./blockchain.sh getbalance <span class="literal">-address</span> wangwei</span><br><span class="line">Balance of <span class="string">'wangwei'</span>: <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询 Pedro 的余额</span></span><br><span class="line"><span class="variable">$</span> ./blockchain.sh getbalance <span class="literal">-address</span> Pedro</span><br><span class="line">Balance of <span class="string">'Pedro'</span>: <span class="number">6</span></span><br></pre></td></tr></tbody></table></figure>

<p>赞！现在让我们来创建更多的交易并且确保从多个交易输出进行转账是正常的：</p>
<figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> ./blockchain.sh send <span class="literal">-from</span> Pedro <span class="literal">-to</span> Helen <span class="literal">-amount</span> <span class="number">2</span></span><br><span class="line">Elapsed Time: <span class="number">2.533</span> seconds </span><br><span class="line">correct hash Hex: <span class="number">00000</span>c81d541ad407a3767ad633d1147602df86fe14e1962ec145ab17b633e88 </span><br><span class="line"></span><br><span class="line">Success!</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$</span> ./blockchain.sh send <span class="literal">-from</span> wangwei <span class="literal">-to</span> Helen <span class="literal">-amount</span> <span class="number">2</span></span><br><span class="line">Elapsed Time: <span class="number">1.481</span> seconds </span><br><span class="line">correct hash Hex: <span class="number">00000</span>c3f8b82c2b970438f5f1f39d56bb8a9d66341efc92a02ffcbff91acd84b </span><br><span class="line"></span><br><span class="line">Success!</span><br></pre></td></tr></tbody></table></figure>

<p>现在，Helen 这个钱包地址上有了两笔从 wangwei 和 Pedro 转账中产生的 UTXO，让我们将它们再转账给另外一个人：</p>
<figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> ./blockchain.sh send <span class="literal">-from</span> Helen <span class="literal">-to</span> Rachel <span class="literal">-amount</span> <span class="number">3</span></span><br><span class="line">Elapsed Time: <span class="number">17.136</span> seconds </span><br><span class="line">correct hash Hex: <span class="number">000000</span>b1226a947166c2b01a15d1cd3558ddf86fe99bad28a0501a2af60f6a02 </span><br><span class="line"></span><br><span class="line">Success!</span><br><span class="line"></span><br><span class="line"><span class="variable">$</span> ./blochchain.sh getbalance <span class="literal">-address</span> wangwei</span><br><span class="line">Balance of <span class="string">'wangwei'</span>: <span class="number">2</span></span><br><span class="line"><span class="variable">$</span> ./blochchain.sh getbalance <span class="literal">-address</span> Pedro  </span><br><span class="line">Balance of <span class="string">'Pedro'</span>: <span class="number">4</span></span><br><span class="line"><span class="variable">$</span> ./blochchain.sh getbalance <span class="literal">-address</span> Helen</span><br><span class="line">Balance of <span class="string">'Helen'</span>: <span class="number">1</span></span><br><span class="line"><span class="variable">$</span> ./blochchain.sh getbalance <span class="literal">-address</span> Rachel</span><br><span class="line">Balance of <span class="string">'Rachel'</span>: <span class="number">3</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>非常棒！让我们来测试一下失败的场景：</p>
<figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> ./blochchain.sh send <span class="literal">-from</span> wangwei <span class="literal">-to</span> Ivan <span class="literal">-amount</span> <span class="number">5</span> </span><br><span class="line">java.lang.Exception: ERROR: Not enough funds</span><br><span class="line">        at one.wangwei.blockchain.transaction.Transaction.newUTXOTransaction(Transaction.java:<span class="number">104</span>)</span><br><span class="line">        at one.wangwei.blockchain.cli.CLI.send(CLI.java:<span class="number">138</span>)</span><br><span class="line">        at one.wangwei.blockchain.cli.CLI.parse(CLI.java:<span class="number">73</span>)</span><br><span class="line">        at one.wangwei.blockchain.cli.Main.main(Main.java:<span class="number">7</span>)</span><br></pre></td></tr></tbody></table></figure>



<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本篇内容有点难度，但好歹我们现在有了交易信息了。尽管，缺少像比特币这一类加密货币的一些关键特性：</p>
<ol>
<li>钱包地址。我们还没有基于私钥的真实地址。</li>
<li>奖励。挖矿绝对没有利润。</li>
<li>UTXO 池。当我们计算钱包地址的余额时，我们需要遍历所有的区块中的所有交易信息，当有许许多多的区块时，这将花费不少的时间。此外，如果我们想验证以后的交易，可能需要很长时间。 UTXO 迟旨在解决这些问题并快速处理交易。</li>
<li>内存池。 这是交易在打包成区块之前存储的地方。 在我们当前的实现中，一个块只包含一笔交易，而且效率很低。</li>
</ol>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><ul>
<li>源代码：<a target="_blank" rel="noopener" href="https://github.com/wangweiX/blockchain-java/tree/part4-transaction1">https://github.com/wangweiX/blockchain-java/tree/part4-transaction1</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/bitcoinbook/bitcoinbook/blob/develop/ch06.asciidoc#transactions">《精通比特币（第二版）》第 6 章 —— 交易</a></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Wang Wei</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://wangwei.one/posts/build-blockchain-in-java-transaction-utxo.html">https://wangwei.one/posts/build-blockchain-in-java-transaction-utxo.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/blockchain/">blockchain</a><a class="post-meta__tags" href="/tags/bitcoin/">bitcoin</a><a class="post-meta__tags" href="/tags/UTXO/">UTXO</a></div><div class="post_share"><div class="social-share" data-image="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/build-blockchain-in-java-wallet-address.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">基于 Java 语言构建区块链（五）—— 地址（钱包）</div></div></a></div><div class="next-post pull-right"><a href="/posts/build-blockchain-in-java-data-persistence.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">基于 Java 语言构建区块链（三）—— 持久化 &amp; 命令行</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/posts/build-blockchain-in-java-transaction-merkle-tree.html" title="基于 Java 语言构建区块链（六）—— 交易（Merkle Tree）"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-03-26</div><div class="title">基于 Java 语言构建区块链（六）—— 交易（Merkle Tree）</div></div></a></div><div><a href="/posts/build-blockchain-in-java-base-prototype.html" title="基于 Java 语言构建区块链（一）—— 基本原型"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-02-02</div><div class="title">基于 Java 语言构建区块链（一）—— 基本原型</div></div></a></div><div><a href="/posts/build-blockchain-in-java-transaction-script.html" title="基于 Java 语言构建区块链（七）—— 交易脚本（智能合约）"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-05-02</div><div class="title">基于 Java 语言构建区块链（七）—— 交易脚本（智能合约）</div></div></a></div><div><a href="/posts/build-blockchain-in-java-data-persistence.html" title="基于 Java 语言构建区块链（三）—— 持久化 & 命令行"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-02-07</div><div class="title">基于 Java 语言构建区块链（三）—— 持久化 & 命令行</div></div></a></div><div><a href="/posts/build-blockchain-in-java-proof-of-work.html" title="基于 Java 语言构建区块链（二）—— 工作量证明"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-02-03</div><div class="title">基于 Java 语言构建区块链（二）—— 工作量证明</div></div></a></div><div><a href="/posts/build-blockchain-in-java-wallet-address.html" title="基于 Java 语言构建区块链（五）—— 地址（钱包）"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-03-25</div><div class="title">基于 Java 语言构建区块链（五）—— 地址（钱包）</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Wang Wei</div><div class="author-info__description"></div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">74</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">39</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">4</div></a></div></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/wangweiX" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:dzd5ZWFyc0BnbWFpbC5jb20NCg==" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">引言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AF%94%E7%89%B9%E5%B8%81%E4%BA%A4%E6%98%93"><span class="toc-number">2.</span> <span class="toc-text">比特币交易</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%A4%E6%98%93%E7%BB%84%E6%88%90"><span class="toc-number">2.1.</span> <span class="toc-text">交易组成</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%A4%E6%98%93%E8%BE%93%E5%87%BA"><span class="toc-number">3.</span> <span class="toc-text">交易输出</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%A4%E6%98%93%E8%BE%93%E5%85%A5"><span class="toc-number">4.</span> <span class="toc-text">交易输入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%B8%A1%E4%B8%8E%E8%9B%8B%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">5.</span> <span class="toc-text">鸡与蛋的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%AD%E5%AD%98%E5%82%A8%E4%BA%A4%E6%98%93%E4%BF%A1%E6%81%AF"><span class="toc-number">6.</span> <span class="toc-text">在区块链中存储交易信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E9%87%8F%E8%AF%81%E6%98%8E%EF%BC%88Pow%EF%BC%89"><span class="toc-number">7.</span> <span class="toc-text">工作量证明（Pow）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#UTXO%EF%BC%88%E6%9C%AA%E8%8A%B1%E8%B4%B9%E4%BA%A4%E6%98%93%E8%BE%93%E5%87%BA%EF%BC%89"><span class="toc-number">8.</span> <span class="toc-text">UTXO（未花费交易输出）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BD%AC%E8%B4%A6"><span class="toc-number">9.</span> <span class="toc-text">转账</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">10.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%84%E6%96%99"><span class="toc-number">11.</span> <span class="toc-text">资料</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/spring-cloud-eureka-source-code-analysis.html" title="SpringCloud 之 Eureka 源码分析"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SpringCloud 之 Eureka 源码分析"/></a><div class="content"><a class="title" href="/posts/spring-cloud-eureka-source-code-analysis.html" title="SpringCloud 之 Eureka 源码分析">SpringCloud 之 Eureka 源码分析</a><time datetime="2021-03-31T16:00:00.000Z" title="Created 2021-04-01 00:00:00">2021-04-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/jvm-gc-garbage-first.html" title="Garbage-First(G1)"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Garbage-First(G1)"/></a><div class="content"><a class="title" href="/posts/jvm-gc-garbage-first.html" title="Garbage-First(G1)">Garbage-First(G1)</a><time datetime="2020-01-01T10:19:03.000Z" title="Created 2020-01-01 18:19:03">2020-01-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/netflix-guide.html" title="输入「神秘代码」解锁「隐藏类目」"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="输入「神秘代码」解锁「隐藏类目」"/></a><div class="content"><a class="title" href="/posts/netflix-guide.html" title="输入「神秘代码」解锁「隐藏类目」">输入「神秘代码」解锁「隐藏类目」</a><time datetime="2019-04-17T00:12:00.000Z" title="Created 2019-04-17 08:12:00">2019-04-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/How-to-change-icloud-region.html" title="数据移民漂流记 —— 如何进行 iCloud 转区操作"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="数据移民漂流记 —— 如何进行 iCloud 转区操作"/></a><div class="content"><a class="title" href="/posts/How-to-change-icloud-region.html" title="数据移民漂流记 —— 如何进行 iCloud 转区操作">数据移民漂流记 —— 如何进行 iCloud 转区操作</a><time datetime="2019-04-13T13:48:43.000Z" title="Created 2019-04-13 21:48:43">2019-04-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/How-to-register-and-use-the-Google-Voice.html" title="数据移民漂流记 —— 如何拥有属于自己的美国电话号码"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="数据移民漂流记 —— 如何拥有属于自己的美国电话号码"/></a><div class="content"><a class="title" href="/posts/How-to-register-and-use-the-Google-Voice.html" title="数据移民漂流记 —— 如何拥有属于自己的美国电话号码">数据移民漂流记 —— 如何拥有属于自己的美国电话号码</a><time datetime="2019-04-12T13:48:43.000Z" title="Created 2019-04-12 21:48:43">2019-04-12</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2014 - 2022 By Wang Wei</div><div class="footer_custom_text">Stay Hungry, Stay Foolish</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>function loadDisqusjs () {
  function addDisqusjsCSS () {
    const ele = document.createElement('link')
    ele.rel = 'stylesheet'
    ele.href= 'https://cdn.jsdelivr.net/npm/disqusjs@1/dist/disqusjs.css'
    document.getElementsByTagName('head')[0].appendChild(ele)
  }

  function initDisqusjs () {
    window.DISQUS = null
    new DisqusJS(Object.assign({
      shortname: 'wangweiblog',
      identifier: 'posts/build-blockchain-in-java-transaction-utxo.html',
      url: 'https://wangwei.one/posts/build-blockchain-in-java-transaction-utxo.html',
      title: '基于 Java 语言构建区块链（四）—— 交易（UTXO）',
      apikey: 'Fbg1QT6GJQYjK5jgJotfR5tznyJ6z9i6sfzhumYxWwOLo4IiepF29KpLsW296beS',
    },null))
  }


  window.disqusReset = initDisqusjs

  if (window.disqusJsLoad) initDisqusjs()
  else {
    addDisqusjsCSS()
    getScript('https://cdn.jsdelivr.net/npm/disqusjs@1/dist/disqus.js').then(initDisqusjs)
    window.disqusJsLoad = true
  }
}

if ('Disqusjs' === 'Disqusjs' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqusjs)
  else loadDisqusjs()
}
else {
  function loadOtherComment () {
    loadDisqusjs()
  }
}

</script></div><div id="particles-js"></div><script src="/lib/js/particles.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: true,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', 'UA-112239883-1', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>