<!DOCTYPE html><html class="theme-next muse use-motion" lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><link rel="stylesheet" media="all" href="https://static.i7years.com/blog/lib/Han/dist/han.min.css?v=3.3"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="https://static.i7years.com/blog/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="https://static.i7years.com/blog/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="https://static.i7years.com/blog/css/main.css?v=5.1.3" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/favicon-180x180.png?v=5.1.3"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png?v=5.1.3"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png?v=5.1.3"><link rel="mask-icon" href="/logo.svg?v=5.1.3" color="#222"><meta name="keywords" content="blockchain,bitcoin,Merkle Tree,UTXO,SPV,"><meta name="description" content="文章的主要思想和内容均来自 https://jeiwan.cc/posts/building-blockchain-in-go-part-6/引言在这一系列文章的最开始部分，我们提到过区块链是一个分布式的数据库。那时候，我们决定跳过”分布式”这一环节，并且聚焦于”数据存储”这一环节。到目前为止，我们几乎实现了区块链的所有组成部分。在本篇文章中，我们将会涉及一些在前面的文章中所忽略的一些机制，并且在"><meta name="keywords" content="blockchain,bitcoin,Merkle Tree,UTXO,SPV"><meta property="og:type" content="article"><meta property="og:title" content="基于Java语言构建区块链（六）—— 交易（Merkle Tree）"><meta property="og:url" content="https://wangwei.one/posts/build-blockchain-in-java-transaction-merkle-tree.html"><meta property="og:site_name" content="终生成长"><meta property="og:description" content="文章的主要思想和内容均来自 https://jeiwan.cc/posts/building-blockchain-in-go-part-6/引言在这一系列文章的最开始部分，我们提到过区块链是一个分布式的数据库。那时候，我们决定跳过”分布式”这一环节，并且聚焦于”数据存储”这一环节。到目前为止，我们几乎实现了区块链的所有组成部分。在本篇文章中，我们将会涉及一些在前面的文章中所忽略的一些机制，并且在"><meta property="og:locale" content="en"><meta property="og:image" content="https://img.i7years.com/blog/pexels-photo-38136.webp"><meta property="og:image" content="https://img.i7years.com/blog/full_node.png-zoom50"><meta property="og:image" content="https://img.i7years.com/blog/merkle-tree-diagram.png"><meta property="og:image" content="https://img.i7years.com/blog/blockchain_exploer.png"><meta property="og:updated_time" content="2019-03-29T07:35:48.508Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="基于Java语言构建区块链（六）—— 交易（Merkle Tree）"><meta name="twitter:description" content="文章的主要思想和内容均来自 https://jeiwan.cc/posts/building-blockchain-in-go-part-6/引言在这一系列文章的最开始部分，我们提到过区块链是一个分布式的数据库。那时候，我们决定跳过”分布式”这一环节，并且聚焦于”数据存储”这一环节。到目前为止，我们几乎实现了区块链的所有组成部分。在本篇文章中，我们将会涉及一些在前面的文章中所忽略的一些机制，并且在"><meta name="twitter:image" content="https://img.i7years.com/blog/pexels-photo-38136.webp"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Muse",version:"5.1.3",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"Author"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://wangwei.one/posts/build-blockchain-in-java-transaction-merkle-tree.html"><title>基于Java语言构建区块链（六）—— 交易（Merkle Tree） | 终生成长</title><script>!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject=g,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="https://www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script",0,"ga"),ga("create","UA-112239883-1","auto"),ga("send","pageview")</script><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?7a23039be1256cfe778d1eeb19110f89";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><link rel="stylesheet" href="/lib/canvas-nest/css/particles-style.min.css"></head><body itemscope itemtype="http://schema.org/WebPage" lang="en"><div id="particles-js"></div><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">终生成长</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">每天夜里睡觉时都比那天早晨聪明一点点</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-首页"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-区块链"><a href="/categories/blockchain/" rel="section"><i class="menu-item-icon fa fa-fw fa-btc"></i><br>区块链</a></li><li class="menu-item menu-item-编程"><a href="/categories/coding/" rel="section"><i class="menu-item-icon fa fa-fw fa-terminal"></i><br>编程</a></li><li class="menu-item menu-item-工具"><a href="/categories/tools/" rel="section"><i class="menu-item-icon fa fa-fw fa-gear"></i><br>工具</a></li><li class="menu-item menu-item-阅读"><a href="/books/" rel="section"><i class="menu-item-icon fa fa-fw fa-book"></i><br>阅读</a></li><li class="menu-item menu-item-电影"><a href="/movies/" rel="section"><i class="menu-item-icon fa fa-fw fa-film"></i><br>电影</a></li><li class="menu-item menu-item-分类"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-标签"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-归档"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-关于"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>Search</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://wangwei.one/posts/build-blockchain-in-java-transaction-merkle-tree.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Michael"><meta itemprop="description" content=""><meta itemprop="image" content="https://img.i7years.com/avatar/naruto.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="终生成长"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">基于Java语言构建区块链（六）—— 交易（Merkle Tree）</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-03-26T17:00:00+08:00">2018-03-26 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/blockchain/" itemprop="url" rel="index"><span itemprop="name">blockchain</span> </a></span></span><span class="post-comments-count"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-comment-o"></i> </span><a href="/posts/build-blockchain-in-java-transaction-merkle-tree.html#comments" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="posts/build-blockchain-in-java-transaction-merkle-tree.html" itemprop="commentCount"></span></a></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">Words count in article&#58;</span> <span title="Words count in article">4,987 </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">Reading time &asymp;</span> <span title="Reading time">22</span></div></div></header><div class="post-body han-init-context" itemprop="articleBody"><script src="/assets/js/APlayer.min.js"></script><p><img src="https://img.i7years.com/blog/pexels-photo-38136.webp" alt="pexels-photo-38136"></p><blockquote><p>文章的主要思想和内容均来自 <a href="https://jeiwan.cc/posts/building-blockchain-in-go-part-6/" target="_blank" rel="noopener">https://jeiwan.cc/posts/building-blockchain-in-go-part-6/</a></p></blockquote><h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>在这一系列文章的最开始部分，我们提到过区块链是一个分布式的数据库。那时候，我们决定跳过”分布式”这一环节，并且聚焦于”数据存储”这一环节。到目前为止，我们几乎实现了区块链的所有组成部分。在本篇文章中，我们将会涉及一些在前面的文章中所忽略的一些机制，并且在下一篇文章中我们将开始研究区块链的分布式特性。</p><a id="more"></a><p>前面各个部分内容：</p><ol><li><a href="https://wangwei.one/posts/df195d9.html">基本原型</a></li><li><a href="https://wangwei.one/posts/7890ab7e.html">工作量证明</a></li><li><a href="https://wangwei.one/posts/35c768a3.html">持久化 &amp; 命令行</a></li><li><a href="https://wangwei.one/posts/9cf9e42a.html">交易（UTXO）</a></li><li><a href="https://wangwei.one/posts/f9088e0f.html">地址（钱包）</a></li></ol><h2 id="UTXO池"><a href="#UTXO池" class="headerlink" title="UTXO池"></a>UTXO池</h2><p>在 <a href="https://wangwei.one/posts/35c768a3.html">持久化 &amp; 命令行</a> 这篇文章中，我们研究了比特币核心存储区块的方式。当中我们提到过与区块相关的数据存储在 <strong>blocks</strong> 这个数据桶中，而交易数据则存储在 <strong>chainstate</strong> 这个数据桶中，让我们来回忆一下，<strong>chainstate</strong> 数据桶的数据结构：</p><ul><li><p>‘c’ + 32-byte transaction hash -&gt; unspent transaction output record for that transaction</p><blockquote><p>某笔交易的UTXO记录</p></blockquote></li></ul><ul><li><p>‘B’ -&gt; 32-byte block hash: the block hash up to which the database represents the unspent transaction outputs</p><blockquote><p>数据库所表示的UTXO的区块Hash</p></blockquote></li></ul><p>从那篇文章开始，我们已经实现了比特币的交易机制，但是我们还没有用到 <strong>chainstate</strong> 数据桶去存储我们的交易输出。所以，这将是我们现在要去做的事情。</p><p><strong>chainstate</strong> 不会去存储交易数据。相反，它存储的是 UTXO 集，也就是未被花费的交易输出集合。除此之外，它还存储了”数据库所表示的UTXO的区块Hash”，我们这里先暂且忽略这一点，因为我们还没有用到区块高度（这一点我们会在后面的文章进行实现）。</p><p>那么，我们为什么需要 UTXO 池呢？</p><p>一起来看一下我们前面实现的 <strong>findUnspentTransactions</strong> 方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 查找钱包地址对应的所有未花费的交易</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> pubKeyHash 钱包公钥Hash</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> Transaction[] findUnspentTransactions(<span class="keyword">byte</span>[] pubKeyHash) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">     Map&lt;String, <span class="keyword">int</span>[]&gt; allSpentTXOs = <span class="keyword">this</span>.getAllSpentTXOs(pubKeyHash);</span><br><span class="line">     Transaction[] unspentTxs = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 再次遍历所有区块中的交易输出</span></span><br><span class="line">     <span class="keyword">for</span> (BlockchainIterator blockchainIterator = <span class="keyword">this</span>.getBlockchainIterator(); blockchainIterator.hashNext(); ) &#123;</span><br><span class="line">         Block block = blockchainIterator.next();</span><br><span class="line">         <span class="keyword">for</span> (Transaction transaction : block.getTransactions()) &#123;</span><br><span class="line"></span><br><span class="line">             String txId = Hex.encodeHexString(transaction.getTxId());</span><br><span class="line"></span><br><span class="line">             <span class="keyword">int</span>[] spentOutIndexArray = allSpentTXOs.get(txId);</span><br><span class="line"></span><br><span class="line">             <span class="keyword">for</span> (<span class="keyword">int</span> outIndex = <span class="number">0</span>; outIndex &lt; transaction.getOutputs().length; outIndex++) &#123;</span><br><span class="line">                 <span class="keyword">if</span> (spentOutIndexArray != <span class="keyword">null</span> &amp;&amp; ArrayUtils.contains(spentOutIndexArray, outIndex)) &#123;</span><br><span class="line">                     <span class="keyword">continue</span>;</span><br><span class="line">                 &#125;</span><br><span class="line"></span><br><span class="line">                 <span class="comment">// 保存不存在 allSpentTXOs 中的交易</span></span><br><span class="line">                 <span class="keyword">if</span> (transaction.getOutputs()[outIndex].isLockedWithKey(pubKeyHash)) &#123;</span><br><span class="line">                     unspentTxs = ArrayUtils.add(unspentTxs, transaction);</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> unspentTxs;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>该方法是用来查找钱包地址对应的包含未花费交易输出的交易信息。由于交易信息是存储在区块当中，所以我们现有的做法是遍历区块链中的每个区块，然后遍历每个区块中的交易信息，再然后遍历每个交易中的交易输出，并检查交易输出是否被相应的钱包地址所锁定，效率非常低下。截止2018年3月29号，比特币中有 <a href="https://blockchain.info/zh-cn/block-height/515698" target="_blank" rel="noopener">515698</a> 个区块，并且这些数据占据了140+Gb 的磁盘空间。这也就意味着一个人必须运行全节点（下载所有的区块数据）才能验证交易信息。此外，验证交易信息需要遍历所有的区块。</p><p>针对这个问题的解决办法是需要有一个存储了所有UTXOs（未花费交易输出）的索引，这就是 UTXOs 池所要做的事情：UTXOs池其实是一个缓存空间，它所缓存的数据需要从构建区块链中所有的交易数据中获得（通过遍历所有的区块链，不过这个构建操作只需要执行一次即可），并且它后续还会用于钱包余额的计算以及新的交易数据的验证。截止到2017年9月，UTXOs池大约为 2.7Gb。</p><p>好了，让我们来想一下，为了实现 UTXOs 池我们需要做哪些事情。当前，有下列方法被用于查找交易信息：</p><ol><li><p><strong>Blockchain.getAllSpentTXOs</strong> —— 查询所有已被花费的交易输出。它需要遍历区块链中所有区块中交易信息。</p></li><li><p><strong>Blockchain.findUnspentTransactions</strong> —— 查询包含未被花费的交易输出的交易信息。它也需要遍历区块链中所有区块中交易信息。</p></li><li><p><strong>Blockchain.findSpendableOutputs</strong> —— 该方法用于新的交易创建之时。它需要找到足够多的交易输出，以满足所需支付的金额。需要调用 <strong>Blockchain.findUnspentTransactions</strong> 方法。</p></li><li><p><strong>Blockchain.findUTXO</strong> —— 查询钱包地址所对应的所有未花费交易输出，然后用于计算钱包余额。需要调用</p><p><strong>Blockchain.findUnspentTransactions</strong> 方法。</p></li><li><p><strong>Blockchain.findTransaction</strong> —— 通过交易ID查询交易信息。它需要遍历所有的区块直到找到交易信息为止。</p></li></ol><p>如你所见，上面这些方法都需要去遍历数据库中的所有区块。由于UTXOs池只存储未被花费的交易输出，而不会存储所有的交易信息，因此我们不会对有 <strong>Blockchain.findTransaction</strong> 进行优化。</p><p>那么，我们需要下列这些方法：</p><ol><li><strong>Blockchain.findUTXO</strong> —— 通过遍历所有的区块来找到所有未被花费的交易输出.</li><li><strong>UTXOSet.reindex</strong> —— 调用上面 <strong>findUTXO</strong> 方法，然后将查询结果存储在数据库中。也即需要进行缓存的地方。</li><li><strong>UTXOSet.findSpendableOutputs</strong> —— 与 <strong>Blockchain.findSpendableOutputs</strong> 类似，区别在于会使用 UTXO 池。</li><li><strong>UTXOSet.findUTXO</strong> —— 与<strong>Blockchain.findUTXO</strong> 类似，区别在于会使用 UTXO 池。</li><li><strong>Blockchain.findTransaction</strong> —— 逻辑保持不变。</li></ol><p>这样，两个使用最频繁的方法将从现在开始使用缓存！让我们开始编码吧！</p><p>定义 <strong>UTXOSet</strong>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UTXOSet</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Blockchain blockchain;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重建 UTXO 池索引:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UTXOSet</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">   ...</span><br><span class="line"> </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 重建 UTXO 池索引</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@Synchronized</span>   </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reIndex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"Start to reIndex UTXO set !"</span>);</span><br><span class="line">        RocksDBUtils.getInstance().cleanChainStateBucket();</span><br><span class="line">        Map&lt;String, TXOutput[]&gt; allUTXOs = blockchain.findAllUTXOs();</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, TXOutput[]&gt; entry : allUTXOs.entrySet()) &#123;</span><br><span class="line">            RocksDBUtils.getInstance().putUTXOs(entry.getKey(), entry.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">"ReIndex UTXO set finished ! "</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此方法用于初始化 UTXOSet。首先，需要清空 <code>chainstate</code> 数据桶，然后查询所有未被花费的交易输出，并将它们保存到 <code>chainstate</code> 数据桶中。</p><p>实现 <strong>findSpendableOutputs</strong> 方法，供 <strong>Transation.newUTXOTransaction</strong> 调用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UTXOSet</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">   ... </span><br><span class="line"> </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 寻找能够花费的交易</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pubKeyHash 钱包公钥Hash</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> amount     花费金额</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SpendableOutputResult <span class="title">findSpendableOutputs</span><span class="params">(<span class="keyword">byte</span>[] pubKeyHash, <span class="keyword">int</span> amount)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, <span class="keyword">int</span>[]&gt; unspentOuts = Maps.newHashMap();</span><br><span class="line">        <span class="keyword">int</span> accumulated = <span class="number">0</span>;</span><br><span class="line">        Map&lt;String, <span class="keyword">byte</span>[]&gt; chainstateBucket = RocksDBUtils.getInstance().getChainstateBucket();</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, <span class="keyword">byte</span>[]&gt; entry : chainstateBucket.entrySet()) &#123;</span><br><span class="line">            String txId = entry.getKey();</span><br><span class="line">            TXOutput[] txOutputs = (TXOutput[]) SerializeUtils.deserialize(entry.getValue());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> outId = <span class="number">0</span>; outId &lt; txOutputs.length; outId++) &#123;</span><br><span class="line">                TXOutput txOutput = txOutputs[outId];</span><br><span class="line">                <span class="keyword">if</span> (txOutput.isLockedWithKey(pubKeyHash) &amp;&amp; accumulated &lt; amount) &#123;</span><br><span class="line">                    accumulated += txOutput.getValue();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">int</span>[] outIds = unspentOuts.get(txId);</span><br><span class="line">                    <span class="keyword">if</span> (outIds == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        outIds = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;outId&#125;;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        outIds = ArrayUtils.add(outIds, outId);</span><br><span class="line">                    &#125;</span><br><span class="line">                    unspentOuts.put(txId, outIds);</span><br><span class="line">                    <span class="keyword">if</span> (accumulated &gt;= amount) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SpendableOutputResult(accumulated, unspentOuts);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实现 <strong>findUTXOs</strong> 接口，供 <strong>CLI.getBalance</strong> 调用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UTXOSet</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">   ... </span><br><span class="line"> </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查找钱包地址对应的所有UTXO</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pubKeyHash 钱包公钥Hash</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> TXOutput[] findUTXOs(<span class="keyword">byte</span>[] pubKeyHash) &#123;</span><br><span class="line">        TXOutput[] utxos = &#123;&#125;;</span><br><span class="line">        Map&lt;String, <span class="keyword">byte</span>[]&gt; chainstateBucket = RocksDBUtils.getInstance().getChainstateBucket();</span><br><span class="line">        <span class="keyword">if</span> (chainstateBucket.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> utxos;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">byte</span>[] value : chainstateBucket.values()) &#123;</span><br><span class="line">            TXOutput[] txOutputs = (TXOutput[]) SerializeUtils.deserialize(value);</span><br><span class="line">            <span class="keyword">for</span> (TXOutput txOutput : txOutputs) &#123;</span><br><span class="line">                <span class="keyword">if</span> (txOutput.isLockedWithKey(pubKeyHash)) &#123;</span><br><span class="line">                    utxos = ArrayUtils.add(utxos, txOutput);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> utxos;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以上这些方法都是先前 <strong>Blockchain</strong> 中相应方法的微调版，先前的方法将不再使用。</p><p>有了UTXO池之后，意味着我们的交易数据分开存储到了两个不同的数据桶中：交易数据存储到了 <strong>block</strong> 数据桶中，而UTXO存储到了 <strong>chainstate</strong> 数据桶中。这就需要一种同步机制来保证每当一个新的区块产生时，UTXO池能够及时同步最新区块中的交易数据，毕竟我们不想频地进行 <strong>reIndex</strong> 。因此，我们需要如下方法：</p><p>更新UTXO池：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UTXOSet</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">   ... </span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新UTXO池</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 当一个新的区块产生时，需要去做两件事情：</span></span><br><span class="line"><span class="comment">     * 1）从UTXO池中移除花费掉了的交易输出；</span></span><br><span class="line"><span class="comment">     * 2）保存新的未花费交易输出；</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tipBlock 最新的区块</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Synchronized</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Block tipBlock)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (tipBlock == <span class="keyword">null</span>) &#123;</span><br><span class="line">            log.error(<span class="string">"Fail to update UTXO set ! tipBlock is null !"</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Fail to update UTXO set ! "</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (Transaction transaction : tipBlock.getTransactions()) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 根据交易输入排查出剩余未被使用的交易输出</span></span><br><span class="line">            <span class="keyword">if</span> (!transaction.isCoinbase()) &#123;</span><br><span class="line">                <span class="keyword">for</span> (TXInput txInput : transaction.getInputs()) &#123;</span><br><span class="line">                    <span class="comment">// 余下未被使用的交易输出</span></span><br><span class="line">                    TXOutput[] remainderUTXOs = &#123;&#125;;</span><br><span class="line">                    String txId = Hex.encodeHexString(txInput.getTxId());</span><br><span class="line">                    TXOutput[] txOutputs = RocksDBUtils.getInstance().getUTXOs(txId);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (txOutputs == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> outIndex = <span class="number">0</span>; outIndex &lt; txOutputs.length; outIndex++) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (outIndex != txInput.getTxOutputIndex()) &#123;</span><br><span class="line">                            remainderUTXOs = ArrayUtils.add(remainderUTXOs, txOutputs[outIndex]);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 没有剩余则删除，否则更新</span></span><br><span class="line">                    <span class="keyword">if</span> (remainderUTXOs.length == <span class="number">0</span>) &#123;</span><br><span class="line">                        RocksDBUtils.getInstance().deleteUTXOs(txId);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        RocksDBUtils.getInstance().putUTXOs(txId, remainderUTXOs);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 新的交易输出保存到DB中</span></span><br><span class="line">            TXOutput[] txOutputs = transaction.getOutputs();</span><br><span class="line">            String txId = Hex.encodeHexString(transaction.getTxId());</span><br><span class="line">            RocksDBUtils.getInstance().putUTXOs(txId, txOutputs);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>让我们将 UTXOSet 用到它们所需之处去：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CLI</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   ...</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建区块链</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> address</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createBlockchain</span><span class="params">(String address)</span> </span>&#123;</span><br><span class="line">        Blockchain blockchain = Blockchain.createBlockchain(address);</span><br><span class="line">        UTXOSet utxoSet = <span class="keyword">new</span> UTXOSet(blockchain);</span><br><span class="line">        utxoSet.reIndex();</span><br><span class="line">        log.info(<span class="string">"Done ! "</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当创建一个新的区块链是，我们需要重建 UTXO 池索引。截止目前，这是唯一一处用到 <strong>reIndex</strong> 的地方，尽管看起有些多余，因为在区块链创建之初仅仅只有一个区块和一笔交易。</p><p>修改 <strong>CLI.send</strong> 接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CLI</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 转账</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> from</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> to</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> amount</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(String from, String to, <span class="keyword">int</span> amount)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        </span><br><span class="line">        ...</span><br><span class="line">        </span><br><span class="line">        Blockchain blockchain = Blockchain.createBlockchain(from);</span><br><span class="line">        Transaction transaction = Transaction.newUTXOTransaction(from, to, amount, blockchain);</span><br><span class="line">        Block newBlock = blockchain.mineBlock(<span class="keyword">new</span> Transaction[]&#123;transaction&#125;);</span><br><span class="line">        <span class="keyword">new</span> UTXOSet(blockchain).update(newBlock);</span><br><span class="line">		</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当一个新的区块产生后，需要去更新 UTXO 池数据。</p><p>让我们来检查一下它们的运行情况：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">$ ./blochchain.sh  createwallet</span><br><span class="line">wallet address : <span class="number">1</span>JgppX2xMshr35wHzvNWQBejUAZ3Te5Mdf</span><br><span class="line"></span><br><span class="line">$ ./blochchain.sh  createwallet</span><br><span class="line">wallet address : <span class="number">1</span>HX7bWwCjvxkjq65GUgAVRFfTZy6yKWkoG</span><br><span class="line"></span><br><span class="line">$ ./blochchain.sh  createwallet</span><br><span class="line">wallet address : <span class="number">1</span>L1RoFgyjCrNPCPHmSEBtNiV3h2wiF9mZV</span><br><span class="line"></span><br><span class="line">$ ./blochchain.sh  createblockchain -address <span class="number">1</span>JgppX2xMshr35wHzvNWQBejUAZ3Te5Mdf</span><br><span class="line"></span><br><span class="line">Elapsed Time: <span class="number">164.961</span> seconds </span><br><span class="line">correct hash Hex: <span class="number">00225493862611</span>bc517cb6b3610e99d26d98a6b52484c9fa745df6ceff93f445 </span><br><span class="line"></span><br><span class="line">Done ! </span><br><span class="line"></span><br><span class="line">$ ./blochchain.sh  getbalance -address <span class="number">1</span>JgppX2xMshr35wHzvNWQBejUAZ3Te5Mdf</span><br><span class="line">Balance of <span class="string">'1JgppX2xMshr35wHzvNWQBejUAZ3Te5Mdf'</span>: <span class="number">10</span></span><br><span class="line"></span><br><span class="line">$ ./blochchain.sh  send -from <span class="number">1</span>HX7bWwCjvxkjq65GUgAVRFfTZy6yKWkoG -to  <span class="number">1</span>JgppX2xMshr35wHzvNWQBejUAZ3Te5Mdf -amount <span class="number">5</span></span><br><span class="line">java.lang.Exception: ERROR: Not enough funds</span><br><span class="line"></span><br><span class="line">$ ./blochchain.sh  send -from <span class="number">1</span>JgppX2xMshr35wHzvNWQBejUAZ3Te5Mdf -to <span class="number">1</span>HX7bWwCjvxkjq65GUgAVRFfTZy6yKWkoG -amount <span class="number">2</span></span><br><span class="line">Elapsed Time: <span class="number">54.92</span> seconds </span><br><span class="line">correct hash Hex: <span class="number">0001</span>ab21f71ff2d6d532bf3b3388db790c2b03e28d7bd27bd669c5f6380a4e5b </span><br><span class="line"></span><br><span class="line">Success!</span><br><span class="line"></span><br><span class="line">$ ./blochchain.sh  send -from <span class="number">1</span>JgppX2xMshr35wHzvNWQBejUAZ3Te5Mdf -to <span class="number">1</span>L1RoFgyjCrNPCPHmSEBtNiV3h2wiF9mZV -amount <span class="number">2</span></span><br><span class="line">Elapsed Time: <span class="number">54.92</span> seconds </span><br><span class="line">correct hash Hex: <span class="number">0009</span>b925cc94e3db8bab2958b1fc2d1764aa15531e20756d92c3a93065c920f0 </span><br><span class="line"></span><br><span class="line">Success!</span><br><span class="line"></span><br><span class="line">$ ./blochchain.sh  getbalance -address <span class="number">1</span>JgppX2xMshr35wHzvNWQBejUAZ3Te5Mdf</span><br><span class="line">Balance of <span class="string">'1JgppX2xMshr35wHzvNWQBejUAZ3Te5Mdf'</span>: <span class="number">6</span></span><br><span class="line"></span><br><span class="line">$ ./blochchain.sh  getbalance -address <span class="number">1</span>HX7bWwCjvxkjq65GUgAVRFfTZy6yKWkoG</span><br><span class="line">Balance of <span class="string">'1HX7bWwCjvxkjq65GUgAVRFfTZy6yKWkoG'</span>: <span class="number">2</span></span><br><span class="line"></span><br><span class="line">$ ./blochchain.sh  getbalance -address <span class="number">1</span>L1RoFgyjCrNPCPHmSEBtNiV3h2wiF9mZV</span><br><span class="line">Balance of <span class="string">'1L1RoFgyjCrNPCPHmSEBtNiV3h2wiF9mZV'</span>: <span class="number">2</span></span><br></pre></td></tr></table></figure><h2 id="奖励机制"><a href="#奖励机制" class="headerlink" title="奖励机制"></a>奖励机制</h2><p>前面的章节中我们省略了矿工挖矿的奖励机制。时机已经成熟，该实现它了。</p><p>矿工奖励其实是一个 coinbase 交易（创币交易）。当一个矿工节点开始去生产一个新的区块时，他会从队列中取出一些交易数据，并且为它们预制一个 coinbase 交易。这笔 coinbase 交易中仅有的交易输出包含了矿工的公钥hash。</p><p>只需要更新 <strong>send</strong> 命令接口，我们就可以轻松实现矿工的奖励机制：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CLI</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 转账</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> from</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> to</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> amount</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(String from, String to, <span class="keyword">int</span> amount)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        </span><br><span class="line">        ...</span><br><span class="line">        </span><br><span class="line">        Blockchain blockchain = Blockchain.createBlockchain(from);</span><br><span class="line">        <span class="comment">// 新交易</span></span><br><span class="line">        Transaction transaction = Transaction.newUTXOTransaction(from, to, amount, blockchain);</span><br><span class="line">        <span class="comment">// 奖励</span></span><br><span class="line">        Transaction rewardTx = Transaction.newCoinbaseTX(from, <span class="string">""</span>);</span><br><span class="line">        Block newBlock = blockchain.mineBlock(<span class="keyword">new</span> Transaction[]&#123;transaction, rewardTx&#125;);</span><br><span class="line">        <span class="keyword">new</span> UTXOSet(blockchain).update(newBlock);</span><br><span class="line">		</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line"> 	   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>还需要修改交易验证方法，coinbase 交易直接验证通过：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Blockchain</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 交易签名验证</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tx</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">verifyTransactions</span><span class="params">(Transaction tx)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (tx.isCoinbase()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在我们的实现逻辑中，代币的发送也是区块的生产者，因此，奖励也归他所有。</p><p>让我们来验证一下奖励机制：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">$ ./blochchain.sh  createwallet </span><br><span class="line">wallet address : <span class="number">1</span>MpdtjTEsDvrkrLWmMswq4K3VPtevXXnUD</span><br><span class="line"></span><br><span class="line">$ ./blochchain.sh  createwallet </span><br><span class="line">wallet address : <span class="number">17</span>crpQoWy7TEkY9UPjZ3Qt9Fc2rWPUt8KX</span><br><span class="line"></span><br><span class="line">$ ./blochchain.sh  createwallet </span><br><span class="line">wallet address : <span class="number">12</span>L868QZW1ySYzf2oT5ha9py9M5JrSRhvT</span><br><span class="line"></span><br><span class="line">$ ./blochchain.sh  createblockchain -address <span class="number">1</span>MpdtjTEsDvrkrLWmMswq4K3VPtevXXnUD</span><br><span class="line"></span><br><span class="line">Elapsed Time: <span class="number">17.973</span> seconds</span><br><span class="line">correct hash Hex: <span class="number">0000</span>defe83a851a5db3803d5013bbc20c6234f176b2c52ae36fdb53d28b33d93 </span><br><span class="line"></span><br><span class="line">Done ! </span><br><span class="line"></span><br><span class="line">$ ./blochchain.sh  send -from <span class="number">1</span>MpdtjTEsDvrkrLWmMswq4K3VPtevXXnUD -to <span class="number">17</span>crpQoWy7TEkY9UPjZ3Qt9Fc2rWPUt8KX -amount <span class="number">6</span></span><br><span class="line">Elapsed Time: <span class="number">30.887</span> seconds</span><br><span class="line">correct hash Hex: <span class="number">00005</span>fd36a2609b43fd940577f93b8622e88e854f5ccfd70e113f763b6df69f7 </span><br><span class="line"></span><br><span class="line">Success!</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ ./blochchain.sh  send -from <span class="number">1</span>MpdtjTEsDvrkrLWmMswq4K3VPtevXXnUD -to <span class="number">12</span>L868QZW1ySYzf2oT5ha9py9M5JrSRhvT -amount <span class="number">3</span></span><br><span class="line">Elapsed Time: <span class="number">45.267</span> seconds</span><br><span class="line">correct hash Hex: <span class="number">00009</span>fd7c59b830b60ec21ade7672921d2fb0962a1b06a42c245450e47582a13 </span><br><span class="line"></span><br><span class="line">Success!</span><br><span class="line"></span><br><span class="line">$ ./blochchain.sh  getbalance -address <span class="number">1</span>MpdtjTEsDvrkrLWmMswq4K3VPtevXXnUD</span><br><span class="line">Balance of <span class="string">'1MpdtjTEsDvrkrLWmMswq4K3VPtevXXnUD'</span>: <span class="number">21</span></span><br><span class="line"></span><br><span class="line">$ ./blochchain.sh  getbalance -address <span class="number">17</span>crpQoWy7TEkY9UPjZ3Qt9Fc2rWPUt8KX</span><br><span class="line">Balance of <span class="string">'17crpQoWy7TEkY9UPjZ3Qt9Fc2rWPUt8KX'</span>: <span class="number">6</span></span><br><span class="line"></span><br><span class="line">$ ./blochchain.sh  getbalance -address <span class="number">12</span>L868QZW1ySYzf2oT5ha9py9M5JrSRhvT</span><br><span class="line">Balance of <span class="string">'12L868QZW1ySYzf2oT5ha9py9M5JrSRhvT'</span>: <span class="number">3</span></span><br></pre></td></tr></table></figure><p><strong>1MpdtjTEsDvrkrLWmMswq4K3VPtevXXnUD</strong> 这个地址一共收到了三份奖励：</p><ul><li><p>第一次是开采创世区块；</p></li><li><p>第二次是开采区块：00005fd36a2609b43fd940577f93b8622e88e854f5ccfd70e113f763b6df69f7</p></li><li><p>第三次是开采区块：00009fd7c59b830b60ec21ade7672921d2fb0962a1b06a42c245450e47582a13</p></li></ul><h2 id="Merkle-Tree"><a href="#Merkle-Tree" class="headerlink" title="Merkle Tree"></a>Merkle Tree</h2><p>Merkle Tree（默克尔树） 是这篇文章中我们需要重点讨论的一个机制。</p><p>正如我前面提到的那样，整个比特币的数据库占到了大约140G的磁盘空间。由于比特币的分布式特性，网络中的每一个节点必须是独立且自给自足的。每个比特币节点都是路由、区块链数据库、挖矿、钱包服务的功能集合。每个节点都参与全网络的路由功能，同时也可能包含其他功能。每个节点都参与验证并传播交易及区块信息，发现并维持与对等节点的连接。一个全节点（full node）包括以下四个功能：</p><p><img src="https://img.i7years.com/blog/full_node.png-zoom50" alt="full node"></p><p>随着越来越多的人开始使用比特币，这条规则开始变得越来越难以遵循：让每一个人都去运行一个完整的节点不太现实。在中本聪发布的 <a href="https://bitcoin.org/bitcoin.pdf" target="_blank" rel="noopener">比特币白皮书</a> 中，针对这个问题提出了一个解决方案：Simplified Payment Verification (SPV)（简易支付验证）。SPV是比特币的轻量级节点，它不需要下载所有的区块链数据，也<strong>不需要验证区块和交易数据</strong>。相反，当SPV想要验证一笔交易的有效性时，它会从它所连接的全节点上检索所需要的一些数据。这种机制保证了在只有一个全节点的情况，可以运行多个SPV轻钱包节点。</p><blockquote><p>更多有关SPV的介绍，请查看：<a href="https://github.com/bitcoinbook/bitcoinbook/blob/develop/ch08.asciidoc#simplified-payment-verification-spv-nodes" target="_blank" rel="noopener">《精通比特币（第二版）》第八章</a></p></blockquote><p>为了使SPV成为可能，就需要有一种方法在没有全量下载区块数据的情况下，来检查一个区块是否包含了某笔交易。这就是 <strong>Merkle Tree</strong> 发挥作用的地方了。</p><p>比特币中所使用的Merkle Tree是为了获得交易的Hash值，随后这个已经被Pow（工作量证明）系统认可了的Hash值会被保存到区块头中。到目前为止，我们只是简单地计算了一个区块中每笔交易的Hash值，然后在准备Pow数据时，再对这些交易进行 <strong>SHA-256</strong> 计算。虽然这是一个用于获取区块交易唯一表示的一个不错的方式，但是这种方式不具备 Merkle Tree 的优点。</p><blockquote><p>更多有关Merkle Tree的介绍，请查看：<a href="https://github.com/bitcoinbook/bitcoinbook/blob/develop/ch09.asciidoc#merkle-trees" target="_blank" rel="noopener">《精通比特币（第二版）》第九章</a></p></blockquote><p>来看一下Merkle Tree的结构：</p><p><img src="https://img.i7years.com/blog/merkle-tree-diagram.png" alt=""></p><p>每一个区块都会构建一个Merkle Tree，它从最底部的叶子节点开始往上构建，每一个交易的Hash就是一个叶子节点（比特币中用的双SHA256算法）。叶子节点的数量必须是偶数个，但是并不是每一个区块都能包含偶数笔交易数据。如果存在奇数笔交易数据，那么最后一笔交易数据将会被复制一份（这仅仅发生在Merkle Tree中，而不是区块中）。</p><p>从下往上移动，叶子节点成对分组，它们的Hash值被连接到一起，并且在此基础上再次计算出新的Hash值。新的Hash 形成新的树节点。这个过程不断地被重复，直到最后仅剩一个被称为根节点的树节点。这个根节点的Hash就是区块中交易数据们的唯一代表，它会被保存到区块头中，并被用于参与POW系统的计算。</p><p>Merkle树的好处是节点可以在不下载整个块的情况下验证某笔交易的合法性。 为此，只需要交易Hash，Merkle树根Hash和Merkle路径。</p><p>Merkle Tree代码实现如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> one.wangwei.blockchain.transaction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.common.collect.Lists;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> one.wangwei.blockchain.util.ByteUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.codec.digest.DigestUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 默克尔树</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wangwei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/04/15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MerkleTree</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根节点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Node root;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 叶子节点Hash</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[][] leafHashes;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MerkleTree</span><span class="params">(<span class="keyword">byte</span>[][] leafHashes)</span> </span>&#123;</span><br><span class="line">        constructTree(leafHashes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从底部叶子节点开始往上构建整个Merkle Tree</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> leafHashes</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">constructTree</span><span class="params">(<span class="keyword">byte</span>[][] leafHashes)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (leafHashes == <span class="keyword">null</span> || leafHashes.length &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"ERROR:Fail to construct merkle tree ! leafHashes data invalid ! "</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.leafHashes = leafHashes;</span><br><span class="line">        List&lt;Node&gt; parents = bottomLevel(leafHashes);</span><br><span class="line">        <span class="keyword">while</span> (parents.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            parents = internalLevel(parents);</span><br><span class="line">        &#125;</span><br><span class="line">        root = parents.get(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构建一个层级节点</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> children</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;Node&gt; <span class="title">internalLevel</span><span class="params">(List&lt;Node&gt; children)</span> </span>&#123;</span><br><span class="line">        List&lt;Node&gt; parents = Lists.newArrayListWithCapacity(children.size() / <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; children.size() - <span class="number">1</span>; i += <span class="number">2</span>) &#123;</span><br><span class="line">            Node child1 = children.get(i);</span><br><span class="line">            Node child2 = children.get(i + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            Node parent = constructInternalNode(child1, child2);</span><br><span class="line">            parents.add(parent);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 内部节点奇数个，只对left节点进行计算</span></span><br><span class="line">        <span class="keyword">if</span> (children.size() % <span class="number">2</span> != <span class="number">0</span>) &#123;</span><br><span class="line">            Node child = children.get(children.size() - <span class="number">1</span>);</span><br><span class="line">            Node parent = constructInternalNode(child, <span class="keyword">null</span>);</span><br><span class="line">            parents.add(parent);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> parents;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 底部节点构建</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> hashes</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;Node&gt; <span class="title">bottomLevel</span><span class="params">(<span class="keyword">byte</span>[][] hashes)</span> </span>&#123;</span><br><span class="line">        List&lt;Node&gt; parents = Lists.newArrayListWithCapacity(hashes.length / <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; hashes.length - <span class="number">1</span>; i += <span class="number">2</span>) &#123;</span><br><span class="line">            Node leaf1 = constructLeafNode(hashes[i]);</span><br><span class="line">            Node leaf2 = constructLeafNode(hashes[i + <span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">            Node parent = constructInternalNode(leaf1, leaf2);</span><br><span class="line">            parents.add(parent);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (hashes.length % <span class="number">2</span> != <span class="number">0</span>) &#123;</span><br><span class="line">            Node leaf = constructLeafNode(hashes[hashes.length - <span class="number">1</span>]);</span><br><span class="line">            <span class="comment">// 奇数个节点的情况，复制最后一个节点</span></span><br><span class="line">            Node parent = constructInternalNode(leaf, leaf);</span><br><span class="line">            parents.add(parent);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> parents;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构建叶子节点</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> hash</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Node <span class="title">constructLeafNode</span><span class="params">(<span class="keyword">byte</span>[] hash)</span> </span>&#123;</span><br><span class="line">        Node leaf = <span class="keyword">new</span> Node();</span><br><span class="line">        leaf.hash = hash;</span><br><span class="line">        <span class="keyword">return</span> leaf;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构建内部节点</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> leftChild</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rightChild</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Node <span class="title">constructInternalNode</span><span class="params">(Node leftChild, Node rightChild)</span> </span>&#123;</span><br><span class="line">        Node parent = <span class="keyword">new</span> Node();</span><br><span class="line">        <span class="keyword">if</span> (rightChild == <span class="keyword">null</span>) &#123;</span><br><span class="line">            parent.hash = leftChild.hash;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            parent.hash = internalHash(leftChild.hash, rightChild.hash);</span><br><span class="line">        &#125;</span><br><span class="line">        parent.left = leftChild;</span><br><span class="line">        parent.right = rightChild;</span><br><span class="line">        <span class="keyword">return</span> parent;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计算内部节点Hash</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> leftChildHash</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rightChildHash</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] internalHash(<span class="keyword">byte</span>[] leftChildHash, <span class="keyword">byte</span>[] rightChildHash) &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] mergedBytes = ByteUtils.merge(leftChildHash, rightChildHash);</span><br><span class="line">        <span class="keyword">return</span> DigestUtils.sha256(mergedBytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Merkle Tree节点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">byte</span>[] hash;</span><br><span class="line">        <span class="keyword">private</span> Node left;</span><br><span class="line">        <span class="keyword">private</span> Node right;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后修改 <strong>Block.hashTransaction</strong> 接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Block</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">   ... </span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对区块中的交易信息进行Hash计算</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] hashTransaction() &#123;</span><br><span class="line">        <span class="keyword">byte</span>[][] txIdArrays = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="keyword">this</span>.getTransactions().length][];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.getTransactions().length; i++) &#123;</span><br><span class="line">            txIdArrays[i] = <span class="keyword">this</span>.getTransactions()[i].hash();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MerkleTree(txIdArrays).getRoot().getHash();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>MerkleTree的根节点的Hash值，就是区块中交易信息的唯一代表。</p><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>这一节我们主要是对前面的交易机制做了进一步的优化，加入UTXO池和Merkle Tree机制。</p><p>下一讲，我们来介绍一下比特币的交易脚本相关的内容。</p><h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><ol><li>源码：<a href="https://github.com/wangweiX/blockchain-java/tree/part6-transaction2" target="_blank" rel="noopener">https://github.com/wangweiX/blockchain-java/tree/part6-transaction2</a></li><li><a href="https://github.com/bitcoinbook/bitcoinbook" target="_blank" rel="noopener">《精通比特币（第二版）》</a></li><li><a href="https://en.bitcoin.it/wiki/Bitcoin_Core_0.11_(ch_2" target="_blank" rel="noopener">The UTXO Set</a>:_Data_Storage#The_UTXO_set_.28chainstate_leveldb.29)</li><li><a href="https://statoshi.info/dashboard/db/unspent-transaction-output-set" target="_blank" rel="noopener">UTXO set statistics</a></li><li><a href="https://en.bitcoin.it/wiki/Protocol_documentation#Merkle_Trees" target="_blank" rel="noopener">Merkle Tree</a></li><li><a href="https://medium.com/@jonaldfyookball/why-every-bitcoin-user-should-understand-spv-security-520d1d45e0b9" target="_blank" rel="noopener">Why every Bitcoin user should understand “SPV security”</a></li><li><a href="https://en.bitcoin.it/wiki/Script" target="_blank" rel="noopener">Script</a></li><li><a href="https://github.com/sipa/bitcoin/commit/450cbb0944cd20a06ce806e6679a1f4c83c50db2" target="_blank" rel="noopener">“Ultraprune” Bitcoin Core commit</a></li><li><a href="https://medium.com/@maraoz/smart-contracts-and-bitcoin-a5d61011d9b1" target="_blank" rel="noopener">Smart contracts and Bitcoin</a></li></ol><p><img src="https://img.i7years.com/blog/blockchain_exploer.png" alt=""></p><blockquote><p><a href="https://press.one/file/v?s=26e600c30e75eaa13e96be514125b88979ee8ec589372b3f60eb5e3d6884f3e35992f70a44875916b4efc8d87f3021bbf4dea9c23253a8496120b75cc47a6cb30&amp;h=5da52a1d62de45729187a3eed46039f776095760c0848e670140ced8c3c0c32a&amp;a=23fe9bfd7ceef4b44c2ce44dcac8e4a49caf8026&amp;f=P1&amp;v=2" target="_blank" rel="noopener">https://press.one/file/v?s=26e600c30e75eaa13e96be514125b88979ee8ec589372b3f60eb5e3d6884f3e35992f70a44875916b4efc8d87f3021bbf4dea9c23253a8496120b75cc47a6cb30&amp;h=5da52a1d62de45729187a3eed46039f776095760c0848e670140ced8c3c0c32a&amp;a=23fe9bfd7ceef4b44c2ce44dcac8e4a49caf8026&amp;f=P1&amp;v=2</a></p></blockquote></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>请我喝半杯☕️</div><button id="rewardButton" disable="enable" onclick='var qr=document.getElementById("QR");"none"===qr.style.display?qr.style.display="block":qr.style.display="none"'><span>Donate</span></button><div id="QR" style="display:none"><div id="wechat" style="display:inline-block"><img id="wechat_qr" src="https://img.i7years.com/pay2Wechat.png" alt="Michael WeChat Pay"><p>WeChat Pay</p></div><div id="alipay" style="display:inline-block"><img id="alipay_qr" src="https://img.i7years.com/pay2Alipay.png" alt="Michael Alipay"><p>Alipay</p></div><div id="bitcoin" style="display:inline-block"><img id="bitcoin_qr" src="https://img.i7years.com/wallet/rec_bitcoin.png" alt="Michael Bitcoin"><p>Bitcoin</p></div></div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>Post author:</strong> Michael</li><li class="post-copyright-link"><strong>Post link:</strong> <a href="https://wangwei.one/posts/build-blockchain-in-java-transaction-merkle-tree.html" title="基于Java语言构建区块链（六）—— 交易（Merkle Tree）">https://wangwei.one/posts/build-blockchain-in-java-transaction-merkle-tree.html</a></li><li class="post-copyright-license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> unless stating additionally.</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/blockchain/" rel="tag"># blockchain</a> <a href="/tags/bitcoin/" rel="tag"># bitcoin</a> <a href="/tags/Merkle-Tree/" rel="tag"># Merkle Tree</a> <a href="/tags/UTXO/" rel="tag"># UTXO</a> <a href="/tags/SPV/" rel="tag"># SPV</a></div><div class="post-widgets"><div id="needsharebutton-postbottom"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/posts/build-blockchain-in-java-wallet-address.html" rel="next" title="基于Java语言构建区块链（五）—— 地址（钱包）"><i class="fa fa-chevron-left"></i> 基于Java语言构建区块链（五）—— 地址（钱包）</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/posts/build-blockchain-in-java-transaction-script.html" rel="prev" title="基于Java语言构建区块链（七）—— 交易脚本（智能合约）">基于Java语言构建区块链（七）—— 交易脚本（智能合约） <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div><div class="comments" id="comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">Table of Contents</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">Overview</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="https://img.i7years.com/avatar/naruto.jpg" alt="Michael"><p class="site-author-name" itemprop="name">Michael</p><p class="site-description motion-element" itemprop="description">分享自己所思所学所行</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives"><span class="site-state-item-count">75</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">4</span> <span class="site-state-item-name">categories</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">39</span> <span class="site-state-item-name">tags</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/wangweiX" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="https://leetcode.com/wangweix" target="_blank" title="LeetCode"><i class="fa fa-fw fa-laptop-code"></i>LeetCode</a> </span><span class="links-of-author-item"><a href="https://medium.com/@wangwei_hz" target="_blank" title="Medium"><i class="fa fa-fw fa-medium"></i>Medium</a> </span><span class="links-of-author-item"><a href="https://twitter.com/wangwei_hz" target="_blank" title="Twitter"><i class="fa fa-fw fa-twitter"></i>Twitter</a> </span><span class="links-of-author-item"><a href="http://weibo.com/wangweijava" target="_blank" title="Weibo"><i class="fa fa-fw fa-weibo"></i>Weibo</a> </span><span class="links-of-author-item"><a href="mailto:dzd5ZWFyc0BnbWFpbC5jb20NCg==" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://halfrost.com/" title="霜" target="_blank">霜</a></li><li class="links-of-blogroll-item"><a href="https://coolshell.cn/" title="酷壳" target="_blank">酷壳</a></li><li class="links-of-blogroll-item"><a href="https://jhuo.ca/" title="霍炬" target="_blank">霍炬</a></li><li class="links-of-blogroll-item"><a href="http://zhangwenli.com" title="羡辙" target="_blank">羡辙</a></li><li class="links-of-blogroll-item"><a href="http://www.ruanyifeng.com/" title="阮一峰" target="_blank">阮一峰</a></li><li class="links-of-blogroll-item"><a href="http://jspang.com/" title="技术胖" target="_blank">技术胖</a></li><li class="links-of-blogroll-item"><a href="https://daimajia.com/" title="代码家" target="_blank">代码家</a></li><li class="links-of-blogroll-item"><a href="https://tech.meituan.com/" title="美团点评" target="_blank">美团点评</a></li></ul></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#引言"><span class="nav-number">1.</span> <span class="nav-text">引言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UTXO池"><span class="nav-number">2.</span> <span class="nav-text">UTXO池</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#奖励机制"><span class="nav-number">3.</span> <span class="nav-text">奖励机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Merkle-Tree"><span class="nav-number">4.</span> <span class="nav-text">Merkle Tree</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#小结"><span class="nav-number">5.</span> <span class="nav-text">小结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#资料"><span class="nav-number">6.</span> <span class="nav-text">资料</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2015 &mdash; <span itemprop="copyrightYear">2019</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">Michael</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i> </span><span class="post-meta-item-text">Site words total count&#58;</span> <span title="Site words total count">158.0k</span></div><div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div><span class="post-meta-divider">|</span><div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script>var _mtac={};!function(){var t=document.createElement("script");t.src="https://pingjs.qq.com/h5/stats.js?v2.0.4",t.setAttribute("name","MTAH5"),t.setAttribute("sid","500547962");var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script><div style="display:none"><script src="//s95.cnzz.com/z_stat.php?id=1270083794&web_id=1270083794" language="JavaScript"></script></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div><div id="needsharebutton-float"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="https://static.i7years.com/blog/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="https://static.i7years.com/blog/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="https://static.i7years.com/blog/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="https://static.i7years.com/blog/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="https://static.i7years.com/blog/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="https://static.i7years.com/blog/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="https://static.i7years.com/blog/lib/canvas-nest/js/particles.min.js"></script><script type="text/javascript" src="https://static.i7years.com/blog/js/src/utils.js?v=5.1.3"></script><script type="text/javascript" src="https://static.i7years.com/blog/js/src/motion.js?v=5.1.3"></script><script type="text/javascript" src="https://static.i7years.com/blog/js/src/scrollspy.js?v=5.1.3"></script><script type="text/javascript" src="https://static.i7years.com/blog/js/src/post-details.js?v=5.1.3"></script><script type="text/javascript" src="https://static.i7years.com/blog/js/src/bootstrap.js?v=5.1.3"></script><script id="dsq-count-scr" src="https://techi7years.disqus.com/count.js" async></script><script type="text/javascript">var disqus_config=function(){this.page.url="https://wangwei.one/posts/build-blockchain-in-java-transaction-merkle-tree.html",this.page.identifier="posts/build-blockchain-in-java-transaction-merkle-tree.html",this.page.title="基于Java语言构建区块链（六）—— 交易（Merkle Tree）"},d=document,s=d.createElement("script");s.src="https://techi7years.disqus.com/embed.js",s.setAttribute("data-timestamp",""+ +new Date),(d.head||d.body).appendChild(s)</script><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script type="text/javascript">var isfetched=!1;var isXml=!0;var search_path="search.xml";if(search_path.length===0){search_path="search.xml"}else if(/json$/i.test(search_path)){isXml=!1}
    var path="/"+search_path;var onPopupClose=function(e){$('.popup').hide();$('#local-search-input').val('');$('.search-result-list').remove();$('#no-result').remove();$(".local-search-pop-overlay").remove();$('body').css('overflow','')}
    function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css('overflow','hidden');$('.search-popup-overlay').click(onPopupClose);$('.popup').toggle();var $localSearchInput=$('#local-search-input');$localSearchInput.attr("autocapitalize","none");$localSearchInput.attr("autocorrect","off");$localSearchInput.focus()}
    var searchFunc=function(path,search_id,content_id){'use strict';$("body").append('<div class="search-popup-overlay local-search-pop-overlay">'+'<div id="search-loading-icon">'+'<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>'+'</div>'+'</div>').css('overflow','hidden');$("#search-loading-icon").css('margin','20% auto 0 auto').css('text-align','center');$.ajax({url:path,dataType:isXml?"xml":"json",async:!0,success:function(res){isfetched=!0;$('.popup').detach().appendTo('.header-inner');var datas=isXml?$("entry",res).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():res;var input=document.getElementById(search_id);var resultContent=document.getElementById(content_id);var inputEventFunction=function(){var searchText=input.value.trim().toLowerCase();var keywords=searchText.split(/[\s\-]+/);if(keywords.length>1){keywords.push(searchText)}
    var resultItems=[];if(searchText.length>0){datas.forEach(function(data){var isMatch=!1;var hitCount=0;var searchTextCount=0;var title=data.title.trim();var titleInLowerCase=title.toLowerCase();var content=data.content.trim().replace(/<[^>]+>/g,"");var contentInLowerCase=content.toLowerCase();var articleUrl=decodeURIComponent(data.url);var indexOfTitle=[];var indexOfContent=[];if(title!=''){keywords.forEach(function(keyword){function getIndexByWord(word,text,caseSensitive){var wordLen=word.length;if(wordLen===0){return[]}
    var startPosition=0,position=[],index=[];if(!caseSensitive){text=text.toLowerCase();word=word.toLowerCase()}
    while((position=text.indexOf(word,startPosition))>-1){index.push({position:position,word:word});startPosition=position+wordLen}
    return index}
    indexOfTitle=indexOfTitle.concat(getIndexByWord(keyword,titleInLowerCase,!1));indexOfContent=indexOfContent.concat(getIndexByWord(keyword,contentInLowerCase,!1))});if(indexOfTitle.length>0||indexOfContent.length>0){isMatch=!0;hitCount=indexOfTitle.length+indexOfContent.length}}
    if(isMatch){[indexOfTitle,indexOfContent].forEach(function(index){index.sort(function(itemLeft,itemRight){if(itemRight.position!==itemLeft.position){return itemRight.position-itemLeft.position}else{return itemLeft.word.length-itemRight.word.length}})});function mergeIntoSlice(text,start,end,index){var item=index[index.length-1];var position=item.position;var word=item.word;var hits=[];var searchTextCountInSlice=0;while(position+word.length<=end&&index.length!=0){if(word===searchText){searchTextCountInSlice++}
    hits.push({position:position,length:word.length});var wordEnd=position+word.length;index.pop();while(index.length!=0){item=index[index.length-1];position=item.position;word=item.word;if(wordEnd>position){index.pop()}else{break}}}
    searchTextCount+=searchTextCountInSlice;return{hits:hits,start:start,end:end,searchTextCount:searchTextCountInSlice}}
    var slicesOfTitle=[];if(indexOfTitle.length!=0){slicesOfTitle.push(mergeIntoSlice(title,0,title.length,indexOfTitle))}
    var slicesOfContent=[];while(indexOfContent.length!=0){var item=indexOfContent[indexOfContent.length-1];var position=item.position;var word=item.word;var start=position-20;var end=position+80;if(start<0){start=0}
    if(end<position+word.length){end=position+word.length}
    if(end>content.length){end=content.length}
    slicesOfContent.push(mergeIntoSlice(content,start,end,indexOfContent))}
    slicesOfContent.sort(function(sliceLeft,sliceRight){if(sliceLeft.searchTextCount!==sliceRight.searchTextCount){return sliceRight.searchTextCount-sliceLeft.searchTextCount}else if(sliceLeft.hits.length!==sliceRight.hits.length){return sliceRight.hits.length-sliceLeft.hits.length}else{return sliceLeft.start-sliceRight.start}});var upperBound=parseInt('1');if(upperBound>=0){slicesOfContent=slicesOfContent.slice(0,upperBound)}
    function highlightKeyword(text,slice){var result='';var prevEnd=slice.start;slice.hits.forEach(function(hit){result+=text.substring(prevEnd,hit.position);var end=hit.position+hit.length;result+='<b class="search-keyword">'+text.substring(hit.position,end)+'</b>';prevEnd=end});result+=text.substring(prevEnd,slice.end);return result}
    var resultItem='';if(slicesOfTitle.length!=0){resultItem+="<li><a href='"+articleUrl+"' class='search-result-title'>"+highlightKeyword(title,slicesOfTitle[0])+"</a>"}else{resultItem+="<li><a href='"+articleUrl+"' class='search-result-title'>"+title+"</a>"}
    slicesOfContent.forEach(function(slice){resultItem+="<a href='"+articleUrl+"'>"+"<p class=\"search-result\">"+highlightKeyword(content,slice)+"...</p>"+"</a>"});resultItem+="</li>";resultItems.push({item:resultItem,searchTextCount:searchTextCount,hitCount:hitCount,id:resultItems.length})}})};if(keywords.length===1&&keywords[0]===""){resultContent.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>'}else if(resultItems.length===0){resultContent.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'}else{resultItems.sort(function(resultLeft,resultRight){if(resultLeft.searchTextCount!==resultRight.searchTextCount){return resultRight.searchTextCount-resultLeft.searchTextCount}else if(resultLeft.hitCount!==resultRight.hitCount){return resultRight.hitCount-resultLeft.hitCount}else{return resultRight.id-resultLeft.id}});var searchResultList='<ul class=\"search-result-list\">';resultItems.forEach(function(result){searchResultList+=result.item})
    searchResultList+="</ul>";resultContent.innerHTML=searchResultList}}
    if('auto'==='auto'){input.addEventListener('input',inputEventFunction)}else{$('.search-icon').click(inputEventFunction);input.addEventListener('keypress',function(event){if(event.keyCode===13){inputEventFunction()}})}
    $(".local-search-pop-overlay").remove();$('body').css('overflow','');proceedsearch()}})}
    $('.popup-trigger').click(function(e){e.stopPropagation();if(isfetched===!1){searchFunc(path,'local-search-input','local-search-result')}else{proceedsearch()}});$('.popup-btn-close').click(onPopupClose);$('.popup').click(function(e){e.stopPropagation()});$(document).on('keyup',function(event){var shouldDismissSearchPopup=event.which===27&&$('.search-popup').is(':visible');if(shouldDismissSearchPopup){onPopupClose()}})</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><link rel="stylesheet" href="https://static.i7years.com/blog/lib/needsharebutton/needsharebutton.min.css?v=1544067396031"><script type="text/javascript" src="https://static.i7years.com/blog/lib/needsharebutton/needsharebutton.min.js?v=1544067396031"></script><script>pbOptions={iconStyle:"default",boxForm:"horizontal",position:"topRight",networks:"Wechat,Weibo,QQZone,Twitter,Facebook,Linkedin,Evernote,Douban,Reddit,Mailto"},new needShareButton("#needsharebutton-postbottom",pbOptions),flOptions={iconStyle:"default",boxForm:"horizontal",position:"middleRight",networks:"Wechat,Weibo,QQZone,Twitter,Facebook,Linkedin,Evernote,Douban,Reddit,Mailto"},new needShareButton("#needsharebutton-float",flOptions)</script></body></html>